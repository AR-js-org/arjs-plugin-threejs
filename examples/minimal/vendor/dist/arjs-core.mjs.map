{"version":3,"file":"arjs-core.mjs","sources":["../src/core/ecs.js","../src/core/event-bus.js","../src/core/plugin-manager.js","../src/core/components.js","../src/core/engine.js","../src/systems/capture-system.js","../src/systems/frame-pump-system.js","../plugins/source/webcam.js","../plugins/source/video.js","../plugins/source/image.js","../plugins/profile/default-policy.js"],"sourcesContent":["/**\n * Minimal Entity-Component-System (ECS) implementation\n * Entities are simple numeric IDs\n * Components are data containers stored in Maps keyed by entity ID\n * Queries allow systems to iterate over entities with specific components\n */\n\nexport class ECS {\n  constructor() {\n    this.nextEntityId = 1;\n    this.entities = new Set();\n    this.components = new Map(); // Map<componentKey, Map<entityId, componentData>>\n    this.resources = new Map(); // Global singleton data\n  }\n\n  /**\n   * Create a new entity\n   * @returns {number} The entity ID\n   */\n  createEntity() {\n    const id = this.nextEntityId++;\n    this.entities.add(id);\n    return id;\n  }\n\n  /**\n   * Destroy an entity and all its components\n   * @param {number} entityId\n   */\n  destroyEntity(entityId) {\n    if (!this.entities.has(entityId)) return;\n\n    this.entities.delete(entityId);\n\n    // Remove all components for this entity\n    for (const componentMap of this.components.values()) {\n      componentMap.delete(entityId);\n    }\n  }\n\n  /**\n   * Add or update a component for an entity\n   * @param {number} entityId\n   * @param {string} componentKey\n   * @param {*} data\n   */\n  setComponent(entityId, componentKey, data) {\n    if (!this.entities.has(entityId)) {\n      throw new Error(`Entity ${entityId} does not exist`);\n    }\n\n    if (!this.components.has(componentKey)) {\n      this.components.set(componentKey, new Map());\n    }\n\n    this.components.get(componentKey).set(entityId, data);\n  }\n\n  /**\n   * Get a component for an entity\n   * @param {number} entityId\n   * @param {string} componentKey\n   * @returns {*} The component data or undefined\n   */\n  getComponent(entityId, componentKey) {\n    const componentMap = this.components.get(componentKey);\n    return componentMap ? componentMap.get(entityId) : undefined;\n  }\n\n  /**\n   * Check if an entity has a component\n   * @param {number} entityId\n   * @param {string} componentKey\n   * @returns {boolean}\n   */\n  hasComponent(entityId, componentKey) {\n    const componentMap = this.components.get(componentKey);\n    return componentMap ? componentMap.has(entityId) : false;\n  }\n\n  /**\n   * Remove a component from an entity\n   * @param {number} entityId\n   * @param {string} componentKey\n   */\n  removeComponent(entityId, componentKey) {\n    const componentMap = this.components.get(componentKey);\n    if (componentMap) {\n      componentMap.delete(entityId);\n    }\n  }\n\n  /**\n   * Set a global resource (singleton data)\n   * @param {string} resourceKey\n   * @param {*} data\n   */\n  setResource(resourceKey, data) {\n    this.resources.set(resourceKey, data);\n  }\n\n  /**\n   * Get a global resource\n   * @param {string} resourceKey\n   * @returns {*}\n   */\n  getResource(resourceKey) {\n    return this.resources.get(resourceKey);\n  }\n\n  /**\n   * Check if a resource exists\n   * @param {string} resourceKey\n   * @returns {boolean}\n   */\n  hasResource(resourceKey) {\n    return this.resources.has(resourceKey);\n  }\n\n  /**\n   * Remove a resource\n   * @param {string} resourceKey\n   */\n  removeResource(resourceKey) {\n    this.resources.delete(resourceKey);\n  }\n\n  /**\n   * Query entities that have all specified components\n   * @param {...string} componentKeys\n   * @returns {Array<number>} Array of entity IDs\n   */\n  query(...componentKeys) {\n    if (componentKeys.length === 0) {\n      return Array.from(this.entities);\n    }\n\n    const result = [];\n\n    for (const entityId of this.entities) {\n      let hasAll = true;\n      for (const key of componentKeys) {\n        if (!this.hasComponent(entityId, key)) {\n          hasAll = false;\n          break;\n        }\n      }\n      if (hasAll) {\n        result.push(entityId);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Get all components for a specific component key\n   * @param {string} componentKey\n   * @returns {Map<number, *>} Map of entity IDs to component data\n   */\n  getAllComponents(componentKey) {\n    return this.components.get(componentKey) || new Map();\n  }\n\n  /**\n   * Clear all entities and components\n   */\n  clear() {\n    this.entities.clear();\n    this.components.clear();\n    this.resources.clear();\n    this.nextEntityId = 1;\n  }\n}\n","/**\n * Lightweight publish-subscribe event bus\n * Allows components to communicate without tight coupling\n */\n\nexport class EventBus {\n  constructor() {\n    this.listeners = new Map(); // Map<eventType, Set<callback>>\n  }\n\n  /**\n   * Subscribe to an event\n   * @param {string} eventType\n   * @param {Function} callback\n   * @returns {Function} Unsubscribe function\n   */\n  on(eventType, callback) {\n    if (!this.listeners.has(eventType)) {\n      this.listeners.set(eventType, new Set());\n    }\n\n    this.listeners.get(eventType).add(callback);\n\n    // Return unsubscribe function\n    return () => this.off(eventType, callback);\n  }\n\n  /**\n   * Subscribe to an event once (auto-unsubscribe after first trigger)\n   * @param {string} eventType\n   * @param {Function} callback\n   * @returns {Function} Unsubscribe function\n   */\n  once(eventType, callback) {\n    const wrapper = (data) => {\n      this.off(eventType, wrapper);\n      callback(data);\n    };\n\n    return this.on(eventType, wrapper);\n  }\n\n  /**\n   * Unsubscribe from an event\n   * @param {string} eventType\n   * @param {Function} callback\n   */\n  off(eventType, callback) {\n    const callbacks = this.listeners.get(eventType);\n    if (callbacks) {\n      callbacks.delete(callback);\n      if (callbacks.size === 0) {\n        this.listeners.delete(eventType);\n      }\n    }\n  }\n\n  /**\n   * Emit an event to all subscribers\n   * @param {string} eventType\n   * @param {*} data\n   */\n  emit(eventType, data) {\n    const callbacks = this.listeners.get(eventType);\n    if (callbacks) {\n      // Create a copy to avoid issues if listeners modify the set during iteration\n      const callbacksCopy = Array.from(callbacks);\n      for (const callback of callbacksCopy) {\n        try {\n          callback(data);\n        } catch (error) {\n          console.error(`Error in event listener for ${eventType}:`, error);\n        }\n      }\n    }\n  }\n\n  /**\n   * Remove all listeners for a specific event type, or all listeners if no type specified\n   * @param {string} [eventType]\n   */\n  clear(eventType) {\n    if (eventType) {\n      this.listeners.delete(eventType);\n    } else {\n      this.listeners.clear();\n    }\n  }\n\n  /**\n   * Get the number of listeners for an event type\n   * @param {string} eventType\n   * @returns {number}\n   */\n  listenerCount(eventType) {\n    const callbacks = this.listeners.get(eventType);\n    return callbacks ? callbacks.size : 0;\n  }\n}\n","/**\n * Plugin Manager\n * Handles registration, enabling, and disabling of plugins\n * Plugins can hook into the engine lifecycle and provide functionality\n */\n\nexport class PluginManager {\n  constructor(eventBus) {\n    this.eventBus = eventBus;\n    this.plugins = new Map(); // Map<pluginId, pluginInstance>\n    this.enabledPlugins = new Set(); // Set of enabled plugin IDs\n  }\n\n  /**\n   * Register a plugin\n   * @param {string} pluginId - Unique identifier for the plugin\n   * @param {Object} plugin - Plugin instance\n   * @param {Function} [plugin.init] - Initialize plugin (called on enable)\n   * @param {Function} [plugin.dispose] - Cleanup plugin (called on disable)\n   * @param {Function} [plugin.update] - Called each frame if implemented\n   * @returns {boolean} Success\n   */\n  register(pluginId, plugin) {\n    if (this.plugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is already registered`);\n      return false;\n    }\n\n    // Validate plugin structure\n    if (typeof plugin !== 'object') {\n      console.error(`Plugin ${pluginId} must be an object`);\n      return false;\n    }\n\n    this.plugins.set(pluginId, plugin);\n\n    if (this.eventBus) {\n      this.eventBus.emit('plugin:registered', { pluginId, plugin });\n    }\n\n    return true;\n  }\n\n  /**\n   * Unregister a plugin\n   * @param {string} pluginId\n   * @returns {boolean} Success\n   */\n  unregister(pluginId) {\n    if (!this.plugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is not registered`);\n      return false;\n    }\n\n    // Disable if currently enabled\n    if (this.enabledPlugins.has(pluginId)) {\n      this.disable(pluginId);\n    }\n\n    this.plugins.delete(pluginId);\n    return true;\n  }\n\n  /**\n   * Enable a plugin\n   * @param {string} pluginId\n   * @param {Object} context - Engine context (ecs, eventBus, etc.)\n   * @returns {Promise<boolean>} Success\n   */\n  async enable(pluginId, context) {\n    if (!this.plugins.has(pluginId)) {\n      console.error(`Plugin ${pluginId} is not registered`);\n      return false;\n    }\n\n    if (this.enabledPlugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is already enabled`);\n      return false;\n    }\n\n    const plugin = this.plugins.get(pluginId);\n\n    try {\n      // Call plugin's init method if it exists\n      if (typeof plugin.init === 'function') {\n        await plugin.init(context);\n      }\n\n      this.enabledPlugins.add(pluginId);\n\n      if (this.eventBus) {\n        this.eventBus.emit('plugin:enabled', { pluginId, plugin });\n      }\n\n      return true;\n    } catch (error) {\n      console.error(`Failed to enable plugin ${pluginId}:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Disable a plugin\n   * @param {string} pluginId\n   * @returns {Promise<boolean>} Success\n   */\n  async disable(pluginId) {\n    if (!this.enabledPlugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is not enabled`);\n      return false;\n    }\n\n    const plugin = this.plugins.get(pluginId);\n\n    try {\n      // Call plugin's dispose method if it exists\n      if (typeof plugin.dispose === 'function') {\n        await plugin.dispose();\n      }\n\n      this.enabledPlugins.delete(pluginId);\n\n      if (this.eventBus) {\n        this.eventBus.emit('plugin:disabled', { pluginId, plugin });\n      }\n\n      return true;\n    } catch (error) {\n      console.error(`Failed to disable plugin ${pluginId}:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Get a plugin instance\n   * @param {string} pluginId\n   * @returns {Object|undefined}\n   */\n  getPlugin(pluginId) {\n    return this.plugins.get(pluginId);\n  }\n\n  /**\n   * Check if a plugin is registered\n   * @param {string} pluginId\n   * @returns {boolean}\n   */\n  isRegistered(pluginId) {\n    return this.plugins.has(pluginId);\n  }\n\n  /**\n   * Check if a plugin is enabled\n   * @param {string} pluginId\n   * @returns {boolean}\n   */\n  isEnabled(pluginId) {\n    return this.enabledPlugins.has(pluginId);\n  }\n\n  /**\n   * Get all registered plugin IDs\n   * @returns {Array<string>}\n   */\n  getRegisteredPlugins() {\n    return Array.from(this.plugins.keys());\n  }\n\n  /**\n   * Get all enabled plugin IDs\n   * @returns {Array<string>}\n   */\n  getEnabledPlugins() {\n    return Array.from(this.enabledPlugins);\n  }\n\n  /**\n   * Update all enabled plugins that have an update method\n   * @param {number} deltaTime - Time since last frame in milliseconds\n   * @param {Object} context - Engine context\n   */\n  update(deltaTime, context) {\n    for (const pluginId of this.enabledPlugins) {\n      const plugin = this.plugins.get(pluginId);\n      if (plugin && typeof plugin.update === 'function') {\n        try {\n          plugin.update(deltaTime, context);\n        } catch (error) {\n          console.error(`Error updating plugin ${pluginId}:`, error);\n        }\n      }\n    }\n  }\n\n  /**\n   * Disable all plugins and clear registry\n   */\n  async clear() {\n    // Disable all enabled plugins\n    const enabledPluginIds = Array.from(this.enabledPlugins);\n    for (const pluginId of enabledPluginIds) {\n      await this.disable(pluginId);\n    }\n\n    this.plugins.clear();\n    this.enabledPlugins.clear();\n  }\n}\n","/**\n * Shared component and resource keys\n * These are used to identify different types of data in the ECS\n */\n\n// Component Keys (entity-specific data)\nexport const COMPONENTS = {\n  // Marker or tracking target component\n  TRACKING_TARGET: 'TrackingTarget',\n\n  // Transform component (position, rotation, scale)\n  TRANSFORM: 'Transform',\n\n  // Visibility state\n  VISIBLE: 'Visible',\n};\n\n// Resource Keys (global singleton data)\nexport const RESOURCES = {\n  // Configuration for AR processing\n  PROCESSING_CONFIG: 'ProcessingConfig',\n\n  // Current state of capture (ready, error, etc.)\n  CAPTURE_STATE: 'CaptureState',\n\n  // Reference to the frame source (video element, image, etc.)\n  FRAME_SOURCE_REF: 'FrameSourceRef',\n\n  // Device profile (desktop-normal, phone-normal, etc.)\n  DEVICE_PROFILE: 'DeviceProfile',\n\n  // Enabled plugins\n  ENABLED_PLUGINS: 'EnabledPlugins',\n};\n\n// Event Types\nexport const EVENTS = {\n  // Capture lifecycle events\n  CAPTURE_INIT_START: 'capture:init:start',\n  CAPTURE_INIT_SUCCESS: 'capture:init:success',\n  CAPTURE_INIT_ERROR: 'capture:init:error',\n  CAPTURE_READY: 'capture:ready',\n  CAPTURE_DISPOSED: 'capture:disposed',\n\n  // Source lifecycle events\n  SOURCE_LOADED: 'source:loaded',\n  SOURCE_ERROR: 'source:error',\n  SOURCE_PLAYING: 'source:playing',\n  SOURCE_PAUSED: 'source:paused',\n\n  // Frame processing events\n  FRAME_PROCESSED: 'frame:processed',\n\n  // Engine lifecycle events\n  ENGINE_START: 'engine:start',\n  ENGINE_STOP: 'engine:stop',\n  ENGINE_UPDATE: 'engine:update',\n\n  // Plugin lifecycle events\n  PLUGIN_REGISTERED: 'plugin:registered',\n  PLUGIN_ENABLED: 'plugin:enabled',\n  PLUGIN_DISABLED: 'plugin:disabled',\n};\n\n// Capture States\nexport const CAPTURE_STATES = {\n  UNINITIALIZED: 'uninitialized',\n  INITIALIZING: 'initializing',\n  READY: 'ready',\n  ERROR: 'error',\n  DISPOSED: 'disposed',\n};\n\n// Source Types\nexport const SOURCE_TYPES = {\n  WEBCAM: 'webcam',\n  VIDEO: 'video',\n  IMAGE: 'image',\n};\n\n// Device Profiles (legacy presets; retained for backward compatibility)\nexport const DEVICE_PROFILES = {\n  DESKTOP_FAST: 'desktop-fast',\n  DESKTOP_NORMAL: 'desktop-normal',\n  PHONE_NORMAL: 'phone-normal',\n  PHONE_SLOW: 'phone-slow',\n};\n\n// New capability/quality-based tiers (preferred going forward)\nexport const QUALITY_TIERS = {\n  LOW: 'low',\n  MEDIUM: 'medium',\n  HIGH: 'high',\n  ULTRA: 'ultra',\n};\n","/**\n * AR.js Core Engine\n * Orchestrates ECS, event bus, plugin manager, and game loop\n */\n\nimport { ECS } from './ecs.js';\nimport { EventBus } from './event-bus.js';\nimport { PluginManager } from './plugin-manager.js';\nimport { EVENTS } from './components.js';\n// Keep Engine.REVISION aligned with the package version\n// Bundlers (Vite/Webpack) and Vitest support JSON imports by default.\nimport pkg from '../../package.json';\n\nexport class Engine {\n  // Library identity/versioning\n  static NAME = '@ar-js-org/ar.js-core';\n  static VERSION = pkg?.version || '0.0.0-dev';\n  // Back-compat friendly alias (similar to old Context.REVISION)\n  static REVISION = Engine.VERSION;\n\n  constructor() {\n    this.ecs = new ECS();\n    this.eventBus = new EventBus();\n    this.pluginManager = new PluginManager(this.eventBus);\n    this.systems = [];\n    this.isRunning = false;\n    this.lastFrameTime = 0;\n    this.animationFrameId = null;\n  }\n\n  /**\n   * Add a system to the engine\n   * Systems are functions that run each frame: (deltaTime, context) => void\n   * @param {Function} system - System function\n   */\n  addSystem(system) {\n    if (typeof system !== 'function') {\n      console.error('System must be a function');\n      return;\n    }\n    this.systems.push(system);\n  }\n\n  /**\n   * Remove a system from the engine\n   * @param {Function} system\n   */\n  removeSystem(system) {\n    const index = this.systems.indexOf(system);\n    if (index !== -1) {\n      this.systems.splice(index, 1);\n    }\n  }\n\n  /**\n   * Start the engine and game loop\n   */\n  start() {\n    if (this.isRunning) {\n      console.warn('Engine is already running');\n      return;\n    }\n\n    this.isRunning = true;\n    this.lastFrameTime = performance.now();\n\n    this.eventBus.emit(EVENTS.ENGINE_START, { engine: this });\n\n    // Start the game loop\n    this.animationFrameId = requestAnimationFrame(this.#gameLoop.bind(this));\n  }\n\n  /**\n   * Stop the engine and game loop\n   */\n  stop() {\n    if (!this.isRunning) {\n      return;\n    }\n\n    this.isRunning = false;\n\n    if (this.animationFrameId !== null) {\n      cancelAnimationFrame(this.animationFrameId);\n      this.animationFrameId = null;\n    }\n\n    this.eventBus.emit(EVENTS.ENGINE_STOP, { engine: this });\n  }\n\n  /**\n   * Game loop - runs each frame\n   * @private\n   */\n  #gameLoop(currentTime) {\n    if (!this.isRunning) return;\n\n    // Calculate delta time\n    const deltaTime = currentTime - this.lastFrameTime;\n    this.lastFrameTime = currentTime;\n\n    // Create context for systems and plugins\n    const context = {\n      ecs: this.ecs,\n      eventBus: this.eventBus,\n      pluginManager: this.pluginManager,\n      engine: this,\n    };\n\n    // Update all systems\n    for (const system of this.systems) {\n      try {\n        system(deltaTime, context);\n      } catch (error) {\n        console.error('Error in system:', error);\n      }\n    }\n\n    // Update all enabled plugins\n    this.pluginManager.update(deltaTime, context);\n\n    // Emit update event\n    this.eventBus.emit(EVENTS.ENGINE_UPDATE, { deltaTime, context });\n\n    // Schedule next frame\n    this.animationFrameId = requestAnimationFrame(this.#gameLoop.bind(this));\n  }\n\n  /**\n   * Run a single update manually (useful for testing or non-realtime scenarios)\n   * @param {number} [deltaTime=16.67] - Time delta in milliseconds\n   */\n  update(deltaTime = 16.67) {\n    const context = {\n      ecs: this.ecs,\n      eventBus: this.eventBus,\n      pluginManager: this.pluginManager,\n      engine: this,\n    };\n\n    for (const system of this.systems) {\n      try {\n        system(deltaTime, context);\n      } catch (error) {\n        console.error('Error in system:', error);\n      }\n    }\n\n    this.pluginManager.update(deltaTime, context);\n    this.eventBus.emit(EVENTS.ENGINE_UPDATE, { deltaTime, context });\n  }\n\n  /**\n   * Get the current context\n   * @returns {Object}\n   */\n  getContext() {\n    return {\n      ecs: this.ecs,\n      eventBus: this.eventBus,\n      pluginManager: this.pluginManager,\n      engine: this,\n    };\n  }\n\n  /**\n   * Dispose the engine and clean up resources\n   */\n  async dispose() {\n    this.stop();\n\n    // Disable all plugins\n    await this.pluginManager.clear();\n\n    // Clear all systems\n    this.systems = [];\n\n    // Clear ECS\n    this.ecs.clear();\n\n    // Clear event listeners\n    this.eventBus.clear();\n  }\n}\n","/**\n * Capture System\n * Initializes the chosen capture plugin, manages capture state,\n * and writes FrameSourceRef + CaptureState resources\n */\n\nimport { RESOURCES, EVENTS, CAPTURE_STATES, SOURCE_TYPES } from '../core/components.js';\n\nexport class CaptureSystem {\n  /**\n   * Initialize capture system with configuration\n   * @param {Object} config\n   * @param {string} config.sourceType - Type of source (webcam, video, image)\n   * @param {string} [config.sourceUrl] - URL for video/image sources\n   * @param {string} [config.deviceId] - Specific camera device ID\n   * @param {number} [config.sourceWidth] - Desired source width\n   * @param {number} [config.sourceHeight] - Desired source height\n   */\n  static async initialize(config, context) {\n    const { ecs, eventBus, pluginManager } = context;\n\n    // Set initial capture state\n    ecs.setResource(RESOURCES.CAPTURE_STATE, {\n      state: CAPTURE_STATES.INITIALIZING,\n      error: null,\n    });\n\n    eventBus.emit(EVENTS.CAPTURE_INIT_START, { config });\n\n    try {\n      // Determine which plugin to use based on source type\n      const sourceType = config.sourceType || SOURCE_TYPES.WEBCAM;\n      let pluginId;\n\n      switch (sourceType) {\n        case SOURCE_TYPES.WEBCAM:\n          pluginId = 'source:webcam';\n          break;\n        case SOURCE_TYPES.VIDEO:\n          pluginId = 'source:video';\n          break;\n        case SOURCE_TYPES.IMAGE:\n          pluginId = 'source:image';\n          break;\n        default:\n          throw new Error(`Unknown source type: ${sourceType}`);\n      }\n\n      // Check if the plugin is registered\n      if (!pluginManager.isRegistered(pluginId)) {\n        throw new Error(`Plugin ${pluginId} is not registered`);\n      }\n\n      // Enable the plugin if not already enabled\n      if (!pluginManager.isEnabled(pluginId)) {\n        const success = await pluginManager.enable(pluginId, context);\n        if (!success) {\n          throw new Error(`Failed to enable plugin ${pluginId}`);\n        }\n      }\n\n      // Get the plugin and call its capture method\n      const plugin = pluginManager.getPlugin(pluginId);\n      if (!plugin || typeof plugin.capture !== 'function') {\n        throw new Error(`Plugin ${pluginId} does not have a capture method`);\n      }\n\n      // Call the plugin's capture method\n      const frameSource = await plugin.capture(config, context);\n\n      // Store the frame source reference\n      ecs.setResource(RESOURCES.FRAME_SOURCE_REF, {\n        element: frameSource.element,\n        stream: frameSource.stream,\n        type: sourceType,\n        width: frameSource.width || config.sourceWidth || 640,\n        height: frameSource.height || config.sourceHeight || 480,\n      });\n\n      // Update capture state to ready\n      ecs.setResource(RESOURCES.CAPTURE_STATE, {\n        state: CAPTURE_STATES.READY,\n        error: null,\n      });\n\n      eventBus.emit(EVENTS.CAPTURE_INIT_SUCCESS, { frameSource });\n      eventBus.emit(EVENTS.CAPTURE_READY, { frameSource });\n\n      return frameSource;\n    } catch (error) {\n      console.error('Capture initialization failed:', error);\n\n      // Update capture state to error\n      ecs.setResource(RESOURCES.CAPTURE_STATE, {\n        state: CAPTURE_STATES.ERROR,\n        error: error.message || 'Unknown error',\n      });\n\n      eventBus.emit(EVENTS.CAPTURE_INIT_ERROR, { error });\n\n      throw error;\n    }\n  }\n\n  /**\n   * Dispose the capture system and clean up resources\n   */\n  static async dispose(context) {\n    const { ecs, eventBus, pluginManager } = context;\n\n    // Get the current frame source\n    const frameSourceRef = ecs.getResource(RESOURCES.FRAME_SOURCE_REF);\n\n    // Disable source plugins\n    const sourcePlugins = ['source:webcam', 'source:video', 'source:image'];\n    for (const pluginId of sourcePlugins) {\n      if (pluginManager.isEnabled(pluginId)) {\n        await pluginManager.disable(pluginId);\n      }\n    }\n\n    // Remove resources\n    ecs.removeResource(RESOURCES.FRAME_SOURCE_REF);\n    ecs.setResource(RESOURCES.CAPTURE_STATE, {\n      state: CAPTURE_STATES.DISPOSED,\n      error: null,\n    });\n\n    eventBus.emit(EVENTS.CAPTURE_DISPOSED, { frameSourceRef });\n  }\n\n  /**\n   * Get the current capture state\n   */\n  static getState(context) {\n    return context.ecs.getResource(RESOURCES.CAPTURE_STATE);\n  }\n\n  /**\n   * Get the current frame source\n   */\n  static getFrameSource(context) {\n    return context.ecs.getResource(RESOURCES.FRAME_SOURCE_REF);\n  }\n}\n","/**\n * FramePumpSystem\n * Emits engine:update with ImageBitmap frames from the active video source.\n * - Prefers HTMLVideoElement.requestVideoFrameCallback when available\n * - Falls back to requestAnimationFrame\n * - Uses createImageBitmap(video) when possible (fast path)\n * - Falls back to drawing to a canvas and createImageBitmap(canvas)\n */\nimport { RESOURCES } from '../core/components.js';\n\nexport class FramePumpSystem {\n  static start(context) {\n    if (!context) throw new Error('FramePumpSystem.start requires a context');\n    const bus = context.eventBus;\n    const ref = context.ecs.getResource(RESOURCES.FRAME_SOURCE_REF);\n\n    if (!ref?.element) {\n      console.warn(\n        '[FramePumpSystem] No frame source element found; did you call CaptureSystem.initialize?',\n      );\n      return false;\n    }\n    const video = ref.element;\n    if (String(video.tagName).toUpperCase() !== 'VIDEO') {\n      console.warn('[FramePumpSystem] Frame source is not a <video> element; skipping frame pump.');\n      return false;\n    }\n\n    // Keep state on context to allow stop()\n    context.__framePump = context.__framePump || {};\n    const state = context.__framePump;\n    if (state.running) return true;\n    state.running = true;\n    state._fid = 0;\n    state._raf = 0;\n    state._rvfc = 0;\n\n    // Optional canvas fallback\n    let offscreen = null;\n    let ctx2d = null;\n\n    function ensureCanvas(w, h) {\n      if (offscreen && offscreen.width === w && offscreen.height === h) return;\n      try {\n        if (typeof globalThis.OffscreenCanvas !== 'undefined') {\n          offscreen = new globalThis.OffscreenCanvas(w, h);\n          ctx2d = offscreen.getContext('2d', { willReadFrequently: true });\n        } else {\n          const c = globalThis.document?.createElement?.('canvas');\n          if (!c) {\n            offscreen = null;\n            ctx2d = null;\n            return;\n          }\n          c.width = w;\n          c.height = h;\n          c.style.display = 'none';\n          try {\n            globalThis.document?.body?.appendChild?.(c);\n          } catch {}\n          offscreen = c;\n          ctx2d = c.getContext('2d', { willReadFrequently: true });\n        }\n      } catch {\n        offscreen = null;\n        ctx2d = null;\n      }\n    }\n\n    async function emitFrame() {\n      const w = video.videoWidth || ref.width || 640;\n      const h = video.videoHeight || ref.height || 480;\n      if (!w || !h) return;\n\n      // Fast path: ImageBitmap directly from video\n      try {\n        if (typeof globalThis.createImageBitmap === 'function') {\n          const imageBitmap = await globalThis.createImageBitmap(video);\n          bus.emit('engine:update', { id: ++state._fid, imageBitmap, width: w, height: h });\n          return;\n        }\n      } catch {\n        // fall through to canvas path\n      }\n\n      // Canvas fallback\n      try {\n        ensureCanvas(w, h);\n        if (!offscreen || !ctx2d) return;\n\n        ctx2d.clearRect(0, 0, w, h);\n        ctx2d.drawImage(video, 0, 0, w, h);\n\n        if (typeof globalThis.createImageBitmap === 'function') {\n          const imageBitmap = await globalThis.createImageBitmap(offscreen);\n          bus.emit('engine:update', { id: ++state._fid, imageBitmap, width: w, height: h });\n        } else {\n          // As a last resort, emit without ImageBitmap (worker will try a slower fallback)\n          bus.emit('engine:update', { id: ++state._fid, width: w, height: h });\n        }\n      } catch {\n        // ignore transient failures\n      }\n    }\n\n    // Use requestVideoFrameCallback when available\n    if (typeof video.requestVideoFrameCallback === 'function') {\n      const step = async () => {\n        if (!state.running) return;\n        await emitFrame();\n        state._rvfc = video.requestVideoFrameCallback(step);\n      };\n      state._rvfc = video.requestVideoFrameCallback(step);\n    } else {\n      const raf = globalThis.requestAnimationFrame || ((fn) => setTimeout(fn, 16));\n      const loop = async () => {\n        if (!state.running) return;\n        await emitFrame();\n        state._raf = raf(loop);\n      };\n      state._raf = raf(loop);\n    }\n\n    return true;\n  }\n\n  static stop(context) {\n    const state = context?.__framePump;\n    const ref = context?.ecs?.getResource?.(RESOURCES.FRAME_SOURCE_REF);\n    const video = ref?.element;\n    if (!state || !state.running) return;\n\n    state.running = false;\n\n    // Cancel RVFC via the video element\n    if (video && typeof video.cancelVideoFrameCallback === 'function' && state._rvfc) {\n      try {\n        video.cancelVideoFrameCallback(state._rvfc);\n      } catch {}\n    }\n\n    // Cancel RAF/timeout\n    const caf =\n      globalThis.cancelAnimationFrame ||\n      ((id) => {\n        try {\n          clearTimeout(id);\n        } catch {}\n      });\n    if (state._raf) {\n      try {\n        caf(state._raf);\n      } catch {}\n    }\n\n    context.__framePump = undefined;\n  }\n}\n","/**\n * Webcam Source Plugin\n * Provides getUserMedia-based video capture from webcam\n * Emits source lifecycle events and provides HTMLVideoElement + MediaStream\n */\n\nimport { EVENTS } from '../../src/core/components.js';\n\nexport const webcamPlugin = {\n  id: 'source:webcam',\n  name: 'Webcam Source',\n  type: 'source',\n\n  // Internal state\n  _videoElement: null,\n  _stream: null,\n  _context: null,\n\n  /**\n   * Initialize the plugin\n   */\n  async init(context) {\n    this._context = context;\n  },\n\n  /**\n   * Capture video from webcam\n   * @param {Object} config\n   * @param {string} [config.deviceId] - Specific camera device ID\n   * @param {number} [config.sourceWidth] - Desired video width\n   * @param {number} [config.sourceHeight] - Desired video height\n   * @param {number} [config.displayWidth] - Display width\n   * @param {number} [config.displayHeight] - Display height\n   * @param {Object} context - Engine context\n   * @returns {Promise<Object>} Frame source with element and stream\n   */\n  async capture(config, context) {\n    const { eventBus } = context;\n\n    // Check if MediaDevices API is available\n    if (\n      !globalThis.navigator?.mediaDevices ||\n      !globalThis.navigator.mediaDevices.getUserMedia ||\n      !globalThis.navigator.mediaDevices.enumerateDevices\n    ) {\n      const error = new Error('MediaDevices API not available in this browser');\n      eventBus.emit(EVENTS.SOURCE_ERROR, { error, source: 'webcam' });\n      throw error;\n    }\n\n    try {\n      // Create video element\n      const videoElement =\n        globalThis.document?.createElement?.('video') ||\n        Object.assign(\n          {},\n          {\n            setAttribute() {},\n            style: {},\n            play: async () => {},\n          },\n        );\n      videoElement.setAttribute?.('autoplay', '');\n      videoElement.setAttribute?.('muted', '');\n      videoElement.setAttribute?.('playsinline', '');\n      videoElement.setAttribute?.('id', 'arjs-video');\n\n      // Set display size\n      const displayWidth = config.displayWidth || 640;\n      const displayHeight = config.displayHeight || 480;\n      if (videoElement.style) {\n        videoElement.style.width = displayWidth + 'px';\n        videoElement.style.height = displayHeight + 'px';\n        videoElement.style.position = 'absolute';\n        videoElement.style.top = '0px';\n        videoElement.style.left = '0px';\n        videoElement.style.zIndex = '-2';\n      }\n\n      // Build getUserMedia constraints\n      const constraints = {\n        audio: false,\n        video: {\n          facingMode: 'environment',\n          width: { ideal: config.sourceWidth || 640 },\n          height: { ideal: config.sourceHeight || 480 },\n        },\n      };\n\n      // Add device ID if specified\n      if (config.deviceId) {\n        constraints.video.deviceId = { exact: config.deviceId };\n      }\n\n      // Get media stream\n      const stream = await globalThis.navigator.mediaDevices.getUserMedia(constraints);\n\n      // Set video source\n      videoElement.srcObject = stream;\n\n      // Store references\n      this._videoElement = videoElement;\n      this._stream = stream;\n\n      // Wait for video to be ready\n      await new Promise((resolve, reject) => {\n        videoElement.onloadedmetadata = () => {\n          videoElement\n            .play?.()\n            .then(() => {\n              // Append to document (best-effort)\n              try {\n                globalThis.document?.body?.appendChild?.(videoElement);\n              } catch {}\n\n              // Dispatch custom event for backward compatibility\n              try {\n                globalThis.window?.dispatchEvent?.(\n                  new globalThis.CustomEvent('camera-init', {\n                    detail: { stream },\n                  }),\n                );\n                globalThis.window?.dispatchEvent?.(\n                  new globalThis.CustomEvent('arjs-video-loaded', {\n                    detail: { component: videoElement },\n                  }),\n                );\n              } catch {}\n\n              // Emit source events\n              eventBus.emit(EVENTS.SOURCE_LOADED, {\n                element: videoElement,\n                stream,\n                source: 'webcam',\n              });\n              eventBus.emit(EVENTS.SOURCE_PLAYING, {\n                element: videoElement,\n                source: 'webcam',\n              });\n\n              resolve();\n            })\n            .catch(reject);\n        };\n\n        videoElement.onerror = reject;\n      });\n\n      // Get actual video dimensions\n      const actualWidth = videoElement.videoWidth || config.sourceWidth || 640;\n      const actualHeight = videoElement.videoHeight || config.sourceHeight || 480;\n\n      return {\n        element: videoElement,\n        stream: stream,\n        width: actualWidth,\n        height: actualHeight,\n        type: 'webcam',\n      };\n    } catch (error) {\n      // Emit error event\n      context?.eventBus?.emit?.(EVENTS.SOURCE_ERROR, {\n        error,\n        source: 'webcam',\n        message: error.message,\n      });\n\n      // Dispatch custom event for backward compatibility\n      try {\n        globalThis.window?.dispatchEvent?.(\n          new globalThis.CustomEvent('camera-error', { detail: { error } }),\n        );\n      } catch {}\n\n      throw error;\n    }\n  },\n\n  /**\n   * Dispose the plugin and clean up resources\n   */\n  async dispose() {\n    if (this._stream) {\n      try {\n        this._stream.getTracks?.().forEach((track) => track.stop?.());\n      } catch {}\n      this._stream = null;\n    }\n\n    if (this._videoElement) {\n      try {\n        if (this._videoElement.parentNode?.removeChild) {\n          this._videoElement.parentNode.removeChild(this._videoElement);\n        }\n        this._videoElement.srcObject = null;\n      } catch {}\n      this._videoElement = null;\n    }\n\n    if (this._context?.eventBus) {\n      this._context.eventBus.emit(EVENTS.CAPTURE_DISPOSED, {\n        source: 'webcam',\n      });\n    }\n  },\n\n  /**\n   * Check if mobile torch is available\n   * @returns {boolean}\n   */\n  hasMobileTorch() {\n    if (!this._stream) return false;\n\n    // Guard against environments where MediaStream is undefined\n    const hasCtor = typeof globalThis.MediaStream === 'function';\n    if (!hasCtor) {\n      // Fallback: duck-type for getVideoTracks availability\n      const vt = this._stream?.getVideoTracks?.();\n      return Array.isArray(vt) && vt[0]?.getCapabilities ? !!vt[0].getCapabilities().torch : false;\n    }\n\n    const videoTrack = this._stream.getVideoTracks?.()[0];\n    if (!videoTrack || !videoTrack.getCapabilities) {\n      return false;\n    }\n    const capabilities = videoTrack.getCapabilities();\n    return !!capabilities.torch;\n  },\n\n  /**\n   * Toggle mobile torch on/off\n   * @param {boolean} [enabled] - Force enable/disable, or toggle if not provided\n   * @returns {Promise<boolean>} New torch state\n   */\n  async toggleMobileTorch(enabled) {\n    // Only proceed if torch is available\n    if (!this.hasMobileTorch()) {\n      console.warn?.('Mobile torch is not available on this device');\n      return false;\n    }\n\n    const videoTrack = this._stream.getVideoTracks()[0];\n    const currentState = this._torchEnabled || false;\n    const newState = enabled !== undefined ? enabled : !currentState;\n\n    try {\n      await videoTrack.applyConstraints?.({\n        advanced: [{ torch: newState }],\n      });\n      this._torchEnabled = newState;\n      return newState;\n    } catch (error) {\n      console.error?.('Failed to toggle torch:', error);\n      return currentState;\n    }\n  },\n};\n","/**\n * Video Source Plugin\n * Provides video playback from local or remote video files\n * Emits source lifecycle events and provides HTMLVideoElement\n */\n\nimport { EVENTS } from '../../src/core/components.js';\n\nexport const videoPlugin = {\n  id: 'source:video',\n  name: 'Video Source',\n  type: 'source',\n\n  // Internal state\n  _videoElement: null,\n  _context: null,\n\n  /**\n   * Initialize the plugin\n   */\n  async init(context) {\n    this._context = context;\n  },\n\n  /**\n   * Capture video from a file or URL\n   * @param {Object} config\n   * @param {string} config.sourceUrl - URL or path to video file\n   * @param {number} [config.sourceWidth] - Desired video width\n   * @param {number} [config.sourceHeight] - Desired video height\n   * @param {number} [config.displayWidth] - Display width\n   * @param {number} [config.displayHeight] - Display height\n   * @param {boolean} [config.loop] - Whether to loop the video\n   * @param {boolean} [config.muted] - Whether to mute the video\n   * @param {Object} context - Engine context\n   * @returns {Promise<Object>} Frame source with element\n   */\n  async capture(config, context) {\n    const { eventBus } = context;\n\n    if (!config.sourceUrl) {\n      const error = new Error('sourceUrl is required for video source');\n      eventBus.emit(EVENTS.SOURCE_ERROR, { error, source: 'video' });\n      throw error;\n    }\n\n    try {\n      // Create video element\n      const videoElement = document.createElement('video');\n      videoElement.src = config.sourceUrl;\n      videoElement.setAttribute('id', 'arjs-video');\n\n      // Set video attributes\n      videoElement.autoplay = true;\n      videoElement.setAttribute('playsinline', '');\n      videoElement.controls = false;\n      videoElement.loop = config.loop !== false; // Default to true\n      videoElement.muted = config.muted !== false; // Default to true\n\n      // Set display size\n      const displayWidth = config.displayWidth || 640;\n      const displayHeight = config.displayHeight || 480;\n      videoElement.style.width = displayWidth + 'px';\n      videoElement.style.height = displayHeight + 'px';\n      videoElement.style.position = 'absolute';\n      videoElement.style.top = '0px';\n      videoElement.style.left = '0px';\n      videoElement.style.zIndex = '-2';\n      videoElement.style.objectFit = 'initial';\n\n      // Set internal dimensions\n      if (config.sourceWidth) {\n        videoElement.width = config.sourceWidth;\n      }\n      if (config.sourceHeight) {\n        videoElement.height = config.sourceHeight;\n      }\n\n      // Store reference\n      this._videoElement = videoElement;\n\n      // Wait for video to load\n      await new Promise((resolve, reject) => {\n        videoElement.onloadeddata = () => {\n          // Append to document\n          document.body.appendChild(videoElement);\n\n          // Start playback (may require user interaction on some browsers)\n          videoElement\n            .play()\n            .then(() => {\n              // Dispatch custom event for backward compatibility\n              window.dispatchEvent(\n                new CustomEvent('arjs-video-loaded', {\n                  detail: { component: videoElement },\n                }),\n              );\n\n              // Emit source events\n              eventBus.emit(EVENTS.SOURCE_LOADED, {\n                element: videoElement,\n                source: 'video',\n              });\n              eventBus.emit(EVENTS.SOURCE_PLAYING, {\n                element: videoElement,\n                source: 'video',\n              });\n\n              resolve();\n            })\n            .catch((playError) => {\n              // If autoplay fails, set up click handler\n              console.warn('Autoplay failed, waiting for user interaction');\n\n              const clickHandler = () => {\n                videoElement.play().then(() => {\n                  eventBus.emit(EVENTS.SOURCE_PLAYING, {\n                    element: videoElement,\n                    source: 'video',\n                  });\n                });\n                document.body.removeEventListener('click', clickHandler);\n              };\n\n              document.body.addEventListener('click', clickHandler, {\n                once: true,\n              });\n\n              resolve(); // Resolve anyway, video is loaded\n            });\n        };\n\n        videoElement.onerror = (error) => {\n          reject(new Error(`Failed to load video: ${error.message || 'Unknown error'}`));\n        };\n      });\n\n      // Get actual video dimensions\n      const actualWidth = videoElement.videoWidth || config.sourceWidth || 640;\n      const actualHeight = videoElement.videoHeight || config.sourceHeight || 480;\n\n      return {\n        element: videoElement,\n        width: actualWidth,\n        height: actualHeight,\n        type: 'video',\n      };\n    } catch (error) {\n      console.error('Video capture failed:', error);\n\n      // Emit error event\n      eventBus.emit(EVENTS.SOURCE_ERROR, {\n        error,\n        source: 'video',\n        message: error.message,\n      });\n\n      throw error;\n    }\n  },\n\n  /**\n   * Dispose the plugin and clean up resources\n   */\n  async dispose() {\n    if (this._videoElement) {\n      // Pause and clean up\n      this._videoElement.pause();\n      this._videoElement.removeAttribute('src');\n      this._videoElement.load();\n\n      // Remove from DOM\n      if (this._videoElement.parentNode) {\n        this._videoElement.parentNode.removeChild(this._videoElement);\n      }\n\n      this._videoElement = null;\n    }\n\n    if (this._context && this._context.eventBus) {\n      this._context.eventBus.emit(EVENTS.CAPTURE_DISPOSED, {\n        source: 'video',\n      });\n    }\n  },\n};\n","/**\n * Image Source Plugin\n * Provides static image loading from local or remote image files\n * Emits source lifecycle events and provides HTMLImageElement\n */\n\nimport { EVENTS } from '../../src/core/components.js';\n\nexport const imagePlugin = {\n  id: 'source:image',\n  name: 'Image Source',\n  type: 'source',\n\n  // Internal state\n  _imageElement: null,\n  _context: null,\n\n  /**\n   * Initialize the plugin\n   */\n  async init(context) {\n    this._context = context;\n  },\n\n  /**\n   * Load an image from a file or URL\n   * @param {Object} config\n   * @param {string} config.sourceUrl - URL or path to image file\n   * @param {number} [config.sourceWidth] - Desired image width\n   * @param {number} [config.sourceHeight] - Desired image height\n   * @param {number} [config.displayWidth] - Display width\n   * @param {number} [config.displayHeight] - Display height\n   * @param {Object} context - Engine context\n   * @returns {Promise<Object>} Frame source with element\n   */\n  async capture(config, context) {\n    const { eventBus } = context;\n\n    if (!config.sourceUrl) {\n      const error = new Error('sourceUrl is required for image source');\n      eventBus.emit(EVENTS.SOURCE_ERROR, { error, source: 'image' });\n      throw error;\n    }\n\n    try {\n      // Create image element\n      const imageElement = document.createElement('img');\n      imageElement.src = config.sourceUrl;\n      imageElement.setAttribute('id', 'arjs-video');\n\n      // Set display size\n      const displayWidth = config.displayWidth || 640;\n      const displayHeight = config.displayHeight || 480;\n      imageElement.style.width = displayWidth + 'px';\n      imageElement.style.height = displayHeight + 'px';\n      imageElement.style.position = 'absolute';\n      imageElement.style.top = '0px';\n      imageElement.style.left = '0px';\n      imageElement.style.zIndex = '-2';\n\n      // Set internal dimensions if specified\n      if (config.sourceWidth) {\n        imageElement.width = config.sourceWidth;\n      }\n      if (config.sourceHeight) {\n        imageElement.height = config.sourceHeight;\n      }\n\n      // Store reference\n      this._imageElement = imageElement;\n\n      // Wait for image to load\n      await new Promise((resolve, reject) => {\n        imageElement.onload = () => {\n          // Append to document\n          document.body.appendChild(imageElement);\n\n          // Dispatch custom event for backward compatibility\n          window.dispatchEvent(\n            new CustomEvent('arjs-video-loaded', {\n              detail: { component: imageElement },\n            }),\n          );\n\n          // Emit source events\n          eventBus.emit(EVENTS.SOURCE_LOADED, {\n            element: imageElement,\n            source: 'image',\n          });\n\n          resolve();\n        };\n\n        imageElement.onerror = (error) => {\n          reject(new Error(`Failed to load image: ${error.message || 'Unknown error'}`));\n        };\n      });\n\n      // Get actual image dimensions\n      const actualWidth = imageElement.naturalWidth || config.sourceWidth || 640;\n      const actualHeight = imageElement.naturalHeight || config.sourceHeight || 480;\n\n      return {\n        element: imageElement,\n        width: actualWidth,\n        height: actualHeight,\n        type: 'image',\n      };\n    } catch (error) {\n      console.error('Image capture failed:', error);\n\n      // Emit error event\n      eventBus.emit(EVENTS.SOURCE_ERROR, {\n        error,\n        source: 'image',\n        message: error.message,\n      });\n\n      throw error;\n    }\n  },\n\n  /**\n   * Dispose the plugin and clean up resources\n   */\n  async dispose() {\n    if (this._imageElement) {\n      // Remove from DOM\n      if (this._imageElement.parentNode) {\n        this._imageElement.parentNode.removeChild(this._imageElement);\n      }\n\n      this._imageElement = null;\n    }\n\n    if (this._context && this._context.eventBus) {\n      this._context.eventBus.emit(EVENTS.CAPTURE_DISPOSED, {\n        source: 'image',\n      });\n    }\n  },\n};\n","/**\n * Default Profile Policy Plugin\n * Automatically computes a capability-based device profile at runtime.\n * Backward-compatible: legacy DEVICE_PROFILES mappings still supported.\n */\n\nimport { RESOURCES, DEVICE_PROFILES, QUALITY_TIERS } from '../../src/core/components.js';\n\nexport const defaultProfilePlugin = {\n  id: 'profile:default',\n  name: 'Default Profile Policy (auto)',\n  type: 'profile',\n\n  /**\n   * Initialize the plugin: compute auto profile and publish it\n   */\n  async init(context) {\n    const profile = await this._computeAutoProfile();\n    context.ecs.setResource(RESOURCES.DEVICE_PROFILE, profile);\n    // Emit a profile-applied event for observers (optional)\n    context?.eventBus?.emit?.('profile:applied', { profile });\n  },\n\n  /**\n   * Preferred: detect a structured capability-based profile\n   */\n  async detectProfile() {\n    return this._computeAutoProfile();\n  },\n\n  /**\n   * Compute a capability-based profile\n   * Returns a structured profile with backward-compatible fields.\n   */\n  async _computeAutoProfile() {\n    const caps = this._getCaps();\n    const bench = await this._microBenchmark(8); // ~8ms probe\n    const score = this._scoreCaps(caps, bench);\n    const tierInfo = this._pickTier(score);\n    const [w, h] = tierInfo.capture;\n\n    // Backward-compat top-level fields used in older examples:\n    const legacyCompatible = {\n      label: `auto-${tierInfo.tier}`,\n      sourceWidth: w,\n      sourceHeight: h,\n      displayWidth: w,\n      displayHeight: h,\n      canvasWidth: w,\n      canvasHeight: h,\n      maxDetectionRate: 60,\n    };\n\n    // New structured fields:\n    const structured = {\n      qualityTier: tierInfo.tier, // QUALITY_TIERS value\n      score,\n      caps,\n      capture: {\n        sourceWidth: w,\n        sourceHeight: h,\n        displayWidth: w,\n        displayHeight: h,\n        fpsHint: 30,\n      },\n      processing: {\n        budgetMsPerFrame: tierInfo.budget,\n        complexity: tierInfo.complexity,\n      },\n    };\n\n    return { ...legacyCompatible, ...structured };\n  },\n\n  /**\n   * Get device capability signals (defensive checks for non-browser envs)\n   */\n  _getCaps() {\n    const nav = typeof navigator !== 'undefined' ? navigator : {};\n    const win = typeof window !== 'undefined' ? window : {};\n    const scr = typeof screen !== 'undefined' ? screen : {};\n\n    const userAgentHint = typeof nav.userAgent === 'string' ? nav.userAgent : '';\n    const cores = Math.max(1, Number(nav.hardwareConcurrency || 2));\n    const memoryGB = Math.max(0.5, Number(nav.deviceMemory || 2));\n    const webgl2 = !!win.WebGL2RenderingContext;\n    const wasmSIMD = typeof WebAssembly === 'object' && typeof WebAssembly.validate === 'function';\n    const screenLongSide = Math.max(Number(scr.width || 0), Number(scr.height || 0)) || 0;\n\n    let torch = false;\n    let focusMode = 'unknown';\n    try {\n      const getSC = nav.mediaDevices?.getSupportedConstraints?.bind(nav.mediaDevices);\n      const sc = getSC ? getSC() : {};\n      torch = !!sc?.torch;\n      focusMode = sc?.focusMode ? 'supported' : 'unknown';\n    } catch {\n      // ignore\n    }\n\n    return {\n      userAgentHint,\n      cores,\n      memoryGB,\n      webgl2,\n      wasmSIMD,\n      screenLongSide,\n      camera: { torch, focusMode },\n    };\n  },\n\n  /**\n   * Very small CPU probe to approximate budget\n   */\n  async _microBenchmark(msTarget = 8) {\n    if (typeof performance === 'undefined' || typeof performance.now !== 'function') {\n      return 0;\n    }\n    const start = performance.now();\n    let acc = 0;\n    while (performance.now() - start < msTarget) {\n      // Cheap floating math\n      for (let i = 0; i < 1000; i++) acc += Math.sqrt(i + (acc % 5));\n      // Safety: don't run too long if timers behave oddly\n      if (performance.now() - start > msTarget * 2) break;\n    }\n    return acc;\n  },\n\n  /**\n   * Convert caps + bench signal into a 0..100 score\n   */\n  _scoreCaps(caps, benchSignal) {\n    let score = 0;\n    // Cores: up to 6 cores -> 30 pts\n    score += Math.min(30, (caps.cores || 0) * 5);\n    // Memory: up to ~7.5 GB -> 30 pts\n    score += Math.min(30, (caps.memoryGB || 0) * 4);\n    // WebGL2: 10 pts\n    if (caps.webgl2) score += 10;\n    // WASM SIMD hint: 10 pts\n    if (caps.wasmSIMD) score += 10;\n    // Screen long side: up to ~6000 px -> 10 pts (rough indicator of class)\n    score += Math.min(10, Math.floor((caps.screenLongSide || 0) / 600));\n\n    // Normalize bench signal into ~0..10\n    if (typeof benchSignal === 'number') {\n      const norm = Math.max(0, Math.log10(Math.max(10, benchSignal)));\n      score += Math.min(10, 5 + norm);\n    }\n\n    score = Math.round(Math.max(0, Math.min(100, score)));\n    return score;\n  },\n\n  /**\n   * Map score to a quality tier and capture/budget hints\n   */\n  _pickTier(score) {\n    if (score >= 85) {\n      return {\n        tier: QUALITY_TIERS.ULTRA,\n        capture: [1280, 720],\n        budget: 12,\n        complexity: 'high',\n      };\n    }\n    if (score >= 65) {\n      return {\n        tier: QUALITY_TIERS.HIGH,\n        capture: [960, 540],\n        budget: 10,\n        complexity: 'high',\n      };\n    }\n    if (score >= 45) {\n      return {\n        tier: QUALITY_TIERS.MEDIUM,\n        capture: [800, 450],\n        budget: 8,\n        complexity: 'medium',\n      };\n    }\n    return {\n      tier: QUALITY_TIERS.LOW,\n      capture: [640, 360],\n      budget: 6,\n      complexity: 'low',\n    };\n  },\n\n  /**\n   * Legacy mapping: return a minimal legacy profile by label\n   */\n  getProfile(label) {\n    const profiles = {\n      [DEVICE_PROFILES.DESKTOP_FAST]: {\n        label: DEVICE_PROFILES.DESKTOP_FAST,\n        canvasWidth: 640 * 3,\n        canvasHeight: 480 * 3,\n        maxDetectionRate: 30,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n      [DEVICE_PROFILES.DESKTOP_NORMAL]: {\n        label: DEVICE_PROFILES.DESKTOP_NORMAL,\n        canvasWidth: 640,\n        canvasHeight: 480,\n        maxDetectionRate: 60,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n      [DEVICE_PROFILES.PHONE_NORMAL]: {\n        label: DEVICE_PROFILES.PHONE_NORMAL,\n        canvasWidth: 80 * 4,\n        canvasHeight: 60 * 4,\n        maxDetectionRate: 30,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n      [DEVICE_PROFILES.PHONE_SLOW]: {\n        label: DEVICE_PROFILES.PHONE_SLOW,\n        canvasWidth: 80 * 3,\n        canvasHeight: 60 * 3,\n        maxDetectionRate: 30,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n    };\n\n    return profiles[label] || profiles[DEVICE_PROFILES.DESKTOP_NORMAL];\n  },\n\n  /**\n   * Keep legacy setter: If a legacy label is passed, set that profile.\n   */\n  setProfile(label, context) {\n    const profile = this.getProfile(label);\n    context.ecs.setResource(RESOURCES.DEVICE_PROFILE, profile);\n  },\n\n  /**\n   * Read currently applied profile\n   */\n  getCurrentProfile(context) {\n    return context.ecs.getResource(RESOURCES.DEVICE_PROFILE);\n  },\n\n  /**\n   * Legacy mobile detection retained (unused by default)\n   * Enhanced to cover additional mobile devices and tablets\n   * @private\n   */\n  _isMobileDevice() {\n    const ua = (typeof navigator !== 'undefined' && navigator.userAgent) || '';\n    return !!(\n      ua.match(/Android/i) ||\n      ua.match(/webOS/i) ||\n      ua.match(/iPhone/i) ||\n      ua.match(/iPad/i) ||\n      ua.match(/iPod/i) ||\n      ua.match(/BlackBerry/i) ||\n      ua.match(/Windows Phone/i) ||\n      ua.match(/Opera Mini/i) ||\n      ua.match(/Opera Mobi/i) ||\n      ua.match(/IEMobile/i) ||\n      ua.match(/Mobile/i) ||\n      ua.match(/Kindle/i) ||\n      ua.match(/Silk/i) ||\n      ua.match(/PlayStation/i) ||\n      ua.match(/Nintendo/i)\n    );\n  },\n\n  /**\n   * Dispose hook\n   */\n  async dispose() {\n    // Nothing to clean up\n  },\n};\n"],"names":["ECS","id","entityId","componentMap","componentKey","data","resourceKey","componentKeys","result","hasAll","key","EventBus","eventType","callback","wrapper","callbacks","callbacksCopy","error","PluginManager","eventBus","pluginId","plugin","context","deltaTime","enabledPluginIds","COMPONENTS","RESOURCES","EVENTS","CAPTURE_STATES","SOURCE_TYPES","DEVICE_PROFILES","QUALITY_TIERS","Engine","pkg","system","index","#gameLoop","currentTime","CaptureSystem","config","ecs","pluginManager","sourceType","frameSource","frameSourceRef","sourcePlugins","FramePumpSystem","bus","ref","video","state","offscreen","ctx2d","ensureCanvas","w","h","c","emitFrame","imageBitmap","step","raf","fn","loop","caf","webcamPlugin","videoElement","displayWidth","displayHeight","constraints","stream","resolve","reject","actualWidth","actualHeight","track","vt","videoTrack","enabled","currentState","newState","videoPlugin","playError","clickHandler","imagePlugin","imageElement","defaultProfilePlugin","profile","caps","bench","score","tierInfo","legacyCompatible","structured","nav","win","scr","userAgentHint","cores","memoryGB","webgl2","wasmSIMD","screenLongSide","torch","focusMode","getSC","sc","msTarget","start","acc","i","benchSignal","norm","label","profiles","ua"],"mappings":"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"}