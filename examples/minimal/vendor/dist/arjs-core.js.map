{"version":3,"file":"arjs-core.js","sources":["../src/core/ecs.js","../src/core/event-bus.js","../src/core/plugin-manager.js","../src/core/components.js","../src/core/engine.js","../src/systems/capture-system.js","../src/systems/frame-pump-system.js","../plugins/source/webcam.js","../plugins/source/video.js","../plugins/source/image.js","../plugins/profile/default-policy.js"],"sourcesContent":["/**\n * Minimal Entity-Component-System (ECS) implementation\n * Entities are simple numeric IDs\n * Components are data containers stored in Maps keyed by entity ID\n * Queries allow systems to iterate over entities with specific components\n */\n\nexport class ECS {\n  constructor() {\n    this.nextEntityId = 1;\n    this.entities = new Set();\n    this.components = new Map(); // Map<componentKey, Map<entityId, componentData>>\n    this.resources = new Map(); // Global singleton data\n  }\n\n  /**\n   * Create a new entity\n   * @returns {number} The entity ID\n   */\n  createEntity() {\n    const id = this.nextEntityId++;\n    this.entities.add(id);\n    return id;\n  }\n\n  /**\n   * Destroy an entity and all its components\n   * @param {number} entityId\n   */\n  destroyEntity(entityId) {\n    if (!this.entities.has(entityId)) return;\n\n    this.entities.delete(entityId);\n\n    // Remove all components for this entity\n    for (const componentMap of this.components.values()) {\n      componentMap.delete(entityId);\n    }\n  }\n\n  /**\n   * Add or update a component for an entity\n   * @param {number} entityId\n   * @param {string} componentKey\n   * @param {*} data\n   */\n  setComponent(entityId, componentKey, data) {\n    if (!this.entities.has(entityId)) {\n      throw new Error(`Entity ${entityId} does not exist`);\n    }\n\n    if (!this.components.has(componentKey)) {\n      this.components.set(componentKey, new Map());\n    }\n\n    this.components.get(componentKey).set(entityId, data);\n  }\n\n  /**\n   * Get a component for an entity\n   * @param {number} entityId\n   * @param {string} componentKey\n   * @returns {*} The component data or undefined\n   */\n  getComponent(entityId, componentKey) {\n    const componentMap = this.components.get(componentKey);\n    return componentMap ? componentMap.get(entityId) : undefined;\n  }\n\n  /**\n   * Check if an entity has a component\n   * @param {number} entityId\n   * @param {string} componentKey\n   * @returns {boolean}\n   */\n  hasComponent(entityId, componentKey) {\n    const componentMap = this.components.get(componentKey);\n    return componentMap ? componentMap.has(entityId) : false;\n  }\n\n  /**\n   * Remove a component from an entity\n   * @param {number} entityId\n   * @param {string} componentKey\n   */\n  removeComponent(entityId, componentKey) {\n    const componentMap = this.components.get(componentKey);\n    if (componentMap) {\n      componentMap.delete(entityId);\n    }\n  }\n\n  /**\n   * Set a global resource (singleton data)\n   * @param {string} resourceKey\n   * @param {*} data\n   */\n  setResource(resourceKey, data) {\n    this.resources.set(resourceKey, data);\n  }\n\n  /**\n   * Get a global resource\n   * @param {string} resourceKey\n   * @returns {*}\n   */\n  getResource(resourceKey) {\n    return this.resources.get(resourceKey);\n  }\n\n  /**\n   * Check if a resource exists\n   * @param {string} resourceKey\n   * @returns {boolean}\n   */\n  hasResource(resourceKey) {\n    return this.resources.has(resourceKey);\n  }\n\n  /**\n   * Remove a resource\n   * @param {string} resourceKey\n   */\n  removeResource(resourceKey) {\n    this.resources.delete(resourceKey);\n  }\n\n  /**\n   * Query entities that have all specified components\n   * @param {...string} componentKeys\n   * @returns {Array<number>} Array of entity IDs\n   */\n  query(...componentKeys) {\n    if (componentKeys.length === 0) {\n      return Array.from(this.entities);\n    }\n\n    const result = [];\n\n    for (const entityId of this.entities) {\n      let hasAll = true;\n      for (const key of componentKeys) {\n        if (!this.hasComponent(entityId, key)) {\n          hasAll = false;\n          break;\n        }\n      }\n      if (hasAll) {\n        result.push(entityId);\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Get all components for a specific component key\n   * @param {string} componentKey\n   * @returns {Map<number, *>} Map of entity IDs to component data\n   */\n  getAllComponents(componentKey) {\n    return this.components.get(componentKey) || new Map();\n  }\n\n  /**\n   * Clear all entities and components\n   */\n  clear() {\n    this.entities.clear();\n    this.components.clear();\n    this.resources.clear();\n    this.nextEntityId = 1;\n  }\n}\n","/**\n * Lightweight publish-subscribe event bus\n * Allows components to communicate without tight coupling\n */\n\nexport class EventBus {\n  constructor() {\n    this.listeners = new Map(); // Map<eventType, Set<callback>>\n  }\n\n  /**\n   * Subscribe to an event\n   * @param {string} eventType\n   * @param {Function} callback\n   * @returns {Function} Unsubscribe function\n   */\n  on(eventType, callback) {\n    if (!this.listeners.has(eventType)) {\n      this.listeners.set(eventType, new Set());\n    }\n\n    this.listeners.get(eventType).add(callback);\n\n    // Return unsubscribe function\n    return () => this.off(eventType, callback);\n  }\n\n  /**\n   * Subscribe to an event once (auto-unsubscribe after first trigger)\n   * @param {string} eventType\n   * @param {Function} callback\n   * @returns {Function} Unsubscribe function\n   */\n  once(eventType, callback) {\n    const wrapper = (data) => {\n      this.off(eventType, wrapper);\n      callback(data);\n    };\n\n    return this.on(eventType, wrapper);\n  }\n\n  /**\n   * Unsubscribe from an event\n   * @param {string} eventType\n   * @param {Function} callback\n   */\n  off(eventType, callback) {\n    const callbacks = this.listeners.get(eventType);\n    if (callbacks) {\n      callbacks.delete(callback);\n      if (callbacks.size === 0) {\n        this.listeners.delete(eventType);\n      }\n    }\n  }\n\n  /**\n   * Emit an event to all subscribers\n   * @param {string} eventType\n   * @param {*} data\n   */\n  emit(eventType, data) {\n    const callbacks = this.listeners.get(eventType);\n    if (callbacks) {\n      // Create a copy to avoid issues if listeners modify the set during iteration\n      const callbacksCopy = Array.from(callbacks);\n      for (const callback of callbacksCopy) {\n        try {\n          callback(data);\n        } catch (error) {\n          console.error(`Error in event listener for ${eventType}:`, error);\n        }\n      }\n    }\n  }\n\n  /**\n   * Remove all listeners for a specific event type, or all listeners if no type specified\n   * @param {string} [eventType]\n   */\n  clear(eventType) {\n    if (eventType) {\n      this.listeners.delete(eventType);\n    } else {\n      this.listeners.clear();\n    }\n  }\n\n  /**\n   * Get the number of listeners for an event type\n   * @param {string} eventType\n   * @returns {number}\n   */\n  listenerCount(eventType) {\n    const callbacks = this.listeners.get(eventType);\n    return callbacks ? callbacks.size : 0;\n  }\n}\n","/**\n * Plugin Manager\n * Handles registration, enabling, and disabling of plugins\n * Plugins can hook into the engine lifecycle and provide functionality\n */\n\nexport class PluginManager {\n  constructor(eventBus) {\n    this.eventBus = eventBus;\n    this.plugins = new Map(); // Map<pluginId, pluginInstance>\n    this.enabledPlugins = new Set(); // Set of enabled plugin IDs\n  }\n\n  /**\n   * Register a plugin\n   * @param {string} pluginId - Unique identifier for the plugin\n   * @param {Object} plugin - Plugin instance\n   * @param {Function} [plugin.init] - Initialize plugin (called on enable)\n   * @param {Function} [plugin.dispose] - Cleanup plugin (called on disable)\n   * @param {Function} [plugin.update] - Called each frame if implemented\n   * @returns {boolean} Success\n   */\n  register(pluginId, plugin) {\n    if (this.plugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is already registered`);\n      return false;\n    }\n\n    // Validate plugin structure\n    if (typeof plugin !== 'object') {\n      console.error(`Plugin ${pluginId} must be an object`);\n      return false;\n    }\n\n    this.plugins.set(pluginId, plugin);\n\n    if (this.eventBus) {\n      this.eventBus.emit('plugin:registered', { pluginId, plugin });\n    }\n\n    return true;\n  }\n\n  /**\n   * Unregister a plugin\n   * @param {string} pluginId\n   * @returns {boolean} Success\n   */\n  unregister(pluginId) {\n    if (!this.plugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is not registered`);\n      return false;\n    }\n\n    // Disable if currently enabled\n    if (this.enabledPlugins.has(pluginId)) {\n      this.disable(pluginId);\n    }\n\n    this.plugins.delete(pluginId);\n    return true;\n  }\n\n  /**\n   * Enable a plugin\n   * @param {string} pluginId\n   * @param {Object} context - Engine context (ecs, eventBus, etc.)\n   * @returns {Promise<boolean>} Success\n   */\n  async enable(pluginId, context) {\n    if (!this.plugins.has(pluginId)) {\n      console.error(`Plugin ${pluginId} is not registered`);\n      return false;\n    }\n\n    if (this.enabledPlugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is already enabled`);\n      return false;\n    }\n\n    const plugin = this.plugins.get(pluginId);\n\n    try {\n      // Call plugin's init method if it exists\n      if (typeof plugin.init === 'function') {\n        await plugin.init(context);\n      }\n\n      this.enabledPlugins.add(pluginId);\n\n      if (this.eventBus) {\n        this.eventBus.emit('plugin:enabled', { pluginId, plugin });\n      }\n\n      return true;\n    } catch (error) {\n      console.error(`Failed to enable plugin ${pluginId}:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Disable a plugin\n   * @param {string} pluginId\n   * @returns {Promise<boolean>} Success\n   */\n  async disable(pluginId) {\n    if (!this.enabledPlugins.has(pluginId)) {\n      console.warn(`Plugin ${pluginId} is not enabled`);\n      return false;\n    }\n\n    const plugin = this.plugins.get(pluginId);\n\n    try {\n      // Call plugin's dispose method if it exists\n      if (typeof plugin.dispose === 'function') {\n        await plugin.dispose();\n      }\n\n      this.enabledPlugins.delete(pluginId);\n\n      if (this.eventBus) {\n        this.eventBus.emit('plugin:disabled', { pluginId, plugin });\n      }\n\n      return true;\n    } catch (error) {\n      console.error(`Failed to disable plugin ${pluginId}:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Get a plugin instance\n   * @param {string} pluginId\n   * @returns {Object|undefined}\n   */\n  getPlugin(pluginId) {\n    return this.plugins.get(pluginId);\n  }\n\n  /**\n   * Check if a plugin is registered\n   * @param {string} pluginId\n   * @returns {boolean}\n   */\n  isRegistered(pluginId) {\n    return this.plugins.has(pluginId);\n  }\n\n  /**\n   * Check if a plugin is enabled\n   * @param {string} pluginId\n   * @returns {boolean}\n   */\n  isEnabled(pluginId) {\n    return this.enabledPlugins.has(pluginId);\n  }\n\n  /**\n   * Get all registered plugin IDs\n   * @returns {Array<string>}\n   */\n  getRegisteredPlugins() {\n    return Array.from(this.plugins.keys());\n  }\n\n  /**\n   * Get all enabled plugin IDs\n   * @returns {Array<string>}\n   */\n  getEnabledPlugins() {\n    return Array.from(this.enabledPlugins);\n  }\n\n  /**\n   * Update all enabled plugins that have an update method\n   * @param {number} deltaTime - Time since last frame in milliseconds\n   * @param {Object} context - Engine context\n   */\n  update(deltaTime, context) {\n    for (const pluginId of this.enabledPlugins) {\n      const plugin = this.plugins.get(pluginId);\n      if (plugin && typeof plugin.update === 'function') {\n        try {\n          plugin.update(deltaTime, context);\n        } catch (error) {\n          console.error(`Error updating plugin ${pluginId}:`, error);\n        }\n      }\n    }\n  }\n\n  /**\n   * Disable all plugins and clear registry\n   */\n  async clear() {\n    // Disable all enabled plugins\n    const enabledPluginIds = Array.from(this.enabledPlugins);\n    for (const pluginId of enabledPluginIds) {\n      await this.disable(pluginId);\n    }\n\n    this.plugins.clear();\n    this.enabledPlugins.clear();\n  }\n}\n","/**\n * Shared component and resource keys\n * These are used to identify different types of data in the ECS\n */\n\n// Component Keys (entity-specific data)\nexport const COMPONENTS = {\n  // Marker or tracking target component\n  TRACKING_TARGET: 'TrackingTarget',\n\n  // Transform component (position, rotation, scale)\n  TRANSFORM: 'Transform',\n\n  // Visibility state\n  VISIBLE: 'Visible',\n};\n\n// Resource Keys (global singleton data)\nexport const RESOURCES = {\n  // Configuration for AR processing\n  PROCESSING_CONFIG: 'ProcessingConfig',\n\n  // Current state of capture (ready, error, etc.)\n  CAPTURE_STATE: 'CaptureState',\n\n  // Reference to the frame source (video element, image, etc.)\n  FRAME_SOURCE_REF: 'FrameSourceRef',\n\n  // Device profile (desktop-normal, phone-normal, etc.)\n  DEVICE_PROFILE: 'DeviceProfile',\n\n  // Enabled plugins\n  ENABLED_PLUGINS: 'EnabledPlugins',\n};\n\n// Event Types\nexport const EVENTS = {\n  // Capture lifecycle events\n  CAPTURE_INIT_START: 'capture:init:start',\n  CAPTURE_INIT_SUCCESS: 'capture:init:success',\n  CAPTURE_INIT_ERROR: 'capture:init:error',\n  CAPTURE_READY: 'capture:ready',\n  CAPTURE_DISPOSED: 'capture:disposed',\n\n  // Source lifecycle events\n  SOURCE_LOADED: 'source:loaded',\n  SOURCE_ERROR: 'source:error',\n  SOURCE_PLAYING: 'source:playing',\n  SOURCE_PAUSED: 'source:paused',\n\n  // Frame processing events\n  FRAME_PROCESSED: 'frame:processed',\n\n  // Engine lifecycle events\n  ENGINE_START: 'engine:start',\n  ENGINE_STOP: 'engine:stop',\n  ENGINE_UPDATE: 'engine:update',\n\n  // Plugin lifecycle events\n  PLUGIN_REGISTERED: 'plugin:registered',\n  PLUGIN_ENABLED: 'plugin:enabled',\n  PLUGIN_DISABLED: 'plugin:disabled',\n};\n\n// Capture States\nexport const CAPTURE_STATES = {\n  UNINITIALIZED: 'uninitialized',\n  INITIALIZING: 'initializing',\n  READY: 'ready',\n  ERROR: 'error',\n  DISPOSED: 'disposed',\n};\n\n// Source Types\nexport const SOURCE_TYPES = {\n  WEBCAM: 'webcam',\n  VIDEO: 'video',\n  IMAGE: 'image',\n};\n\n// Device Profiles (legacy presets; retained for backward compatibility)\nexport const DEVICE_PROFILES = {\n  DESKTOP_FAST: 'desktop-fast',\n  DESKTOP_NORMAL: 'desktop-normal',\n  PHONE_NORMAL: 'phone-normal',\n  PHONE_SLOW: 'phone-slow',\n};\n\n// New capability/quality-based tiers (preferred going forward)\nexport const QUALITY_TIERS = {\n  LOW: 'low',\n  MEDIUM: 'medium',\n  HIGH: 'high',\n  ULTRA: 'ultra',\n};\n","/**\n * AR.js Core Engine\n * Orchestrates ECS, event bus, plugin manager, and game loop\n */\n\nimport { ECS } from './ecs.js';\nimport { EventBus } from './event-bus.js';\nimport { PluginManager } from './plugin-manager.js';\nimport { EVENTS } from './components.js';\n// Keep Engine.REVISION aligned with the package version\n// Bundlers (Vite/Webpack) and Vitest support JSON imports by default.\nimport pkg from '../../package.json';\n\nexport class Engine {\n  // Library identity/versioning\n  static NAME = '@ar-js-org/ar.js-core';\n  static VERSION = pkg?.version || '0.0.0-dev';\n  // Back-compat friendly alias (similar to old Context.REVISION)\n  static REVISION = Engine.VERSION;\n\n  constructor() {\n    this.ecs = new ECS();\n    this.eventBus = new EventBus();\n    this.pluginManager = new PluginManager(this.eventBus);\n    this.systems = [];\n    this.isRunning = false;\n    this.lastFrameTime = 0;\n    this.animationFrameId = null;\n  }\n\n  /**\n   * Add a system to the engine\n   * Systems are functions that run each frame: (deltaTime, context) => void\n   * @param {Function} system - System function\n   */\n  addSystem(system) {\n    if (typeof system !== 'function') {\n      console.error('System must be a function');\n      return;\n    }\n    this.systems.push(system);\n  }\n\n  /**\n   * Remove a system from the engine\n   * @param {Function} system\n   */\n  removeSystem(system) {\n    const index = this.systems.indexOf(system);\n    if (index !== -1) {\n      this.systems.splice(index, 1);\n    }\n  }\n\n  /**\n   * Start the engine and game loop\n   */\n  start() {\n    if (this.isRunning) {\n      console.warn('Engine is already running');\n      return;\n    }\n\n    this.isRunning = true;\n    this.lastFrameTime = performance.now();\n\n    this.eventBus.emit(EVENTS.ENGINE_START, { engine: this });\n\n    // Start the game loop\n    this.animationFrameId = requestAnimationFrame(this.#gameLoop.bind(this));\n  }\n\n  /**\n   * Stop the engine and game loop\n   */\n  stop() {\n    if (!this.isRunning) {\n      return;\n    }\n\n    this.isRunning = false;\n\n    if (this.animationFrameId !== null) {\n      cancelAnimationFrame(this.animationFrameId);\n      this.animationFrameId = null;\n    }\n\n    this.eventBus.emit(EVENTS.ENGINE_STOP, { engine: this });\n  }\n\n  /**\n   * Game loop - runs each frame\n   * @private\n   */\n  #gameLoop(currentTime) {\n    if (!this.isRunning) return;\n\n    // Calculate delta time\n    const deltaTime = currentTime - this.lastFrameTime;\n    this.lastFrameTime = currentTime;\n\n    // Create context for systems and plugins\n    const context = {\n      ecs: this.ecs,\n      eventBus: this.eventBus,\n      pluginManager: this.pluginManager,\n      engine: this,\n    };\n\n    // Update all systems\n    for (const system of this.systems) {\n      try {\n        system(deltaTime, context);\n      } catch (error) {\n        console.error('Error in system:', error);\n      }\n    }\n\n    // Update all enabled plugins\n    this.pluginManager.update(deltaTime, context);\n\n    // Emit update event\n    this.eventBus.emit(EVENTS.ENGINE_UPDATE, { deltaTime, context });\n\n    // Schedule next frame\n    this.animationFrameId = requestAnimationFrame(this.#gameLoop.bind(this));\n  }\n\n  /**\n   * Run a single update manually (useful for testing or non-realtime scenarios)\n   * @param {number} [deltaTime=16.67] - Time delta in milliseconds\n   */\n  update(deltaTime = 16.67) {\n    const context = {\n      ecs: this.ecs,\n      eventBus: this.eventBus,\n      pluginManager: this.pluginManager,\n      engine: this,\n    };\n\n    for (const system of this.systems) {\n      try {\n        system(deltaTime, context);\n      } catch (error) {\n        console.error('Error in system:', error);\n      }\n    }\n\n    this.pluginManager.update(deltaTime, context);\n    this.eventBus.emit(EVENTS.ENGINE_UPDATE, { deltaTime, context });\n  }\n\n  /**\n   * Get the current context\n   * @returns {Object}\n   */\n  getContext() {\n    return {\n      ecs: this.ecs,\n      eventBus: this.eventBus,\n      pluginManager: this.pluginManager,\n      engine: this,\n    };\n  }\n\n  /**\n   * Dispose the engine and clean up resources\n   */\n  async dispose() {\n    this.stop();\n\n    // Disable all plugins\n    await this.pluginManager.clear();\n\n    // Clear all systems\n    this.systems = [];\n\n    // Clear ECS\n    this.ecs.clear();\n\n    // Clear event listeners\n    this.eventBus.clear();\n  }\n}\n","/**\n * Capture System\n * Initializes the chosen capture plugin, manages capture state,\n * and writes FrameSourceRef + CaptureState resources\n */\n\nimport { RESOURCES, EVENTS, CAPTURE_STATES, SOURCE_TYPES } from '../core/components.js';\n\nexport class CaptureSystem {\n  /**\n   * Initialize capture system with configuration\n   * @param {Object} config\n   * @param {string} config.sourceType - Type of source (webcam, video, image)\n   * @param {string} [config.sourceUrl] - URL for video/image sources\n   * @param {string} [config.deviceId] - Specific camera device ID\n   * @param {number} [config.sourceWidth] - Desired source width\n   * @param {number} [config.sourceHeight] - Desired source height\n   */\n  static async initialize(config, context) {\n    const { ecs, eventBus, pluginManager } = context;\n\n    // Set initial capture state\n    ecs.setResource(RESOURCES.CAPTURE_STATE, {\n      state: CAPTURE_STATES.INITIALIZING,\n      error: null,\n    });\n\n    eventBus.emit(EVENTS.CAPTURE_INIT_START, { config });\n\n    try {\n      // Determine which plugin to use based on source type\n      const sourceType = config.sourceType || SOURCE_TYPES.WEBCAM;\n      let pluginId;\n\n      switch (sourceType) {\n        case SOURCE_TYPES.WEBCAM:\n          pluginId = 'source:webcam';\n          break;\n        case SOURCE_TYPES.VIDEO:\n          pluginId = 'source:video';\n          break;\n        case SOURCE_TYPES.IMAGE:\n          pluginId = 'source:image';\n          break;\n        default:\n          throw new Error(`Unknown source type: ${sourceType}`);\n      }\n\n      // Check if the plugin is registered\n      if (!pluginManager.isRegistered(pluginId)) {\n        throw new Error(`Plugin ${pluginId} is not registered`);\n      }\n\n      // Enable the plugin if not already enabled\n      if (!pluginManager.isEnabled(pluginId)) {\n        const success = await pluginManager.enable(pluginId, context);\n        if (!success) {\n          throw new Error(`Failed to enable plugin ${pluginId}`);\n        }\n      }\n\n      // Get the plugin and call its capture method\n      const plugin = pluginManager.getPlugin(pluginId);\n      if (!plugin || typeof plugin.capture !== 'function') {\n        throw new Error(`Plugin ${pluginId} does not have a capture method`);\n      }\n\n      // Call the plugin's capture method\n      const frameSource = await plugin.capture(config, context);\n\n      // Store the frame source reference\n      ecs.setResource(RESOURCES.FRAME_SOURCE_REF, {\n        element: frameSource.element,\n        stream: frameSource.stream,\n        type: sourceType,\n        width: frameSource.width || config.sourceWidth || 640,\n        height: frameSource.height || config.sourceHeight || 480,\n      });\n\n      // Update capture state to ready\n      ecs.setResource(RESOURCES.CAPTURE_STATE, {\n        state: CAPTURE_STATES.READY,\n        error: null,\n      });\n\n      eventBus.emit(EVENTS.CAPTURE_INIT_SUCCESS, { frameSource });\n      eventBus.emit(EVENTS.CAPTURE_READY, { frameSource });\n\n      return frameSource;\n    } catch (error) {\n      console.error('Capture initialization failed:', error);\n\n      // Update capture state to error\n      ecs.setResource(RESOURCES.CAPTURE_STATE, {\n        state: CAPTURE_STATES.ERROR,\n        error: error.message || 'Unknown error',\n      });\n\n      eventBus.emit(EVENTS.CAPTURE_INIT_ERROR, { error });\n\n      throw error;\n    }\n  }\n\n  /**\n   * Dispose the capture system and clean up resources\n   */\n  static async dispose(context) {\n    const { ecs, eventBus, pluginManager } = context;\n\n    // Get the current frame source\n    const frameSourceRef = ecs.getResource(RESOURCES.FRAME_SOURCE_REF);\n\n    // Disable source plugins\n    const sourcePlugins = ['source:webcam', 'source:video', 'source:image'];\n    for (const pluginId of sourcePlugins) {\n      if (pluginManager.isEnabled(pluginId)) {\n        await pluginManager.disable(pluginId);\n      }\n    }\n\n    // Remove resources\n    ecs.removeResource(RESOURCES.FRAME_SOURCE_REF);\n    ecs.setResource(RESOURCES.CAPTURE_STATE, {\n      state: CAPTURE_STATES.DISPOSED,\n      error: null,\n    });\n\n    eventBus.emit(EVENTS.CAPTURE_DISPOSED, { frameSourceRef });\n  }\n\n  /**\n   * Get the current capture state\n   */\n  static getState(context) {\n    return context.ecs.getResource(RESOURCES.CAPTURE_STATE);\n  }\n\n  /**\n   * Get the current frame source\n   */\n  static getFrameSource(context) {\n    return context.ecs.getResource(RESOURCES.FRAME_SOURCE_REF);\n  }\n}\n","/**\n * FramePumpSystem\n * Emits engine:update with ImageBitmap frames from the active video source.\n * - Prefers HTMLVideoElement.requestVideoFrameCallback when available\n * - Falls back to requestAnimationFrame\n * - Uses createImageBitmap(video) when possible (fast path)\n * - Falls back to drawing to a canvas and createImageBitmap(canvas)\n */\nimport { RESOURCES } from '../core/components.js';\n\nexport class FramePumpSystem {\n  static start(context) {\n    if (!context) throw new Error('FramePumpSystem.start requires a context');\n    const bus = context.eventBus;\n    const ref = context.ecs.getResource(RESOURCES.FRAME_SOURCE_REF);\n\n    if (!ref?.element) {\n      console.warn(\n        '[FramePumpSystem] No frame source element found; did you call CaptureSystem.initialize?',\n      );\n      return false;\n    }\n    const video = ref.element;\n    if (String(video.tagName).toUpperCase() !== 'VIDEO') {\n      console.warn('[FramePumpSystem] Frame source is not a <video> element; skipping frame pump.');\n      return false;\n    }\n\n    // Keep state on context to allow stop()\n    context.__framePump = context.__framePump || {};\n    const state = context.__framePump;\n    if (state.running) return true;\n    state.running = true;\n    state._fid = 0;\n    state._raf = 0;\n    state._rvfc = 0;\n\n    // Optional canvas fallback\n    let offscreen = null;\n    let ctx2d = null;\n\n    function ensureCanvas(w, h) {\n      if (offscreen && offscreen.width === w && offscreen.height === h) return;\n      try {\n        if (typeof globalThis.OffscreenCanvas !== 'undefined') {\n          offscreen = new globalThis.OffscreenCanvas(w, h);\n          ctx2d = offscreen.getContext('2d', { willReadFrequently: true });\n        } else {\n          const c = globalThis.document?.createElement?.('canvas');\n          if (!c) {\n            offscreen = null;\n            ctx2d = null;\n            return;\n          }\n          c.width = w;\n          c.height = h;\n          c.style.display = 'none';\n          try {\n            globalThis.document?.body?.appendChild?.(c);\n          } catch {}\n          offscreen = c;\n          ctx2d = c.getContext('2d', { willReadFrequently: true });\n        }\n      } catch {\n        offscreen = null;\n        ctx2d = null;\n      }\n    }\n\n    async function emitFrame() {\n      const w = video.videoWidth || ref.width || 640;\n      const h = video.videoHeight || ref.height || 480;\n      if (!w || !h) return;\n\n      // Fast path: ImageBitmap directly from video\n      try {\n        if (typeof globalThis.createImageBitmap === 'function') {\n          const imageBitmap = await globalThis.createImageBitmap(video);\n          bus.emit('engine:update', { id: ++state._fid, imageBitmap, width: w, height: h });\n          return;\n        }\n      } catch {\n        // fall through to canvas path\n      }\n\n      // Canvas fallback\n      try {\n        ensureCanvas(w, h);\n        if (!offscreen || !ctx2d) return;\n\n        ctx2d.clearRect(0, 0, w, h);\n        ctx2d.drawImage(video, 0, 0, w, h);\n\n        if (typeof globalThis.createImageBitmap === 'function') {\n          const imageBitmap = await globalThis.createImageBitmap(offscreen);\n          bus.emit('engine:update', { id: ++state._fid, imageBitmap, width: w, height: h });\n        } else {\n          // As a last resort, emit without ImageBitmap (worker will try a slower fallback)\n          bus.emit('engine:update', { id: ++state._fid, width: w, height: h });\n        }\n      } catch {\n        // ignore transient failures\n      }\n    }\n\n    // Use requestVideoFrameCallback when available\n    if (typeof video.requestVideoFrameCallback === 'function') {\n      const step = async () => {\n        if (!state.running) return;\n        await emitFrame();\n        state._rvfc = video.requestVideoFrameCallback(step);\n      };\n      state._rvfc = video.requestVideoFrameCallback(step);\n    } else {\n      const raf = globalThis.requestAnimationFrame || ((fn) => setTimeout(fn, 16));\n      const loop = async () => {\n        if (!state.running) return;\n        await emitFrame();\n        state._raf = raf(loop);\n      };\n      state._raf = raf(loop);\n    }\n\n    return true;\n  }\n\n  static stop(context) {\n    const state = context?.__framePump;\n    const ref = context?.ecs?.getResource?.(RESOURCES.FRAME_SOURCE_REF);\n    const video = ref?.element;\n    if (!state || !state.running) return;\n\n    state.running = false;\n\n    // Cancel RVFC via the video element\n    if (video && typeof video.cancelVideoFrameCallback === 'function' && state._rvfc) {\n      try {\n        video.cancelVideoFrameCallback(state._rvfc);\n      } catch {}\n    }\n\n    // Cancel RAF/timeout\n    const caf =\n      globalThis.cancelAnimationFrame ||\n      ((id) => {\n        try {\n          clearTimeout(id);\n        } catch {}\n      });\n    if (state._raf) {\n      try {\n        caf(state._raf);\n      } catch {}\n    }\n\n    context.__framePump = undefined;\n  }\n}\n","/**\n * Webcam Source Plugin\n * Provides getUserMedia-based video capture from webcam\n * Emits source lifecycle events and provides HTMLVideoElement + MediaStream\n */\n\nimport { EVENTS } from '../../src/core/components.js';\n\nexport const webcamPlugin = {\n  id: 'source:webcam',\n  name: 'Webcam Source',\n  type: 'source',\n\n  // Internal state\n  _videoElement: null,\n  _stream: null,\n  _context: null,\n\n  /**\n   * Initialize the plugin\n   */\n  async init(context) {\n    this._context = context;\n  },\n\n  /**\n   * Capture video from webcam\n   * @param {Object} config\n   * @param {string} [config.deviceId] - Specific camera device ID\n   * @param {number} [config.sourceWidth] - Desired video width\n   * @param {number} [config.sourceHeight] - Desired video height\n   * @param {number} [config.displayWidth] - Display width\n   * @param {number} [config.displayHeight] - Display height\n   * @param {Object} context - Engine context\n   * @returns {Promise<Object>} Frame source with element and stream\n   */\n  async capture(config, context) {\n    const { eventBus } = context;\n\n    // Check if MediaDevices API is available\n    if (\n      !globalThis.navigator?.mediaDevices ||\n      !globalThis.navigator.mediaDevices.getUserMedia ||\n      !globalThis.navigator.mediaDevices.enumerateDevices\n    ) {\n      const error = new Error('MediaDevices API not available in this browser');\n      eventBus.emit(EVENTS.SOURCE_ERROR, { error, source: 'webcam' });\n      throw error;\n    }\n\n    try {\n      // Create video element\n      const videoElement =\n        globalThis.document?.createElement?.('video') ||\n        Object.assign(\n          {},\n          {\n            setAttribute() {},\n            style: {},\n            play: async () => {},\n          },\n        );\n      videoElement.setAttribute?.('autoplay', '');\n      videoElement.setAttribute?.('muted', '');\n      videoElement.setAttribute?.('playsinline', '');\n      videoElement.setAttribute?.('id', 'arjs-video');\n\n      // Set display size\n      const displayWidth = config.displayWidth || 640;\n      const displayHeight = config.displayHeight || 480;\n      if (videoElement.style) {\n        videoElement.style.width = displayWidth + 'px';\n        videoElement.style.height = displayHeight + 'px';\n        videoElement.style.position = 'absolute';\n        videoElement.style.top = '0px';\n        videoElement.style.left = '0px';\n        videoElement.style.zIndex = '-2';\n      }\n\n      // Build getUserMedia constraints\n      const constraints = {\n        audio: false,\n        video: {\n          facingMode: 'environment',\n          width: { ideal: config.sourceWidth || 640 },\n          height: { ideal: config.sourceHeight || 480 },\n        },\n      };\n\n      // Add device ID if specified\n      if (config.deviceId) {\n        constraints.video.deviceId = { exact: config.deviceId };\n      }\n\n      // Get media stream\n      const stream = await globalThis.navigator.mediaDevices.getUserMedia(constraints);\n\n      // Set video source\n      videoElement.srcObject = stream;\n\n      // Store references\n      this._videoElement = videoElement;\n      this._stream = stream;\n\n      // Wait for video to be ready\n      await new Promise((resolve, reject) => {\n        videoElement.onloadedmetadata = () => {\n          videoElement\n            .play?.()\n            .then(() => {\n              // Append to document (best-effort)\n              try {\n                globalThis.document?.body?.appendChild?.(videoElement);\n              } catch {}\n\n              // Dispatch custom event for backward compatibility\n              try {\n                globalThis.window?.dispatchEvent?.(\n                  new globalThis.CustomEvent('camera-init', {\n                    detail: { stream },\n                  }),\n                );\n                globalThis.window?.dispatchEvent?.(\n                  new globalThis.CustomEvent('arjs-video-loaded', {\n                    detail: { component: videoElement },\n                  }),\n                );\n              } catch {}\n\n              // Emit source events\n              eventBus.emit(EVENTS.SOURCE_LOADED, {\n                element: videoElement,\n                stream,\n                source: 'webcam',\n              });\n              eventBus.emit(EVENTS.SOURCE_PLAYING, {\n                element: videoElement,\n                source: 'webcam',\n              });\n\n              resolve();\n            })\n            .catch(reject);\n        };\n\n        videoElement.onerror = reject;\n      });\n\n      // Get actual video dimensions\n      const actualWidth = videoElement.videoWidth || config.sourceWidth || 640;\n      const actualHeight = videoElement.videoHeight || config.sourceHeight || 480;\n\n      return {\n        element: videoElement,\n        stream: stream,\n        width: actualWidth,\n        height: actualHeight,\n        type: 'webcam',\n      };\n    } catch (error) {\n      // Emit error event\n      context?.eventBus?.emit?.(EVENTS.SOURCE_ERROR, {\n        error,\n        source: 'webcam',\n        message: error.message,\n      });\n\n      // Dispatch custom event for backward compatibility\n      try {\n        globalThis.window?.dispatchEvent?.(\n          new globalThis.CustomEvent('camera-error', { detail: { error } }),\n        );\n      } catch {}\n\n      throw error;\n    }\n  },\n\n  /**\n   * Dispose the plugin and clean up resources\n   */\n  async dispose() {\n    if (this._stream) {\n      try {\n        this._stream.getTracks?.().forEach((track) => track.stop?.());\n      } catch {}\n      this._stream = null;\n    }\n\n    if (this._videoElement) {\n      try {\n        if (this._videoElement.parentNode?.removeChild) {\n          this._videoElement.parentNode.removeChild(this._videoElement);\n        }\n        this._videoElement.srcObject = null;\n      } catch {}\n      this._videoElement = null;\n    }\n\n    if (this._context?.eventBus) {\n      this._context.eventBus.emit(EVENTS.CAPTURE_DISPOSED, {\n        source: 'webcam',\n      });\n    }\n  },\n\n  /**\n   * Check if mobile torch is available\n   * @returns {boolean}\n   */\n  hasMobileTorch() {\n    if (!this._stream) return false;\n\n    // Guard against environments where MediaStream is undefined\n    const hasCtor = typeof globalThis.MediaStream === 'function';\n    if (!hasCtor) {\n      // Fallback: duck-type for getVideoTracks availability\n      const vt = this._stream?.getVideoTracks?.();\n      return Array.isArray(vt) && vt[0]?.getCapabilities ? !!vt[0].getCapabilities().torch : false;\n    }\n\n    const videoTrack = this._stream.getVideoTracks?.()[0];\n    if (!videoTrack || !videoTrack.getCapabilities) {\n      return false;\n    }\n    const capabilities = videoTrack.getCapabilities();\n    return !!capabilities.torch;\n  },\n\n  /**\n   * Toggle mobile torch on/off\n   * @param {boolean} [enabled] - Force enable/disable, or toggle if not provided\n   * @returns {Promise<boolean>} New torch state\n   */\n  async toggleMobileTorch(enabled) {\n    // Only proceed if torch is available\n    if (!this.hasMobileTorch()) {\n      console.warn?.('Mobile torch is not available on this device');\n      return false;\n    }\n\n    const videoTrack = this._stream.getVideoTracks()[0];\n    const currentState = this._torchEnabled || false;\n    const newState = enabled !== undefined ? enabled : !currentState;\n\n    try {\n      await videoTrack.applyConstraints?.({\n        advanced: [{ torch: newState }],\n      });\n      this._torchEnabled = newState;\n      return newState;\n    } catch (error) {\n      console.error?.('Failed to toggle torch:', error);\n      return currentState;\n    }\n  },\n};\n","/**\n * Video Source Plugin\n * Provides video playback from local or remote video files\n * Emits source lifecycle events and provides HTMLVideoElement\n */\n\nimport { EVENTS } from '../../src/core/components.js';\n\nexport const videoPlugin = {\n  id: 'source:video',\n  name: 'Video Source',\n  type: 'source',\n\n  // Internal state\n  _videoElement: null,\n  _context: null,\n\n  /**\n   * Initialize the plugin\n   */\n  async init(context) {\n    this._context = context;\n  },\n\n  /**\n   * Capture video from a file or URL\n   * @param {Object} config\n   * @param {string} config.sourceUrl - URL or path to video file\n   * @param {number} [config.sourceWidth] - Desired video width\n   * @param {number} [config.sourceHeight] - Desired video height\n   * @param {number} [config.displayWidth] - Display width\n   * @param {number} [config.displayHeight] - Display height\n   * @param {boolean} [config.loop] - Whether to loop the video\n   * @param {boolean} [config.muted] - Whether to mute the video\n   * @param {Object} context - Engine context\n   * @returns {Promise<Object>} Frame source with element\n   */\n  async capture(config, context) {\n    const { eventBus } = context;\n\n    if (!config.sourceUrl) {\n      const error = new Error('sourceUrl is required for video source');\n      eventBus.emit(EVENTS.SOURCE_ERROR, { error, source: 'video' });\n      throw error;\n    }\n\n    try {\n      // Create video element\n      const videoElement = document.createElement('video');\n      videoElement.src = config.sourceUrl;\n      videoElement.setAttribute('id', 'arjs-video');\n\n      // Set video attributes\n      videoElement.autoplay = true;\n      videoElement.setAttribute('playsinline', '');\n      videoElement.controls = false;\n      videoElement.loop = config.loop !== false; // Default to true\n      videoElement.muted = config.muted !== false; // Default to true\n\n      // Set display size\n      const displayWidth = config.displayWidth || 640;\n      const displayHeight = config.displayHeight || 480;\n      videoElement.style.width = displayWidth + 'px';\n      videoElement.style.height = displayHeight + 'px';\n      videoElement.style.position = 'absolute';\n      videoElement.style.top = '0px';\n      videoElement.style.left = '0px';\n      videoElement.style.zIndex = '-2';\n      videoElement.style.objectFit = 'initial';\n\n      // Set internal dimensions\n      if (config.sourceWidth) {\n        videoElement.width = config.sourceWidth;\n      }\n      if (config.sourceHeight) {\n        videoElement.height = config.sourceHeight;\n      }\n\n      // Store reference\n      this._videoElement = videoElement;\n\n      // Wait for video to load\n      await new Promise((resolve, reject) => {\n        videoElement.onloadeddata = () => {\n          // Append to document\n          document.body.appendChild(videoElement);\n\n          // Start playback (may require user interaction on some browsers)\n          videoElement\n            .play()\n            .then(() => {\n              // Dispatch custom event for backward compatibility\n              window.dispatchEvent(\n                new CustomEvent('arjs-video-loaded', {\n                  detail: { component: videoElement },\n                }),\n              );\n\n              // Emit source events\n              eventBus.emit(EVENTS.SOURCE_LOADED, {\n                element: videoElement,\n                source: 'video',\n              });\n              eventBus.emit(EVENTS.SOURCE_PLAYING, {\n                element: videoElement,\n                source: 'video',\n              });\n\n              resolve();\n            })\n            .catch((playError) => {\n              // If autoplay fails, set up click handler\n              console.warn('Autoplay failed, waiting for user interaction');\n\n              const clickHandler = () => {\n                videoElement.play().then(() => {\n                  eventBus.emit(EVENTS.SOURCE_PLAYING, {\n                    element: videoElement,\n                    source: 'video',\n                  });\n                });\n                document.body.removeEventListener('click', clickHandler);\n              };\n\n              document.body.addEventListener('click', clickHandler, {\n                once: true,\n              });\n\n              resolve(); // Resolve anyway, video is loaded\n            });\n        };\n\n        videoElement.onerror = (error) => {\n          reject(new Error(`Failed to load video: ${error.message || 'Unknown error'}`));\n        };\n      });\n\n      // Get actual video dimensions\n      const actualWidth = videoElement.videoWidth || config.sourceWidth || 640;\n      const actualHeight = videoElement.videoHeight || config.sourceHeight || 480;\n\n      return {\n        element: videoElement,\n        width: actualWidth,\n        height: actualHeight,\n        type: 'video',\n      };\n    } catch (error) {\n      console.error('Video capture failed:', error);\n\n      // Emit error event\n      eventBus.emit(EVENTS.SOURCE_ERROR, {\n        error,\n        source: 'video',\n        message: error.message,\n      });\n\n      throw error;\n    }\n  },\n\n  /**\n   * Dispose the plugin and clean up resources\n   */\n  async dispose() {\n    if (this._videoElement) {\n      // Pause and clean up\n      this._videoElement.pause();\n      this._videoElement.removeAttribute('src');\n      this._videoElement.load();\n\n      // Remove from DOM\n      if (this._videoElement.parentNode) {\n        this._videoElement.parentNode.removeChild(this._videoElement);\n      }\n\n      this._videoElement = null;\n    }\n\n    if (this._context && this._context.eventBus) {\n      this._context.eventBus.emit(EVENTS.CAPTURE_DISPOSED, {\n        source: 'video',\n      });\n    }\n  },\n};\n","/**\n * Image Source Plugin\n * Provides static image loading from local or remote image files\n * Emits source lifecycle events and provides HTMLImageElement\n */\n\nimport { EVENTS } from '../../src/core/components.js';\n\nexport const imagePlugin = {\n  id: 'source:image',\n  name: 'Image Source',\n  type: 'source',\n\n  // Internal state\n  _imageElement: null,\n  _context: null,\n\n  /**\n   * Initialize the plugin\n   */\n  async init(context) {\n    this._context = context;\n  },\n\n  /**\n   * Load an image from a file or URL\n   * @param {Object} config\n   * @param {string} config.sourceUrl - URL or path to image file\n   * @param {number} [config.sourceWidth] - Desired image width\n   * @param {number} [config.sourceHeight] - Desired image height\n   * @param {number} [config.displayWidth] - Display width\n   * @param {number} [config.displayHeight] - Display height\n   * @param {Object} context - Engine context\n   * @returns {Promise<Object>} Frame source with element\n   */\n  async capture(config, context) {\n    const { eventBus } = context;\n\n    if (!config.sourceUrl) {\n      const error = new Error('sourceUrl is required for image source');\n      eventBus.emit(EVENTS.SOURCE_ERROR, { error, source: 'image' });\n      throw error;\n    }\n\n    try {\n      // Create image element\n      const imageElement = document.createElement('img');\n      imageElement.src = config.sourceUrl;\n      imageElement.setAttribute('id', 'arjs-video');\n\n      // Set display size\n      const displayWidth = config.displayWidth || 640;\n      const displayHeight = config.displayHeight || 480;\n      imageElement.style.width = displayWidth + 'px';\n      imageElement.style.height = displayHeight + 'px';\n      imageElement.style.position = 'absolute';\n      imageElement.style.top = '0px';\n      imageElement.style.left = '0px';\n      imageElement.style.zIndex = '-2';\n\n      // Set internal dimensions if specified\n      if (config.sourceWidth) {\n        imageElement.width = config.sourceWidth;\n      }\n      if (config.sourceHeight) {\n        imageElement.height = config.sourceHeight;\n      }\n\n      // Store reference\n      this._imageElement = imageElement;\n\n      // Wait for image to load\n      await new Promise((resolve, reject) => {\n        imageElement.onload = () => {\n          // Append to document\n          document.body.appendChild(imageElement);\n\n          // Dispatch custom event for backward compatibility\n          window.dispatchEvent(\n            new CustomEvent('arjs-video-loaded', {\n              detail: { component: imageElement },\n            }),\n          );\n\n          // Emit source events\n          eventBus.emit(EVENTS.SOURCE_LOADED, {\n            element: imageElement,\n            source: 'image',\n          });\n\n          resolve();\n        };\n\n        imageElement.onerror = (error) => {\n          reject(new Error(`Failed to load image: ${error.message || 'Unknown error'}`));\n        };\n      });\n\n      // Get actual image dimensions\n      const actualWidth = imageElement.naturalWidth || config.sourceWidth || 640;\n      const actualHeight = imageElement.naturalHeight || config.sourceHeight || 480;\n\n      return {\n        element: imageElement,\n        width: actualWidth,\n        height: actualHeight,\n        type: 'image',\n      };\n    } catch (error) {\n      console.error('Image capture failed:', error);\n\n      // Emit error event\n      eventBus.emit(EVENTS.SOURCE_ERROR, {\n        error,\n        source: 'image',\n        message: error.message,\n      });\n\n      throw error;\n    }\n  },\n\n  /**\n   * Dispose the plugin and clean up resources\n   */\n  async dispose() {\n    if (this._imageElement) {\n      // Remove from DOM\n      if (this._imageElement.parentNode) {\n        this._imageElement.parentNode.removeChild(this._imageElement);\n      }\n\n      this._imageElement = null;\n    }\n\n    if (this._context && this._context.eventBus) {\n      this._context.eventBus.emit(EVENTS.CAPTURE_DISPOSED, {\n        source: 'image',\n      });\n    }\n  },\n};\n","/**\n * Default Profile Policy Plugin\n * Automatically computes a capability-based device profile at runtime.\n * Backward-compatible: legacy DEVICE_PROFILES mappings still supported.\n */\n\nimport { RESOURCES, DEVICE_PROFILES, QUALITY_TIERS } from '../../src/core/components.js';\n\nexport const defaultProfilePlugin = {\n  id: 'profile:default',\n  name: 'Default Profile Policy (auto)',\n  type: 'profile',\n\n  /**\n   * Initialize the plugin: compute auto profile and publish it\n   */\n  async init(context) {\n    const profile = await this._computeAutoProfile();\n    context.ecs.setResource(RESOURCES.DEVICE_PROFILE, profile);\n    // Emit a profile-applied event for observers (optional)\n    context?.eventBus?.emit?.('profile:applied', { profile });\n  },\n\n  /**\n   * Preferred: detect a structured capability-based profile\n   */\n  async detectProfile() {\n    return this._computeAutoProfile();\n  },\n\n  /**\n   * Compute a capability-based profile\n   * Returns a structured profile with backward-compatible fields.\n   */\n  async _computeAutoProfile() {\n    const caps = this._getCaps();\n    const bench = await this._microBenchmark(8); // ~8ms probe\n    const score = this._scoreCaps(caps, bench);\n    const tierInfo = this._pickTier(score);\n    const [w, h] = tierInfo.capture;\n\n    // Backward-compat top-level fields used in older examples:\n    const legacyCompatible = {\n      label: `auto-${tierInfo.tier}`,\n      sourceWidth: w,\n      sourceHeight: h,\n      displayWidth: w,\n      displayHeight: h,\n      canvasWidth: w,\n      canvasHeight: h,\n      maxDetectionRate: 60,\n    };\n\n    // New structured fields:\n    const structured = {\n      qualityTier: tierInfo.tier, // QUALITY_TIERS value\n      score,\n      caps,\n      capture: {\n        sourceWidth: w,\n        sourceHeight: h,\n        displayWidth: w,\n        displayHeight: h,\n        fpsHint: 30,\n      },\n      processing: {\n        budgetMsPerFrame: tierInfo.budget,\n        complexity: tierInfo.complexity,\n      },\n    };\n\n    return { ...legacyCompatible, ...structured };\n  },\n\n  /**\n   * Get device capability signals (defensive checks for non-browser envs)\n   */\n  _getCaps() {\n    const nav = typeof navigator !== 'undefined' ? navigator : {};\n    const win = typeof window !== 'undefined' ? window : {};\n    const scr = typeof screen !== 'undefined' ? screen : {};\n\n    const userAgentHint = typeof nav.userAgent === 'string' ? nav.userAgent : '';\n    const cores = Math.max(1, Number(nav.hardwareConcurrency || 2));\n    const memoryGB = Math.max(0.5, Number(nav.deviceMemory || 2));\n    const webgl2 = !!win.WebGL2RenderingContext;\n    const wasmSIMD = typeof WebAssembly === 'object' && typeof WebAssembly.validate === 'function';\n    const screenLongSide = Math.max(Number(scr.width || 0), Number(scr.height || 0)) || 0;\n\n    let torch = false;\n    let focusMode = 'unknown';\n    try {\n      const getSC = nav.mediaDevices?.getSupportedConstraints?.bind(nav.mediaDevices);\n      const sc = getSC ? getSC() : {};\n      torch = !!sc?.torch;\n      focusMode = sc?.focusMode ? 'supported' : 'unknown';\n    } catch {\n      // ignore\n    }\n\n    return {\n      userAgentHint,\n      cores,\n      memoryGB,\n      webgl2,\n      wasmSIMD,\n      screenLongSide,\n      camera: { torch, focusMode },\n    };\n  },\n\n  /**\n   * Very small CPU probe to approximate budget\n   */\n  async _microBenchmark(msTarget = 8) {\n    if (typeof performance === 'undefined' || typeof performance.now !== 'function') {\n      return 0;\n    }\n    const start = performance.now();\n    let acc = 0;\n    while (performance.now() - start < msTarget) {\n      // Cheap floating math\n      for (let i = 0; i < 1000; i++) acc += Math.sqrt(i + (acc % 5));\n      // Safety: don't run too long if timers behave oddly\n      if (performance.now() - start > msTarget * 2) break;\n    }\n    return acc;\n  },\n\n  /**\n   * Convert caps + bench signal into a 0..100 score\n   */\n  _scoreCaps(caps, benchSignal) {\n    let score = 0;\n    // Cores: up to 6 cores -> 30 pts\n    score += Math.min(30, (caps.cores || 0) * 5);\n    // Memory: up to ~7.5 GB -> 30 pts\n    score += Math.min(30, (caps.memoryGB || 0) * 4);\n    // WebGL2: 10 pts\n    if (caps.webgl2) score += 10;\n    // WASM SIMD hint: 10 pts\n    if (caps.wasmSIMD) score += 10;\n    // Screen long side: up to ~6000 px -> 10 pts (rough indicator of class)\n    score += Math.min(10, Math.floor((caps.screenLongSide || 0) / 600));\n\n    // Normalize bench signal into ~0..10\n    if (typeof benchSignal === 'number') {\n      const norm = Math.max(0, Math.log10(Math.max(10, benchSignal)));\n      score += Math.min(10, 5 + norm);\n    }\n\n    score = Math.round(Math.max(0, Math.min(100, score)));\n    return score;\n  },\n\n  /**\n   * Map score to a quality tier and capture/budget hints\n   */\n  _pickTier(score) {\n    if (score >= 85) {\n      return {\n        tier: QUALITY_TIERS.ULTRA,\n        capture: [1280, 720],\n        budget: 12,\n        complexity: 'high',\n      };\n    }\n    if (score >= 65) {\n      return {\n        tier: QUALITY_TIERS.HIGH,\n        capture: [960, 540],\n        budget: 10,\n        complexity: 'high',\n      };\n    }\n    if (score >= 45) {\n      return {\n        tier: QUALITY_TIERS.MEDIUM,\n        capture: [800, 450],\n        budget: 8,\n        complexity: 'medium',\n      };\n    }\n    return {\n      tier: QUALITY_TIERS.LOW,\n      capture: [640, 360],\n      budget: 6,\n      complexity: 'low',\n    };\n  },\n\n  /**\n   * Legacy mapping: return a minimal legacy profile by label\n   */\n  getProfile(label) {\n    const profiles = {\n      [DEVICE_PROFILES.DESKTOP_FAST]: {\n        label: DEVICE_PROFILES.DESKTOP_FAST,\n        canvasWidth: 640 * 3,\n        canvasHeight: 480 * 3,\n        maxDetectionRate: 30,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n      [DEVICE_PROFILES.DESKTOP_NORMAL]: {\n        label: DEVICE_PROFILES.DESKTOP_NORMAL,\n        canvasWidth: 640,\n        canvasHeight: 480,\n        maxDetectionRate: 60,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n      [DEVICE_PROFILES.PHONE_NORMAL]: {\n        label: DEVICE_PROFILES.PHONE_NORMAL,\n        canvasWidth: 80 * 4,\n        canvasHeight: 60 * 4,\n        maxDetectionRate: 30,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n      [DEVICE_PROFILES.PHONE_SLOW]: {\n        label: DEVICE_PROFILES.PHONE_SLOW,\n        canvasWidth: 80 * 3,\n        canvasHeight: 60 * 3,\n        maxDetectionRate: 30,\n        sourceWidth: 640,\n        sourceHeight: 480,\n      },\n    };\n\n    return profiles[label] || profiles[DEVICE_PROFILES.DESKTOP_NORMAL];\n  },\n\n  /**\n   * Keep legacy setter: If a legacy label is passed, set that profile.\n   */\n  setProfile(label, context) {\n    const profile = this.getProfile(label);\n    context.ecs.setResource(RESOURCES.DEVICE_PROFILE, profile);\n  },\n\n  /**\n   * Read currently applied profile\n   */\n  getCurrentProfile(context) {\n    return context.ecs.getResource(RESOURCES.DEVICE_PROFILE);\n  },\n\n  /**\n   * Legacy mobile detection retained (unused by default)\n   * Enhanced to cover additional mobile devices and tablets\n   * @private\n   */\n  _isMobileDevice() {\n    const ua = (typeof navigator !== 'undefined' && navigator.userAgent) || '';\n    return !!(\n      ua.match(/Android/i) ||\n      ua.match(/webOS/i) ||\n      ua.match(/iPhone/i) ||\n      ua.match(/iPad/i) ||\n      ua.match(/iPod/i) ||\n      ua.match(/BlackBerry/i) ||\n      ua.match(/Windows Phone/i) ||\n      ua.match(/Opera Mini/i) ||\n      ua.match(/Opera Mobi/i) ||\n      ua.match(/IEMobile/i) ||\n      ua.match(/Mobile/i) ||\n      ua.match(/Kindle/i) ||\n      ua.match(/Silk/i) ||\n      ua.match(/PlayStation/i) ||\n      ua.match(/Nintendo/i)\n    );\n  },\n\n  /**\n   * Dispose hook\n   */\n  async dispose() {\n    // Nothing to clean up\n  },\n};\n"],"names":["ECS","id","entityId","componentMap","componentKey","data","resourceKey","componentKeys","result","hasAll","key","EventBus","eventType","callback","wrapper","callbacks","callbacksCopy","error","PluginManager","eventBus","pluginId","plugin","context","deltaTime","enabledPluginIds","COMPONENTS","RESOURCES","EVENTS","CAPTURE_STATES","SOURCE_TYPES","DEVICE_PROFILES","QUALITY_TIERS","Engine","pkg","system","index","#gameLoop","currentTime","CaptureSystem","config","ecs","pluginManager","sourceType","frameSource","frameSourceRef","sourcePlugins","FramePumpSystem","bus","ref","video","state","offscreen","ctx2d","ensureCanvas","w","h","c","emitFrame","imageBitmap","step","raf","fn","loop","caf","webcamPlugin","videoElement","displayWidth","displayHeight","constraints","stream","resolve","reject","actualWidth","actualHeight","track","vt","videoTrack","enabled","currentState","newState","videoPlugin","playError","clickHandler","imagePlugin","imageElement","defaultProfilePlugin","profile","caps","bench","score","tierInfo","legacyCompatible","structured","nav","win","scr","userAgentHint","cores","memoryGB","webgl2","wasmSIMD","screenLongSide","torch","focusMode","getSC","sc","msTarget","start","acc","i","benchSignal","norm","label","profiles","ua"],"mappings":"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"}