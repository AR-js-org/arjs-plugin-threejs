{"version":3,"file":"arjs-plugin-artoolkit.esm.js","sources":["../src/plugin.js","../src/utils/matrix.js"],"sourcesContent":["// src/plugin.js\r\n/**\r\n * ArtoolkitPlugin\r\n * - maintains plugin lifecycle (init, enable, disable, dispose)\r\n * - optionally runs detection inside a Worker (src/worker/worker.js)\r\n * - subscribes to engine:update to send frames (ImageBitmap or frame metadata) to the worker\r\n * - emits ar:markerFound / ar:markerUpdated / ar:markerLost on the engine eventBus\r\n *\r\n * Works both in browsers (global Worker) and in Node (worker_threads.Worker).\r\n */\r\nexport class ArtoolkitPlugin {\r\n    constructor(options = {}) {\r\n        this.options = options;\r\n        this.core = null;\r\n        this.enabled = false;\r\n\r\n        // Worker and handlers\r\n        this._worker = null;\r\n        this._onWorkerMessage = this._onWorkerMessage.bind(this);\r\n\r\n        // Engine update subscription\r\n        this._onEngineUpdate = this._onEngineUpdate.bind(this);\r\n\r\n        // Marker state tracking: Map<id, { lastSeen: number, visible: boolean }>\r\n        this._markers = new Map();\r\n\r\n        // configuration (defaults)\r\n        // lostThreshold: number of frames to consider a marker lost\r\n        this.lostThreshold = options.lostThreshold ?? 5; // frames\r\n        // frameDurationMs: how many milliseconds to consider a single 'frame' (used to convert lostThreshold -> ms)\r\n        // Default 200ms per frame is a conservative default (5 fps). Consumers can adjust to match their capture rate.\r\n        this.frameDurationMs = options.frameDurationMs ?? 200;\r\n        // sweepIntervalMs: how often to run the lost-marker sweep (ms)\r\n        this.sweepIntervalMs = options.sweepIntervalMs ?? 100;\r\n\r\n        // Worker enabled toggle\r\n        this.workerEnabled = options.worker !== false; // default true\r\n\r\n        // Pending loadMarker requests: Map<requestId, { resolve, reject }>\r\n        this._pendingMarkerLoads = new Map();\r\n        this._nextLoadRequestId = 0;\r\n\r\n        // Track worker readiness (used by examples to avoid UI race)\r\n        this.workerReady = false;\r\n    }\r\n\r\n    async init(core) {\r\n        this.core = core;\r\n        // Nothing heavy here; defer worker setup to enable()\r\n        return this;\r\n    }\r\n\r\n    async enable() {\r\n        if (!this.core) throw new Error('Plugin not initialized');\r\n        if (this.enabled) return this;\r\n        this.enabled = true;\r\n\r\n        // subscribe to engine update to send frames to worker\r\n        this.core.eventBus.on('engine:update', this._onEngineUpdate);\r\n\r\n        // start worker if configured\r\n        if (this.workerEnabled) {\r\n            await this._startWorker();\r\n        }\r\n\r\n        // start a simple interval to sweep lost markers by time computed from frameDurationMs\r\n        this._sweepInterval = setInterval(() => this._sweepMarkers(), this.sweepIntervalMs);\r\n        return this;\r\n    }\r\n\r\n    async disable() {\r\n        if (!this.enabled) return this;\r\n        this.enabled = false;\r\n\r\n        this.core.eventBus.off('engine:update', this._onEngineUpdate);\r\n\r\n        if (this._worker) {\r\n            this._stopWorker();\r\n        }\r\n\r\n        if (this._sweepInterval) {\r\n            clearInterval(this._sweepInterval);\r\n            this._sweepInterval = null;\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    dispose() {\r\n        return this.disable();\r\n    }\r\n\r\n    // Engine frame handler: forward frame info or ImageBitmap to the worker\r\n    _onEngineUpdate(frame) {\r\n        // frame is expected to be an object provided by the capture system, e.g.:\r\n        // { id: number, timestamp, imageBitmap?, width, height, sourceRef }\r\n        if (!frame) return;\r\n\r\n        // If the frame contains an ImageBitmap (browser), transfer it to the worker for zero-copy processing.\r\n        if (this._worker && frame.imageBitmap) {\r\n            try {\r\n                // Browser Worker supports transfer list; Node worker_threads supports postMessage but not ImageBitmap.\r\n                if (typeof Worker !== 'undefined') {\r\n                    // Browser: use transferable ImageBitmap\r\n                    // The browser worker will receive event.data.payload.imageBitmap\r\n                    this._worker.postMessage(\r\n                        { type: 'processFrame', payload: { frameId: frame.id, imageBitmap: frame.imageBitmap, width: frame.width, height: frame.height } },\r\n                        // transfer list: ImageBitmap is transferable\r\n                        [frame.imageBitmap]\r\n                    );\r\n                    // After transfer, the main thread's ImageBitmap is neutered; consumer should not reuse it.\r\n                } else {\r\n                    // Node: ImageBitmap isn't available/transferable; fall back to sending metadata or ArrayBuffer if provided\r\n                    this._worker.postMessage({ type: 'processFrame', payload: { frameId: frame.id, width: frame.width, height: frame.height } });\r\n                }\r\n            } catch (err) {\r\n                console.warn('Artoolkit worker postMessage (ImageBitmap) failed, falling back to frameId only', err);\r\n                try {\r\n                    this._worker.postMessage({ type: 'processFrame', payload: { frameId: frame.id } });\r\n                } catch (e) {\r\n                    console.warn('worker postMessage failed', e);\r\n                }\r\n            }\r\n            return;\r\n        }\r\n\r\n        // No ImageBitmap: send lighter payload as before (frameId)\r\n        if (this._worker) {\r\n            try {\r\n                this._worker.postMessage({ type: 'processFrame', payload: { frameId: frame.id } });\r\n            } catch (err) {\r\n                console.warn('Artoolkit worker postMessage failed', err);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Worker lifecycle (cross-platform)\r\n    async _startWorker() {\r\n        if (this._worker) return;\r\n\r\n        // Browser environment: global Worker exists\r\n        if (typeof Worker !== 'undefined') {\r\n            // Works in browsers and bundlers that support new URL(...) for workers\r\n            this._worker = new Worker(new URL('./worker/worker.js', import.meta.url), { type: 'module' });\r\n        } else {\r\n            // Node environment: use worker_threads.Worker\r\n            const { Worker: NodeWorker } = await import('node:worker_threads');\r\n            const workerUrl = new URL('./worker/worker.js', import.meta.url);\r\n            const { fileURLToPath } = await import('node:url');\r\n            const workerPath = fileURLToPath(workerUrl);\r\n            this._worker = new NodeWorker(workerPath, { type: 'module' });\r\n        }\r\n\r\n        // Attach message handler (same for both environments)\r\n        if (this._worker.addEventListener) {\r\n            this._worker.addEventListener('message', this._onWorkerMessage);\r\n        } else if (this._worker.on) {\r\n            this._worker.on('message', this._onWorkerMessage);\r\n        }\r\n\r\n        // If worker supports postMessage init, send init\r\n        try {\r\n            this._worker.postMessage?.({\r\n                type: 'init',\r\n                payload: {\r\n                    moduleUrl: this.options.artoolkitModuleUrl || null,\r\n                    cameraParametersUrl: this.options.cameraParametersUrl || null,\r\n                    wasmBaseUrl: this.options.wasmBaseUrl || null\r\n                }\r\n            });\r\n            // Watchdog: if 'ready' wasn’t received shortly, resend a no-op init once\r\n            setTimeout(() => {\r\n                if (!this.workerReady) {\r\n                    try { this._worker?.postMessage?.({ type: 'init', payload: {} }); } catch {}\r\n                }\r\n            }, 500);\r\n        } catch (e) {\r\n            // ignore\r\n        }\r\n    }\r\n\r\n    _stopWorker() {\r\n        if (!this._worker) return;\r\n\r\n        // Remove handler\r\n        if (this._worker.removeEventListener) {\r\n            this._worker.removeEventListener('message', this._onWorkerMessage);\r\n        } else if (this._worker.off) {\r\n            this._worker.off('message', this._onWorkerMessage);\r\n        }\r\n\r\n        try {\r\n            if (typeof Worker !== 'undefined') {\r\n                this._worker.terminate();\r\n            } else {\r\n                this._worker.terminate?.();\r\n            }\r\n        } catch (e) {\r\n            // ignore\r\n        }\r\n        this._worker = null;\r\n    }\r\n\r\n    // NEW: Normalize detection updates and emit markerFound/Updated\r\n    _applyDetections(detections) {\r\n        if (!detections || !Array.isArray(detections)) return;\r\n        for (const d of detections) {\r\n            const id = d?.id;\r\n            if (id === null || id === undefined) continue;\r\n\r\n            const now = Date.now();\r\n            const poseMatrix = new Float32Array(d.poseMatrix || []);\r\n            const confidence = d.confidence ?? 0;\r\n            const corners = d.corners ?? [];\r\n\r\n            const prev = this._markers.get(id);\r\n            if (!prev || !prev.visible) {\r\n                this._markers.set(id, { lastSeen: now, visible: true, lostCount: 0 });\r\n                this.core?.eventBus?.emit('ar:markerFound', { id, poseMatrix, confidence, corners, timestamp: now });\r\n            } else {\r\n                prev.lastSeen = now;\r\n                prev.lostCount = 0;\r\n                this._markers.set(id, prev);\r\n                this.core?.eventBus?.emit('ar:markerUpdated', { id, poseMatrix, confidence, corners, timestamp: now });\r\n            }\r\n        }\r\n    }\r\n\r\n    _onWorkerMessage(ev) {\r\n        // worker_threads messages arrive as the raw payload; browser workers wrap in event.data\r\n        const data = ev && ev.data !== undefined ? ev.data : ev;\r\n        const { type, payload } = data || {};\r\n        if (type === 'ready') {\r\n            console.log('[Plugin] Worker ready');\r\n            this.workerReady = true;\r\n            this.core?.eventBus?.emit('ar:workerReady', {});\r\n        } else if (type === 'detectionResult') {\r\n            console.log('[Plugin] Received detectionResult:', payload);\r\n            // Normalize to marker events\r\n            if (!payload || !Array.isArray(payload.detections)) return;\r\n            this._applyDetections(payload.detections);\r\n        } else if (type === 'getMarker') {\r\n            // Forward AR.js-style getMarker payload (emitted by the worker) to the app/event bus\r\n            try { console.log('[Plugin] getMarker', payload); } catch (_) {}\r\n            this.core?.eventBus?.emit('ar:getMarker', payload);\r\n\r\n            // ALSO translate this getMarker into a detection to drive markerFound/Updated\r\n            try {\r\n                const m = payload?.marker || {};\r\n                const id = m.idPatt ?? m.patternId ?? m.pattern_id ?? null;\r\n\r\n                // Matrix normalization\r\n                let poseArray = null;\r\n                if (Array.isArray(payload?.matrix)) {\r\n                    poseArray = payload.matrix.slice(0, 16);\r\n                } else if (payload?.matrix && typeof payload.matrix.length === 'number') {\r\n                    poseArray = Array.from(payload.matrix).slice(0, 16);\r\n                }\r\n\r\n                // Corners/vertex normalization (optional)\r\n                let corners = [];\r\n                const v = m.vertex;\r\n                if (Array.isArray(v)) {\r\n                    // vertex may be [x0,y0,x1,y1,...]\r\n                    for (let i = 0; i + 1 < v.length; i += 2) {\r\n                        corners.push([v[i], v[i + 1]]);\r\n                    }\r\n                }\r\n\r\n                const confidence = m.cfPatt ?? m.confidence ?? 0;\r\n\r\n                if (id != null && poseArray && poseArray.length === 16) {\r\n                    this._applyDetections([{\r\n                        id,\r\n                        confidence,\r\n                        poseMatrix: poseArray,\r\n                        corners\r\n                    }]);\r\n                }\r\n            } catch (e) {\r\n                // ignore conversion errors; raw getMarker still forwarded\r\n            }\r\n        } else if (type === 'loadMarkerResult') {\r\n            console.log('[Plugin] Received loadMarkerResult:', payload);\r\n            const { requestId, ok, error, markerId, size } = payload || {};\r\n\r\n            if (requestId !== undefined) {\r\n                const pending = this._pendingMarkerLoads.get(requestId);\r\n                if (pending) {\r\n                    this._pendingMarkerLoads.delete(requestId);\r\n                    if (ok) {\r\n                        pending.resolve({ markerId, size });\r\n                    } else {\r\n                        pending.reject(new Error(error || 'Failed to load marker'));\r\n                    }\r\n                }\r\n            }\r\n        } else if (type === 'error') {\r\n            console.error('Artoolkit worker error', payload);\r\n            this.core?.eventBus?.emit('ar:workerError', payload);\r\n        }\r\n    }\r\n\r\n    // sweep markers and emit lost events for markers not seen recently\r\n    _sweepMarkers() {\r\n        const now = Date.now();\r\n        const lostThresholdMs = this.lostThreshold * this.frameDurationMs;\r\n        for (const [id, state] of this._markers.entries()) {\r\n            const deltaMs = now - (state.lastSeen || 0);\r\n            if (deltaMs > lostThresholdMs) {\r\n                this._markers.delete(id);\r\n                this.core.eventBus.emit('ar:markerLost', { id, timestamp: now });\r\n            }\r\n        }\r\n    }\r\n\r\n    // public helper to get marker state\r\n    getMarkerState(markerId) {\r\n        return this._markers.get(markerId) || null;\r\n    }\r\n\r\n    /**\r\n     * Load a pattern marker from a URL\r\n     * @param {string} patternUrl - URL to the pattern file (absolute or repo-relative)\r\n     * @param {number} size - Size of the marker in world units (default: 1)\r\n     * @returns {Promise<{markerId: number, size: number}>} - Resolves with marker info when loaded\r\n     */\r\n    async loadMarker(patternUrl, size = 1) {\r\n        if (!this._worker) {\r\n            throw new Error('Worker not available. Ensure plugin is enabled and worker is running.');\r\n        }\r\n\r\n        console.log(`[Plugin] Loading marker: ${patternUrl} with size ${size}`);\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const requestId = this._nextLoadRequestId++;\r\n            this._pendingMarkerLoads.set(requestId, { resolve, reject });\r\n\r\n            // Send loadMarker message to worker\r\n            try {\r\n                this._worker.postMessage({\r\n                    type: 'loadMarker',\r\n                    payload: { patternUrl, size, requestId }\r\n                });\r\n            } catch (err) {\r\n                this._pendingMarkerLoads.delete(requestId);\r\n                reject(new Error(`Failed to send loadMarker message: ${err.message}`));\r\n            }\r\n\r\n            // Set a timeout to prevent hanging promises\r\n            setTimeout(() => {\r\n                if (this._pendingMarkerLoads.has(requestId)) {\r\n                    this._pendingMarkerLoads.delete(requestId);\r\n                    reject(new Error('loadMarker request timed out'));\r\n                }\r\n            }, 10000); // 10 second timeout\r\n        });\r\n    }\r\n}","// small set of conversion helpers for ARToolKit → Three.js coordinate conventions\r\nexport function convertModelViewToThreeMatrix(modelViewArray) {\r\n    // Input: Float32Array(16) from artoolkit (row-major or library-specific)\r\n    // Output: Float32Array(16) ready to use with THREE.Matrix4.fromArray (column-major)\r\n    // Concrete conversion will be implemented when integrating artoolkit5-js.\r\n    const out = new Float32Array(16);\r\n    for (let i = 0; i < 16; i++) out[i] = modelViewArray[i];\r\n    return out;\r\n}"],"names":["ArtoolkitPlugin","options","core","frame","err","e","NodeWorker","__viteBrowserExternal","workerUrl","fileURLToPath","workerPath","detections","d","id","now","poseMatrix","confidence","corners","prev","ev","data","type","payload","m","poseArray","v","i","requestId","ok","error","markerId","size","pending","lostThresholdMs","state","patternUrl","resolve","reject","convertModelViewToThreeMatrix","modelViewArray","out"],"mappings":"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"}