{"version":3,"file":"arjs-plugin-artoolkit.es.js","sources":["../src/plugin.js","../src/utils/matrix.js"],"sourcesContent":["/**\n * @fileoverview ARToolKit Plugin - Core implementation\n *\n * Manages the lifecycle of marker-based AR tracking using ARToolKit.\n * Supports web worker-based detection, marker state tracking, and event emission.\n * Works in both browser (Web Worker) and Node.js (worker_threads) environments.\n *\n * @module plugin\n */\n\n/**\n * Plugin version string, injected at build time by Vite's define feature.\n * In development/test environments without the build define, defaults to 'unknown'.\n *\n * @type {string}\n * @constant\n */\nconst ARTOOLKIT_PLUGIN_VERSION =\n  typeof __ARTOOLKIT_PLUGIN_VERSION__ !== \"undefined\"\n    ? __ARTOOLKIT_PLUGIN_VERSION__\n    : \"unknown\";\n\nexport { ARTOOLKIT_PLUGIN_VERSION };\n\n/**\n * ARToolKit Plugin for marker-based augmented reality tracking.\n *\n * This plugin integrates ARToolKit marker detection into AR.js, managing:\n * - Plugin lifecycle (init, enable, disable, dispose)\n * - Web Worker-based detection for off-main-thread processing\n * - Frame processing via ImageBitmap transfer (zero-copy in browsers)\n * - Marker state tracking and lost-marker detection\n * - Event emission for marker lifecycle (found/updated/lost)\n *\n * @class\n * @param {Object} options - Configuration options\n * @param {boolean} [options.worker=true] - Enable worker-based detection\n * @param {number} [options.lostThreshold=5] - Frames before marking a marker as lost\n * @param {number} [options.frameDurationMs=200] - Milliseconds per frame (for lost calculation)\n * @param {number} [options.sweepIntervalMs=100] - Interval for running lost-marker sweep\n * @param {string} [options.artoolkitModuleUrl] - Custom URL for ARToolKit module\n * @param {string} [options.cameraParametersUrl] - Camera calibration parameters URL\n * @param {string} [options.wasmBaseUrl] - Base URL for ARToolKit WASM files\n *\n * @example\n * const plugin = new ArtoolkitPlugin({\n *   worker: true,\n *   lostThreshold: 10,\n *   cameraParametersUrl: '/path/to/camera_para.dat'\n * });\n * await plugin.init(engineCore);\n * await plugin.enable();\n *\n * @fires ar:markerFound - When a marker is first detected\n * @fires ar:markerUpdated - When a tracked marker's pose updates\n * @fires ar:markerLost - When a marker hasn't been seen for lostThreshold frames\n * @fires ar:workerReady - When the detection worker is initialized\n * @fires ar:workerError - When the worker encounters an error\n * @fires ar:getMarker - Raw AR.js-style marker detection events\n *\n * @note Works in both browser (Web Worker) and Node.js (worker_threads) environments\n */\nexport class ArtoolkitPlugin {\n  constructor(options = {}) {\n    /** @type {ArtoolkitPluginOptions} */\n    this.options = {\n      worker: true,\n      lostThreshold: 5,\n      frameDurationMs: 200,\n      sweepIntervalMs: 100,\n      artoolkitModuleUrl: undefined,\n      cameraParametersUrl: undefined,\n      wasmBaseUrl: undefined,\n      ...options,\n    };\n    /** @type {EngineCore | null} */\n    this.core = null;\n    /** @type {boolean} */\n    this.enabled = false;\n\n    // Worker and handlers\n    this._worker = null;\n    this._onWorkerMessage = this._onWorkerMessage.bind(this);\n\n    // Engine update subscription\n    this._onEngineUpdate = this._onEngineUpdate.bind(this);\n\n    // Marker state tracking: Map<id, { lastSeen: number, visible: boolean }>\n    this._markers = new Map();\n\n    // Use options consistently\n    this.lostThreshold = this.options.lostThreshold;\n    this.frameDurationMs = this.options.frameDurationMs;\n    this.sweepIntervalMs = this.options.sweepIntervalMs;\n    this.workerEnabled = this.options.worker;\n\n    // Pending loadMarker requests: Map<requestId, { resolve, reject }>\n    this._pendingMarkerLoads = new Map();\n    this._nextLoadRequestId = 0;\n\n    // Track worker readiness (used by examples to avoid UI race)\n    this.workerReady = false;\n\n    this.version = ARTOOLKIT_PLUGIN_VERSION;\n  }\n\n  /**\n   * Initialize the plugin with the engine core.\n   *\n   * Stores the core reference and prepares the plugin.\n   * Heavy initialization (worker setup) is deferred to enable().\n   *\n   * @param {Object} core - Engine core with eventBus\n   * @param {Object} core.eventBus - Event bus for plugin communication\n   * @returns {Promise<ArtoolkitPlugin>} This plugin instance\n   */\n  async init(core) {\n    this.core = core;\n    // Nothing heavy here; defer worker setup to enable()\n    console.log(\n      `[ArtoolkitPlugin] ${this.version} Initialized with core`,\n      core,\n    );\n    return this;\n  }\n\n  /**\n   * Enable the plugin and start marker detection.\n   *\n   * - Subscribes to engine:update events for frame processing\n   * - Starts the detection worker (if workerEnabled)\n   * - Begins marker sweep interval for lost-marker detection\n   *\n   * @returns {Promise<ArtoolkitPlugin>} This plugin instance\n   * @throws {Error} If plugin not initialized via init()\n   */\n  async enable() {\n    if (!this.core) throw new Error(\"Plugin not initialized\");\n    if (this.enabled) return this;\n    this.enabled = true;\n\n    // subscribe to engine update to send frames to worker\n    this.core.eventBus.on(\"engine:update\", this._onEngineUpdate);\n\n    // start worker if configured\n    if (this.workerEnabled) {\n      await this._startWorker();\n    }\n\n    // start a simple interval to sweep lost markers by time computed from frameDurationMs\n    this._sweepInterval = setInterval(\n      () => this._sweepMarkers(),\n      this.sweepIntervalMs,\n    );\n    return this;\n  }\n\n  /**\n   * Disable the plugin and stop marker detection.\n   *\n   * - Unsubscribes from engine:update events\n   * - Stops and terminates the detection worker\n   * - Clears the marker sweep interval\n   *\n   * @returns {Promise<ArtoolkitPlugin>} This plugin instance\n   */\n  async disable() {\n    if (!this.enabled) return this;\n    this.enabled = false;\n\n    this.core.eventBus.off(\"engine:update\", this._onEngineUpdate);\n\n    if (this._worker) {\n      this._stopWorker();\n    }\n\n    if (this._sweepInterval) {\n      clearInterval(this._sweepInterval);\n      this._sweepInterval = null;\n    }\n\n    return this;\n  }\n\n  /**\n   * Dispose of the plugin and clean up resources.\n   *\n   * Alias for disable() - stops detection and terminates worker.\n   *\n   * @returns {Promise<ArtoolkitPlugin>} This plugin instance\n   */\n  dispose() {\n    return this.disable();\n  }\n\n  /**\n   * Engine frame update handler - forwards frames to the worker for processing.\n   *\n   * Receives frame data from the capture system and sends it to the detection worker.\n   * In browsers, uses transferable ImageBitmap for zero-copy performance.\n   *\n   * @param {Object} frame - Frame data from capture system\n   * @param {number} frame.id - Frame identifier\n   * @param {number} frame.timestamp - Frame timestamp\n   * @param {ImageBitmap} [frame.imageBitmap] - Browser-only transferable image data\n   * @param {number} frame.width - Frame width in pixels\n   * @param {number} frame.height - Frame height in pixels\n   * @param {*} [frame.sourceRef] - Optional reference to source\n   *\n   * @private\n   * @note After ImageBitmap transfer, the main thread's bitmap is neutered and cannot be reused\n   */\n  _onEngineUpdate(frame) {\n    // frame is expected to be an object provided by the capture system, e.g.:\n    // { id: number, timestamp, imageBitmap?, width, height, sourceRef }\n    if (!frame) return;\n\n    // If the frame contains an ImageBitmap (browser), transfer it to the worker for zero-copy processing.\n    if (this._worker && frame.imageBitmap) {\n      try {\n        // Browser Worker supports transfer list; Node worker_threads supports postMessage but not ImageBitmap.\n        if (typeof Worker !== \"undefined\") {\n          // Browser: use transferable ImageBitmap\n          // The browser worker will receive event.data.payload.imageBitmap\n          this._worker.postMessage(\n            {\n              type: \"processFrame\",\n              payload: {\n                frameId: frame.id,\n                imageBitmap: frame.imageBitmap,\n                width: frame.width,\n                height: frame.height,\n              },\n            },\n            // transfer list: ImageBitmap is transferable\n            [frame.imageBitmap],\n          );\n          // After transfer, the main thread's ImageBitmap is neutered; consumer should not reuse it.\n        } else {\n          // Node: ImageBitmap isn't available/transferable; fall back to sending metadata or ArrayBuffer if provided\n          this._worker.postMessage({\n            type: \"processFrame\",\n            payload: {\n              frameId: frame.id,\n              width: frame.width,\n              height: frame.height,\n            },\n          });\n        }\n      } catch (err) {\n        console.warn(\n          \"Artoolkit worker postMessage (ImageBitmap) failed, falling back to frameId only\",\n          err,\n        );\n        try {\n          this._worker.postMessage({\n            type: \"processFrame\",\n            payload: { frameId: frame.id },\n          });\n        } catch (e) {\n          console.warn(\"worker postMessage failed\", e);\n        }\n      }\n      return;\n    }\n\n    // No ImageBitmap: send lighter payload as before (frameId)\n    if (this._worker) {\n      try {\n        this._worker.postMessage({\n          type: \"processFrame\",\n          payload: { frameId: frame.id },\n        });\n      } catch (err) {\n        console.warn(\"Artoolkit worker postMessage failed\", err);\n      }\n    }\n  }\n\n  /**\n   * Start the detection worker (cross-platform).\n   *\n   * Creates and initializes a Web Worker (browser) or worker_threads.Worker (Node.js).\n   * Attaches message handlers and sends initial configuration to the worker.\n   *\n   * **Browser:** Uses `new Worker(new URL(...), { type: 'module' })`\n   * **Node.js:** Uses `worker_threads.Worker` with file path resolution\n   *\n   * Sends init message with:\n   * - artoolkitModuleUrl: Custom ARToolKit module URL\n   * - cameraParametersUrl: Camera calibration parameters\n   * - wasmBaseUrl: Base URL for WASM files\n   *\n   * Includes watchdog timer to resend init if worker doesn't respond within 500ms.\n   *\n   * @private\n   * @returns {Promise<void>}\n   */\n  async _startWorker() {\n    if (this._worker) return;\n\n    // Browser environment: global Worker exists\n    if (typeof Worker !== \"undefined\") {\n      // Works in browsers and bundlers that support new URL(...) for workers\n      this._worker = new Worker(\n        new URL(\"./worker/worker.js\", import.meta.url),\n        { type: \"module\" },\n      );\n    } else {\n      // Node environment: use worker_threads.Worker\n      const { Worker: NodeWorker } = await import(\"node:worker_threads\");\n      const workerUrl = new URL(\"./worker/worker.js\", import.meta.url);\n      const { fileURLToPath } = await import(\"node:url\");\n      const workerPath = fileURLToPath(workerUrl);\n      this._worker = new NodeWorker(workerPath, { type: \"module\" });\n    }\n\n    // Attach message handler (same for both environments)\n    if (this._worker.addEventListener) {\n      this._worker.addEventListener(\"message\", this._onWorkerMessage);\n    } else if (this._worker.on) {\n      this._worker.on(\"message\", this._onWorkerMessage);\n    }\n\n    // If worker supports postMessage init, send init\n    try {\n      this._worker.postMessage?.({\n        type: \"init\",\n        payload: {\n          moduleUrl: this.options.artoolkitModuleUrl || null,\n          cameraParametersUrl: this.options.cameraParametersUrl || null,\n          wasmBaseUrl: this.options.wasmBaseUrl || null,\n        },\n      });\n      // Watchdog: if 'ready' wasn’t received shortly, resend a no-op init once\n      setTimeout(() => {\n        if (!this.workerReady) {\n          try {\n            this._worker?.postMessage?.({ type: \"init\", payload: {} });\n          } catch {}\n        }\n      }, 500);\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  /**\n   * Stop and terminate the detection worker.\n   *\n   * Removes message event handlers and terminates the worker thread.\n   * Works for both browser Workers and Node.js worker_threads.\n   *\n   * @private\n   */\n  _stopWorker() {\n    if (!this._worker) return;\n\n    // Remove handler\n    if (this._worker.removeEventListener) {\n      this._worker.removeEventListener(\"message\", this._onWorkerMessage);\n    } else if (this._worker.off) {\n      this._worker.off(\"message\", this._onWorkerMessage);\n    }\n\n    try {\n      if (typeof Worker !== \"undefined\") {\n        this._worker.terminate();\n      } else {\n        this._worker.terminate?.();\n      }\n    } catch (e) {\n      // ignore\n    }\n    this._worker = null;\n  }\n\n  /**\n   * Apply detection results and emit appropriate marker events.\n   *\n   * Normalizes detection data and determines whether to emit markerFound or markerUpdated.\n   * Updates internal marker tracking state (lastSeen, visible, lostCount).\n   *\n   * **Event Logic:**\n   * - First detection or previously invisible → emits `ar:markerFound`\n   * - Already visible → emits `ar:markerUpdated`\n   *\n   * @param {Array<Object>} detections - Array of detection results from worker\n   * @param {number} detections[].id - Marker ID\n   * @param {Array<number>} detections[].poseMatrix - 16-element pose matrix\n   * @param {number} [detections[].confidence=0] - Detection confidence (0-1)\n   * @param {Array<Array<number>>} [detections[].corners=[]] - Marker corner coordinates\n   *\n   * @private\n   */\n  _applyDetections(detections) {\n    if (!detections || !Array.isArray(detections)) return;\n    for (const d of detections) {\n      const id = d?.id;\n      if (id === null || id === undefined) continue;\n\n      const now = Date.now();\n      const poseMatrix = new Float32Array(d.poseMatrix || []);\n      const confidence = d.confidence ?? 0;\n      const corners = d.corners ?? [];\n\n      const prev = this._markers.get(id);\n      if (!prev || !prev.visible) {\n        this._markers.set(id, { lastSeen: now, visible: true, lostCount: 0 });\n        this.core?.eventBus?.emit(\"ar:markerFound\", {\n          id,\n          poseMatrix,\n          confidence,\n          corners,\n          timestamp: now,\n        });\n      } else {\n        prev.lastSeen = now;\n        prev.lostCount = 0;\n        this._markers.set(id, prev);\n        this.core?.eventBus?.emit(\"ar:markerUpdated\", {\n          id,\n          poseMatrix,\n          confidence,\n          corners,\n          timestamp: now,\n        });\n      }\n    }\n  }\n\n  /**\n   * Handle messages from the detection worker.\n   *\n   * Processes different message types and routes them appropriately:\n   * - `ready`: Worker initialized, sets workerReady flag\n   * - `detectionResult`: Normalized detection data, applies via _applyDetections\n   * - `getMarker`: AR.js-style marker event, forwards to event bus and converts to detection\n   * - `loadMarkerResult`: Response to loadMarker request, resolves/rejects promise\n   * - `error`: Worker error, emits ar:workerError event\n   *\n   * **Cross-platform handling:**\n   * - Browser workers wrap messages in `event.data`\n   * - Node.js worker_threads pass raw payload\n   *\n   * @param {Object|MessageEvent} ev - Message event from worker\n   * @param {Object} [ev.data] - Message data (browser workers)\n   * @param {string} ev.data.type - Message type\n   * @param {*} ev.data.payload - Message payload\n   *\n   * @private\n   */\n  _onWorkerMessage(ev) {\n    // worker_threads messages arrive as the raw payload; browser workers wrap in event.data\n    const data = ev && ev.data !== undefined ? ev.data : ev;\n    const { type, payload } = data || {};\n    if (type === \"ready\") {\n      console.log(\"[Plugin] Worker ready\");\n      this.workerReady = true;\n      this.core?.eventBus?.emit(\"ar:workerReady\", {});\n    } else if (type === \"detectionResult\") {\n      console.log(\"[Plugin] Received detectionResult:\", payload);\n      // Normalize to marker events\n      if (!payload || !Array.isArray(payload.detections)) return;\n      this._applyDetections(payload.detections);\n    } else if (type === \"getMarker\") {\n      // Forward AR.js-style getMarker payload (emitted by the worker) to the app/event bus\n      try {\n        console.log(\"[Plugin] getMarker\", payload);\n      } catch (_) {}\n      this.core?.eventBus?.emit(\"ar:getMarker\", payload);\n\n      // ALSO translate this getMarker into a detection to drive markerFound/Updated\n      try {\n        const m = payload?.marker || {};\n        const id = m.idPatt ?? m.patternId ?? m.pattern_id ?? null;\n\n        // Matrix normalization\n        let poseArray = null;\n        if (Array.isArray(payload?.matrix)) {\n          poseArray = payload.matrix.slice(0, 16);\n        } else if (\n          payload?.matrix &&\n          typeof payload.matrix.length === \"number\"\n        ) {\n          poseArray = Array.from(payload.matrix).slice(0, 16);\n        }\n\n        // Corners/vertex normalization (optional)\n        let corners = [];\n        const v = m.vertex;\n        if (Array.isArray(v)) {\n          // vertex may be [x0,y0,x1,y1,...]\n          for (let i = 0; i + 1 < v.length; i += 2) {\n            corners.push([v[i], v[i + 1]]);\n          }\n        }\n\n        const confidence = m.cfPatt ?? m.confidence ?? 0;\n\n        if (id != null && poseArray && poseArray.length === 16) {\n          this._applyDetections([\n            {\n              id,\n              confidence,\n              poseMatrix: poseArray,\n              corners,\n            },\n          ]);\n        }\n      } catch (e) {\n        // ignore conversion errors; raw getMarker still forwarded\n      }\n    } else if (type === \"loadMarkerResult\") {\n      console.log(\"[Plugin] Received loadMarkerResult:\", payload);\n      const { requestId, ok, error, markerId, size } = payload || {};\n\n      if (requestId !== undefined) {\n        const pending = this._pendingMarkerLoads.get(requestId);\n        if (pending) {\n          this._pendingMarkerLoads.delete(requestId);\n          if (ok) {\n            pending.resolve({ markerId, size });\n          } else {\n            pending.reject(new Error(error || \"Failed to load marker\"));\n          }\n        }\n      }\n    } else if (type === \"error\") {\n      console.error(\"Artoolkit worker error\", payload);\n      this.core?.eventBus?.emit(\"ar:workerError\", payload);\n    }\n  }\n\n  /**\n   * Internal sweep to detect and emit lost markers.\n   *\n   * Checks all tracked markers against the lost threshold.\n   * Markers not seen recently are removed and ar:markerLost is emitted.\n   *\n   * @private\n   */\n  _sweepMarkers() {\n    const now = Date.now();\n    const lostThresholdMs = this.lostThreshold * this.frameDurationMs;\n    for (const [id, state] of this._markers.entries()) {\n      const deltaMs = now - (state.lastSeen || 0);\n      if (deltaMs > lostThresholdMs) {\n        this._markers.delete(id);\n        this.core.eventBus.emit(\"ar:markerLost\", { id, timestamp: now });\n      }\n    }\n  }\n\n  /**\n   * Get the current tracking state of a marker.\n   *\n   * @param {number} markerId - Marker ID to query\n   * @returns {Object|null} Marker state object with lastSeen, visible, lostCount, or null if not tracked\n   *\n   * @example\n   * const state = plugin.getMarkerState(42);\n   * if (state && state.visible) {\n   *   console.log('Marker 42 last seen:', state.lastSeen);\n   * }\n   */\n  getMarkerState(markerId) {\n    return this._markers.get(markerId) || null;\n  }\n\n  /**\n   * Load a pattern marker from a URL\n   * @param {string} patternUrl - URL to the pattern file (absolute or repo-relative)\n   * @param {number} size - Size of the marker in world units (default: 1)\n   * @returns {Promise<{markerId: number, size: number}>} - Resolves with marker info when loaded\n   */\n  async loadMarker(patternUrl, size = 1) {\n    if (!this._worker) {\n      throw new Error(\n        \"Worker not available. Ensure plugin is enabled and worker is running.\",\n      );\n    }\n\n    console.log(`[Plugin] Loading marker: ${patternUrl} with size ${size}`);\n\n    return new Promise((resolve, reject) => {\n      const requestId = this._nextLoadRequestId++;\n      this._pendingMarkerLoads.set(requestId, { resolve, reject });\n\n      // Send loadMarker message to worker\n      try {\n        this._worker.postMessage({\n          type: \"loadMarker\",\n          payload: { patternUrl, size, requestId },\n        });\n      } catch (err) {\n        this._pendingMarkerLoads.delete(requestId);\n        reject(new Error(`Failed to send loadMarker message: ${err.message}`));\n      }\n\n      // Set a timeout to prevent hanging promises\n      setTimeout(() => {\n        if (this._pendingMarkerLoads.has(requestId)) {\n          this._pendingMarkerLoads.delete(requestId);\n          reject(new Error(\"loadMarker request timed out\"));\n        }\n      }, 10000); // 10 second timeout\n    });\n  }\n}\n\n/**\n * @typedef {import(\"../types/plugin\").ArtoolkitPluginOptions} ArtoolkitPluginOptions\n * @typedef {import(\"../types/plugin\").EngineCore} EngineCore\n * @typedef {import(\"../types/plugin\").EngineEventBus} EngineEventBus\n */\n","/**\n * @fileoverview Matrix conversion utilities for ARToolKit ↔ Three.js transformations\n *\n * Provides coordinate system conversion helpers for transforming ARToolKit\n * modelView matrices into Three.js-compatible matrix format.\n */\n\n/**\n * Converts an ARToolKit modelView matrix to Three.js Matrix4 compatible format.\n *\n * ARToolKit and Three.js may use different coordinate conventions (row-major vs column-major).\n * This function handles the transformation to ensure proper rendering in Three.js scenes.\n *\n * @param {Float32Array|Array<number>} modelViewArray - 16-element matrix from ARToolKit\n *        representing the marker's pose in camera space\n * @returns {Float32Array} 16-element matrix ready for THREE.Matrix4.fromArray()\n *\n * @example\n * const arMatrix = new Float32Array(16); // from ARToolKit detection\n * const threeMatrix = convertModelViewToThreeMatrix(arMatrix);\n * threeObject.matrix.fromArray(threeMatrix);\n *\n * @note Concrete conversion logic will be refined when fully integrating artoolkit5-js\n */\nexport function convertModelViewToThreeMatrix(modelViewArray) {\n  const out = new Float32Array(16);\n  // TODO: Apply coordinate system transformation if needed\n  // Currently passes through; adjust based on artoolkit5-js conventions\n  for (let i = 0; i < 16; i++) out[i] = modelViewArray[i];\n  return out;\n}\n"],"names":["ARTOOLKIT_PLUGIN_VERSION","ArtoolkitPlugin","options","core","frame","err","e","NodeWorker","__viteBrowserExternal","workerUrl","fileURLToPath","workerPath","detections","d","id","now","poseMatrix","confidence","corners","prev","ev","data","type","payload","m","poseArray","v","i","requestId","ok","error","markerId","size","pending","lostThresholdMs","state","patternUrl","resolve","reject","convertModelViewToThreeMatrix","modelViewArray","out"],"mappings":"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"}