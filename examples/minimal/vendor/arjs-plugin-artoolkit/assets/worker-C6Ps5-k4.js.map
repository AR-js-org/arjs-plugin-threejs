{"version":3,"file":"worker-C6Ps5-k4.js","sources":["../src/worker/worker.js"],"sourcesContent":["/**\n * @fileoverview ARToolKit Detection Worker\n *\n * Cross-platform web worker for marker detection using ARToolKit.\n * Runs marker tracking off the main thread for optimal performance.\n *\n * **Browser Path:**\n * - Receives ImageBitmap via transferable objects (zero-copy)\n * - Draws to OffscreenCanvas for processing\n * - Runs ARToolKit.process() on canvas/ImageData\n * - Forwards filtered getMarker events to main thread\n *\n * **Features:**\n * - Lazy initialization with exponential backoff on failures\n * - Marker loading and deduplication by pattern URL\n * - Confidence-based filtering (configurable via init)\n * - Selective event forwarding for tracked pattern IDs only\n *\n * **Message Protocol:**\n * - `init`: Configure worker (moduleUrl, cameraParametersUrl, wasmBaseUrl, minConfidence)\n * - `loadMarker`: Load a pattern marker by URL\n * - `processFrame`: Process ImageBitmap for marker detection\n *\n * **Emitted Events:**\n * - `ready`: Worker initialized and ready\n * - `getMarker`: Filtered marker detection event\n * - `loadMarkerResult`: Result of loadMarker request\n * - `error`: Error occurred during processing\n *\n * @module worker/worker\n */\n\nlet arController = null;\nlet arControllerInitialized = false;\nlet getMarkerForwarderAttached = false;\n\nlet offscreenCanvas = null;\nlet offscreenCtx = null;\nlet canvasW = 0;\nlet canvasH = 0;\n\n// Marker and filtering state\nconst loadedMarkers = new Map(); // patternUrl -> markerId\nconst loadingMarkers = new Map(); // patternUrl -> Promise<markerId>\nconst trackedPatternIds = new Set(); // Set<number>\nlet PATTERN_MARKER_TYPE = 0; // will be read from ARToolkit if available\nlet MIN_CONFIDENCE = 0.6; // configurable via init payload\n\n// Init backoff state\nlet initInProgress = null;\nlet initFailCount = 0;\nlet initFailedUntil = 0;\n\n// Init-time options (overridable from main thread)\nlet INIT_OPTS = {\n  moduleUrl: null,\n  cameraParametersUrl: null,\n  wasmBaseUrl: null,\n  minConfidence: null,\n};\n\n// Announce-ready guard\nlet hasAnnouncedReady = false;\n\n/**\n * Cross-platform message listener registration.\n *\n * Attaches a message handler for the worker's message events.\n * Normalizes browser worker message events (extracts ev.data).\n *\n * @param {Function} fn - Handler function receiving message data\n * @private\n */\nfunction onMessage(fn) {\n  // Browser worker path\n  self.addEventListener(\"message\", (ev) => fn(ev.data));\n}\n\n/**\n * Send a message to the main thread.\n *\n * @param {Object} msg - Message object to send\n * @param {string} msg.type - Message type identifier\n * @param {*} [msg.payload] - Optional message payload\n * @private\n */\nfunction sendMessage(msg) {\n  self.postMessage(msg);\n}\n\n/**\n * Serialize AR.js-style getMarker event into a transferable payload.\n *\n * Converts the marker event into a plain object that can be sent via postMessage,\n * extracting matrix, marker properties, and vertex data.\n *\n * @param {Object} ev - Raw getMarker event from ARToolKit\n * @returns {Object} Serialized payload with type, matrix, and marker properties\n * @private\n */\nfunction serializeGetMarkerEvent(ev) {\n  try {\n    const data = ev?.data || {};\n    const marker = data.marker || {};\n    const matrix = Array.isArray(data.matrix)\n      ? data.matrix.slice(0, 16)\n      : data.matrix && data.matrix.length\n        ? Array.from(data.matrix).slice(0, 16)\n        : null;\n    const vertex = marker.vertex\n      ? Array.isArray(marker.vertex)\n        ? marker.vertex.slice()\n        : null\n      : marker.corners\n        ? marker.corners.flatMap((c) => [c.x ?? c[0], c.y ?? c[1]])\n        : null;\n\n    return {\n      type: data.type, // e.g., ARToolkit.PATTERN_MARKER\n      matrix,\n      marker: {\n        idPatt: marker.idPatt ?? marker.patternId ?? marker.pattern_id ?? null,\n        idMatrix: marker.idMatrix ?? null,\n        cfPatt: marker.cfPatt ?? marker.confidence ?? null,\n        cfMatrix: marker.cfMatrix ?? null,\n        vertex: vertex || null,\n      },\n    };\n  } catch {\n    return { type: null, matrix: null, marker: {} };\n  }\n}\n\n/**\n * Filter function to determine if a marker event should be forwarded to main thread.\n *\n * Applies multiple filters:\n * - Type must match PATTERN_MARKER\n * - Confidence must meet MIN_CONFIDENCE threshold\n * - Matrix must exist with 16+ values\n * - If tracking specific IDs, marker ID must be in trackedPatternIds\n *\n * @param {Object} event - Marker event from ARToolKit\n * @returns {boolean} True if event should be forwarded\n * @private\n */\nfunction shouldForwardGetMarker(event) {\n  const data = event?.data || {};\n  const type = data.type;\n  const marker = data.marker || {};\n  const id = marker.idPatt ?? marker.patternId ?? marker.pattern_id ?? null;\n  const conf = marker.cfPatt ?? marker.confidence ?? 0;\n  const matrix = data.matrix;\n\n  // Type must be PATTERN_MARKER (fallback numeric 0 if constants not available)\n  if (type !== PATTERN_MARKER_TYPE) return false;\n\n  // Confidence gate\n  if (!(Number.isFinite(conf) && conf >= MIN_CONFIDENCE)) return false;\n\n  // Matrix must exist with at least 16 values\n  const m = Array.isArray(matrix)\n    ? matrix\n    : (matrix && Array.from(matrix)) || null;\n  if (!m || m.length < 16) return false;\n\n  // If we have tracked IDs, only forward those IDs\n  if (trackedPatternIds.size && id != null && !trackedPatternIds.has(id))\n    return false;\n\n  return true;\n}\n\n/**\n * Attach a filtered event forwarder to ARController's getMarker events.\n *\n * Sets up a listener that filters marker events based on confidence, type,\n * and tracked pattern IDs before forwarding to the main thread.\n *\n * Only attaches once (guarded by getMarkerForwarderAttached flag).\n *\n * @private\n */\nfunction attachGetMarkerForwarder() {\n  if (\n    !arController ||\n    typeof arController.addEventListener !== \"function\" ||\n    getMarkerForwarderAttached\n  )\n    return;\n  arController.addEventListener(\"getMarker\", (event) => {\n    if (!shouldForwardGetMarker(event)) return;\n    const payload = serializeGetMarkerEvent(event);\n    try {\n      console.log(\"[Worker] getMarker (filtered)\", payload);\n    } catch {}\n    sendMessage({ type: \"getMarker\", payload });\n  });\n  getMarkerForwarderAttached = true;\n}\n\n/**\n * Initialize ARToolKit with exponential backoff on failures.\n *\n * Loads the ARToolKit module, configures it with init options,\n * creates an ARController, and attaches the getMarker event forwarder.\n *\n * **Backoff Strategy:**\n * - On failure, delays retry with exponential backoff (up to 30 seconds)\n * - Prevents repeated initialization attempts when library is unavailable\n *\n * @param {number} [width=640] - Video/canvas width for ARController\n * @param {number} [height=480] - Video/canvas height for ARController\n * @returns {Promise<boolean>} True if initialized successfully\n * @private\n */\nasync function initArtoolkit(width = 640, height = 480) {\n  if (arControllerInitialized) return true;\n\n  const now = Date.now();\n  if (now < initFailedUntil) {\n    const waitMs = initFailedUntil - now;\n    console.warn(\"[Worker] initArtoolkit skipped due to backoff (ms):\", waitMs);\n    return false;\n  }\n\n  if (initInProgress) {\n    try {\n      await initInProgress;\n      return arControllerInitialized;\n    } catch {\n      return false;\n    }\n  }\n\n  initInProgress = (async () => {\n    try {\n      const jsartoolkit = await (async () => {\n        if (INIT_OPTS.moduleUrl) {\n          console.log(\n            \"[Worker] Loading artoolkit from moduleUrl:\",\n            INIT_OPTS.moduleUrl,\n          );\n          return await import(INIT_OPTS.moduleUrl);\n        }\n        // If your environment supports bare import (import map/bundler), this will work:\n        return await import(\"@ar-js-org/artoolkit5-js\");\n      })();\n\n      // Safely extract exports (supports both named and default exports)\n      const ARController =\n        jsartoolkit.ARController ?? jsartoolkit.default?.ARController;\n      const ARToolkit = jsartoolkit.ARToolkit ?? jsartoolkit.default?.ARToolkit;\n\n      if (!ARController) {\n        throw new Error(\"ARController export not found in ARToolKit module\");\n      }\n\n      // Read the constant if available; else keep default 0\n      if (ARToolkit && typeof ARToolkit.PATTERN_MARKER === \"number\") {\n        PATTERN_MARKER_TYPE = ARToolkit.PATTERN_MARKER;\n      }\n\n      if (INIT_OPTS.wasmBaseUrl && ARController) {\n        try {\n          ARController.baseURL = INIT_OPTS.wasmBaseUrl.endsWith(\"/\")\n            ? INIT_OPTS.wasmBaseUrl\n            : INIT_OPTS.wasmBaseUrl + \"/\";\n        } catch {}\n      }\n\n      if (typeof INIT_OPTS.minConfidence === \"number\") {\n        MIN_CONFIDENCE = INIT_OPTS.minConfidence;\n      }\n\n      const camUrl =\n        INIT_OPTS.cameraParametersUrl ||\n        \"https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat\";\n\n      console.log(\"[Worker] ARToolKit init\", {\n        width,\n        height,\n        camUrl,\n        minConfidence: MIN_CONFIDENCE,\n        patternType: PATTERN_MARKER_TYPE,\n      });\n      arController = await ARController.initWithDimensions(\n        width,\n        height,\n        camUrl,\n        {},\n      );\n      arControllerInitialized = !!arController;\n      console.log(\"[Worker] ARToolKit initialized:\", arControllerInitialized);\n\n      if (!arControllerInitialized)\n        throw new Error(\n          \"ARController.initWithDimensions returned falsy controller\",\n        );\n\n      attachGetMarkerForwarder();\n\n      initFailCount = 0;\n      initFailedUntil = 0;\n    } catch (err) {\n      console.error(\"[Worker] ARToolKit init failed:\", err);\n      arController = null;\n      arControllerInitialized = false;\n\n      initFailCount = Math.min(initFailCount + 1, 6);\n      const delay = Math.min(30000, 1000 * Math.pow(2, initFailCount));\n      initFailedUntil = Date.now() + delay;\n\n      sendMessage({\n        type: \"error\",\n        payload: {\n          message: `ARToolKit init failed (${err?.message || err}). Retrying in ${delay}ms.`,\n        },\n      });\n      throw err;\n    } finally {\n      initInProgress = null;\n    }\n  })();\n\n  try {\n    await initInProgress;\n  } catch {}\n  return arControllerInitialized;\n}\n\n/**\n * Load a pattern marker, deduplicating requests by URL.\n *\n * Ensures each pattern URL is loaded only once, even if requested multiple times.\n * Tracks the loaded marker ID in trackedPatternIds for event filtering.\n *\n * @param {string} patternUrl - URL to the pattern file (.patt)\n * @returns {Promise<number>} Marker ID assigned by ARToolKit\n * @throws {Error} If marker loading fails\n * @private\n */\nasync function loadPatternOnce(patternUrl) {\n  if (loadedMarkers.has(patternUrl)) return loadedMarkers.get(patternUrl);\n  if (loadingMarkers.has(patternUrl)) return loadingMarkers.get(patternUrl);\n\n  const p = (async () => {\n    const id = await arController.loadMarker(patternUrl);\n    loadedMarkers.set(patternUrl, id);\n    trackedPatternIds.add(id);\n    loadingMarkers.delete(patternUrl);\n    return id;\n  })().catch((e) => {\n    loadingMarkers.delete(patternUrl);\n    throw e;\n  });\n\n  loadingMarkers.set(patternUrl, p);\n  return p;\n}\n\nonMessage(async (ev) => {\n  const { type, payload } = ev || {};\n  try {\n    if (type === \"init\") {\n      if (payload && typeof payload === \"object\") {\n        INIT_OPTS.moduleUrl = payload.moduleUrl ?? INIT_OPTS.moduleUrl;\n        INIT_OPTS.cameraParametersUrl =\n          payload.cameraParametersUrl ?? INIT_OPTS.cameraParametersUrl;\n        INIT_OPTS.wasmBaseUrl = payload.wasmBaseUrl ?? INIT_OPTS.wasmBaseUrl;\n        if (typeof payload.minConfidence === \"number\") {\n          INIT_OPTS.minConfidence = payload.minConfidence;\n          MIN_CONFIDENCE = payload.minConfidence;\n        }\n      }\n      if (!hasAnnouncedReady) {\n        sendMessage({ type: \"ready\" });\n        hasAnnouncedReady = true;\n      }\n      return;\n    }\n\n    if (type === \"loadMarker\") {\n      const { patternUrl, size = 1, requestId } = payload || {};\n      if (!patternUrl) {\n        sendMessage({\n          type: \"loadMarkerResult\",\n          payload: {\n            ok: false,\n            error: \"Missing patternUrl parameter\",\n            requestId,\n          },\n        });\n        return;\n      }\n      try {\n        const ok = await initArtoolkit(640, 480);\n        if (!ok) throw new Error(\"ARToolKit not initialized\");\n\n        const markerId = await loadPatternOnce(patternUrl);\n        if (typeof arController.trackPatternMarkerId === \"function\") {\n          arController.trackPatternMarkerId(markerId, size);\n        } else if (typeof arController.trackPatternMarker === \"function\") {\n          arController.trackPatternMarker(markerId, size);\n        }\n        sendMessage({\n          type: \"loadMarkerResult\",\n          payload: { ok: true, markerId, size, requestId },\n        });\n      } catch (err) {\n        console.error(\"[Worker] loadMarker error:\", err);\n        sendMessage({\n          type: \"loadMarkerResult\",\n          payload: { ok: false, error: err?.message || String(err), requestId },\n        });\n      }\n      return;\n    }\n\n    if (type === \"processFrame\") {\n      const { imageBitmap, width, height } = payload || {};\n      if (imageBitmap) {\n        try {\n          const w = width || imageBitmap.width || 640;\n          const h = height || imageBitmap.height || 480;\n\n          await initArtoolkit(w, h);\n\n          if (!offscreenCanvas || canvasW !== w || canvasH !== h) {\n            canvasW = w;\n            canvasH = h;\n            offscreenCanvas = new OffscreenCanvas(canvasW, canvasH);\n            offscreenCtx = offscreenCanvas.getContext(\"2d\", {\n              willReadFrequently: true,\n            });\n          }\n\n          offscreenCtx.clearRect(0, 0, canvasW, canvasH);\n          offscreenCtx.drawImage(imageBitmap, 0, 0, canvasW, canvasH);\n          try {\n            imageBitmap.close?.();\n          } catch {}\n\n          if (arControllerInitialized && arController) {\n            try {\n              arController.process(offscreenCanvas);\n            } catch (e) {\n              try {\n                const imgData = offscreenCtx.getImageData(\n                  0,\n                  0,\n                  canvasW,\n                  canvasH,\n                );\n                arController.process(imgData);\n              } catch (inner) {\n                console.warn(\n                  \"[Worker] ARToolKit process fallback failed:\",\n                  inner,\n                );\n              }\n            }\n          }\n        } catch (err) {\n          console.error(\"[Worker] processFrame error:\", err);\n        }\n        return;\n      }\n\n      // Non-ImageBitmap path: noop\n      await new Promise((r) => setTimeout(r, 5));\n      return;\n    }\n  } catch (err) {\n    sendMessage({\n      type: \"error\",\n      payload: { message: err?.message || String(err) },\n    });\n  }\n});\n\n// Announce ready right after load, in case 'init' is delayed\ntry {\n  if (!hasAnnouncedReady) {\n    sendMessage({ type: \"ready\" });\n    hasAnnouncedReady = true;\n  }\n} catch {}\n"],"names":["arController","arControllerInitialized","getMarkerForwarderAttached","offscreenCanvas","offscreenCtx","canvasW","canvasH","loadedMarkers","loadingMarkers","trackedPatternIds","PATTERN_MARKER_TYPE","MIN_CONFIDENCE","initInProgress","initFailCount","initFailedUntil","INIT_OPTS","hasAnnouncedReady","onMessage","fn","ev","sendMessage","msg","serializeGetMarkerEvent","data","marker","matrix","vertex","c","shouldForwardGetMarker","event","type","id","conf","m","attachGetMarkerForwarder","payload","initArtoolkit","width","height","now","waitMs","jsartoolkit","n","ARController","ARToolkit","camUrl","err","delay","loadPatternOnce","patternUrl","p","size","requestId","markerId","imageBitmap","w","h","imgData","inner","r"],"mappings":"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"}