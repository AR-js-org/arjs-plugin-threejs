{"version":3,"file":"worker-NSCgfIFP.js","sources":["../src/worker/worker.js"],"sourcesContent":["// Cross-platform worker integrating ARToolKit in browser Workers.\r\n// - Browser: processes ImageBitmap → OffscreenCanvas → ARToolKit.process(canvas)\r\n// Note: Node path removed for now to keep browser worker startup robust.\r\nlet arController = null;\r\nlet arControllerInitialized = false;\r\nlet getMarkerForwarderAttached = false;\r\n\r\nlet offscreenCanvas = null;\r\nlet offscreenCtx = null;\r\nlet canvasW = 0;\r\nlet canvasH = 0;\r\n\r\n// Marker and filtering state\r\nconst loadedMarkers = new Map();    // patternUrl -> markerId\r\nconst loadingMarkers = new Map();   // patternUrl -> Promise<markerId>\r\nconst trackedPatternIds = new Set(); // Set<number>\r\nlet PATTERN_MARKER_TYPE = 0;        // will be read from ARToolkit if available\r\nlet MIN_CONFIDENCE = 0.6;           // configurable via init payload\r\n\r\n// Init backoff state\r\nlet initInProgress = null;\r\nlet initFailCount = 0;\r\nlet initFailedUntil = 0;\r\n\r\n// Init-time options (overridable from main thread)\r\nlet INIT_OPTS = {\r\n    moduleUrl: null,\r\n    cameraParametersUrl: null,\r\n    wasmBaseUrl: null,\r\n    minConfidence: null\r\n};\r\n\r\n// Announce-ready guard\r\nlet hasAnnouncedReady = false;\r\n\r\nfunction onMessage(fn) {\r\n    // Browser worker path\r\n    self.addEventListener('message', (ev) => fn(ev.data));\r\n}\r\n\r\nfunction sendMessage(msg) {\r\n    self.postMessage(msg);\r\n}\r\n\r\n// Serialize AR.js-style getMarker event into a transferable payload\r\nfunction serializeGetMarkerEvent(ev) {\r\n    try {\r\n        const data = ev?.data || {};\r\n        const marker = data.marker || {};\r\n        const matrix = Array.isArray(data.matrix) ? data.matrix.slice(0, 16)\r\n            : (data.matrix && data.matrix.length ? Array.from(data.matrix).slice(0, 16) : null);\r\n        const vertex = marker.vertex\r\n            ? (Array.isArray(marker.vertex) ? marker.vertex.slice() : null)\r\n            : (marker.corners ? marker.corners.flatMap(c => [c.x ?? c[0], c.y ?? c[1]]) : null);\r\n\r\n        return {\r\n            type: data.type, // e.g., ARToolkit.PATTERN_MARKER\r\n            matrix,\r\n            marker: {\r\n                idPatt: marker.idPatt ?? marker.patternId ?? marker.pattern_id ?? null,\r\n                idMatrix: marker.idMatrix ?? null,\r\n                cfPatt: marker.cfPatt ?? marker.confidence ?? null,\r\n                cfMatrix: marker.cfMatrix ?? null,\r\n                vertex: vertex || null\r\n            }\r\n        };\r\n    } catch {\r\n        return { type: null, matrix: null, marker: {} };\r\n    }\r\n}\r\n\r\nfunction shouldForwardGetMarker(event) {\r\n    const data = event?.data || {};\r\n    const type = data.type;\r\n    const marker = data.marker || {};\r\n    const id = marker.idPatt ?? marker.patternId ?? marker.pattern_id ?? null;\r\n    const conf = marker.cfPatt ?? marker.confidence ?? 0;\r\n    const matrix = data.matrix;\r\n\r\n    // Type must be PATTERN_MARKER (fallback numeric 0 if constants not available)\r\n    if (type !== PATTERN_MARKER_TYPE) return false;\r\n\r\n    // Confidence gate\r\n    if (!(Number.isFinite(conf) && conf >= MIN_CONFIDENCE)) return false;\r\n\r\n    // Matrix must exist with at least 16 values\r\n    const m = Array.isArray(matrix) ? matrix : (matrix && Array.from(matrix)) || null;\r\n    if (!m || m.length < 16) return false;\r\n\r\n    // If we have tracked IDs, only forward those IDs\r\n    if (trackedPatternIds.size && id != null && !trackedPatternIds.has(id)) return false;\r\n\r\n    return true;\r\n}\r\n\r\nfunction attachGetMarkerForwarder() {\r\n    if (!arController || typeof arController.addEventListener !== 'function' || getMarkerForwarderAttached) return;\r\n    arController.addEventListener('getMarker', (event) => {\r\n        if (!shouldForwardGetMarker(event)) return;\r\n        const payload = serializeGetMarkerEvent(event);\r\n        try { console.log('[Worker] getMarker (filtered)', payload); } catch {}\r\n        sendMessage({ type: 'getMarker', payload });\r\n    });\r\n    getMarkerForwarderAttached = true;\r\n}\r\n\r\n// Guarded init with backoff\r\nasync function initArtoolkit(width = 640, height = 480) {\r\n    if (arControllerInitialized) return true;\r\n\r\n    const now = Date.now();\r\n    if (now < initFailedUntil) {\r\n        const waitMs = initFailedUntil - now;\r\n        console.warn('[Worker] initArtoolkit skipped due to backoff (ms):', waitMs);\r\n        return false;\r\n    }\r\n\r\n    if (initInProgress) {\r\n        try {\r\n            await initInProgress;\r\n            return arControllerInitialized;\r\n        } catch {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    initInProgress = (async () => {\r\n        try {\r\n            const jsartoolkit = await (async () => {\r\n                if (INIT_OPTS.moduleUrl) {\r\n                    console.log('[Worker] Loading artoolkit from moduleUrl:', INIT_OPTS.moduleUrl);\r\n                    return await import(INIT_OPTS.moduleUrl);\r\n                }\r\n                // If your environment supports bare import (import map/bundler), this will work:\r\n                return await import('@ar-js-org/artoolkit5-js');\r\n            })();\r\n\r\n            // Safely extract exports (supports both named and default exports)\r\n            const ARController =\r\n                jsartoolkit.ARController ?? jsartoolkit.default?.ARController;\r\n            const ARToolkit =\r\n                jsartoolkit.ARToolkit ?? jsartoolkit.default?.ARToolkit;\r\n\r\n            if (!ARController) {\r\n                throw new Error('ARController export not found in ARToolKit module');\r\n            }\r\n\r\n            // Read the constant if available; else keep default 0\r\n            if (ARToolkit && typeof ARToolkit.PATTERN_MARKER === 'number') {\r\n                PATTERN_MARKER_TYPE = ARToolkit.PATTERN_MARKER;\r\n            }\r\n\r\n            if (INIT_OPTS.wasmBaseUrl && ARController) {\r\n                try {\r\n                    ARController.baseURL = INIT_OPTS.wasmBaseUrl.endsWith('/') ? INIT_OPTS.wasmBaseUrl : INIT_OPTS.wasmBaseUrl + '/';\r\n                } catch {}\r\n            }\r\n\r\n            if (typeof INIT_OPTS.minConfidence === 'number') {\r\n                MIN_CONFIDENCE = INIT_OPTS.minConfidence;\r\n            }\r\n\r\n            const camUrl = INIT_OPTS.cameraParametersUrl\r\n                || 'https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat';\r\n\r\n            console.log('[Worker] ARToolKit init', { width, height, camUrl, minConfidence: MIN_CONFIDENCE, patternType: PATTERN_MARKER_TYPE });\r\n            arController = await ARController.initWithDimensions(width, height, camUrl, {});\r\n            arControllerInitialized = !!arController;\r\n            console.log('[Worker] ARToolKit initialized:', arControllerInitialized);\r\n\r\n            if (!arControllerInitialized) throw new Error('ARController.initWithDimensions returned falsy controller');\r\n\r\n            attachGetMarkerForwarder();\r\n\r\n            initFailCount = 0;\r\n            initFailedUntil = 0;\r\n        } catch (err) {\r\n            console.error('[Worker] ARToolKit init failed:', err);\r\n            arController = null;\r\n            arControllerInitialized = false;\r\n\r\n            initFailCount = Math.min(initFailCount + 1, 6);\r\n            const delay = Math.min(30000, 1000 * Math.pow(2, initFailCount));\r\n            initFailedUntil = Date.now() + delay;\r\n\r\n            sendMessage({ type: 'error', payload: { message: `ARToolKit init failed (${err?.message || err}). Retrying in ${delay}ms.` } });\r\n            throw err;\r\n        } finally {\r\n            initInProgress = null;\r\n        }\r\n    })();\r\n\r\n    try {\r\n        await initInProgress;\r\n    } catch {}\r\n    return arControllerInitialized;\r\n}\r\n\r\n// Dedupe marker loading by URL and record tracked IDs\r\nasync function loadPatternOnce(patternUrl) {\r\n    if (loadedMarkers.has(patternUrl)) return loadedMarkers.get(patternUrl);\r\n    if (loadingMarkers.has(patternUrl)) return loadingMarkers.get(patternUrl);\r\n\r\n    const p = (async () => {\r\n        const id = await arController.loadMarker(patternUrl);\r\n        loadedMarkers.set(patternUrl, id);\r\n        trackedPatternIds.add(id);\r\n        loadingMarkers.delete(patternUrl);\r\n        return id;\r\n    })().catch((e) => {\r\n        loadingMarkers.delete(patternUrl);\r\n        throw e;\r\n    });\r\n\r\n    loadingMarkers.set(patternUrl, p);\r\n    return p;\r\n}\r\n\r\nonMessage(async (ev) => {\r\n    const { type, payload } = ev || {};\r\n    try {\r\n        if (type === 'init') {\r\n            if (payload && typeof payload === 'object') {\r\n                INIT_OPTS.moduleUrl = payload.moduleUrl ?? INIT_OPTS.moduleUrl;\r\n                INIT_OPTS.cameraParametersUrl = payload.cameraParametersUrl ?? INIT_OPTS.cameraParametersUrl;\r\n                INIT_OPTS.wasmBaseUrl = payload.wasmBaseUrl ?? INIT_OPTS.wasmBaseUrl;\r\n                if (typeof payload.minConfidence === 'number') {\r\n                    INIT_OPTS.minConfidence = payload.minConfidence;\r\n                    MIN_CONFIDENCE = payload.minConfidence;\r\n                }\r\n            }\r\n            if (!hasAnnouncedReady) {\r\n                sendMessage({ type: 'ready' });\r\n                hasAnnouncedReady = true;\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (type === 'loadMarker') {\r\n            const { patternUrl, size = 1, requestId } = payload || {};\r\n            if (!patternUrl) {\r\n                sendMessage({ type: 'loadMarkerResult', payload: { ok: false, error: 'Missing patternUrl parameter', requestId } });\r\n                return;\r\n            }\r\n            try {\r\n                const ok = await initArtoolkit(640, 480);\r\n                if (!ok) throw new Error('ARToolKit not initialized');\r\n\r\n                const markerId = await loadPatternOnce(patternUrl);\r\n                if (typeof arController.trackPatternMarkerId === 'function') {\r\n                    arController.trackPatternMarkerId(markerId, size);\r\n                } else if (typeof arController.trackPatternMarker === 'function') {\r\n                    arController.trackPatternMarker(markerId, size);\r\n                }\r\n                sendMessage({ type: 'loadMarkerResult', payload: { ok: true, markerId, size, requestId } });\r\n            } catch (err) {\r\n                console.error('[Worker] loadMarker error:', err);\r\n                sendMessage({ type: 'loadMarkerResult', payload: { ok: false, error: err?.message || String(err), requestId } });\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (type === 'processFrame') {\r\n            const { imageBitmap, width, height } = payload || {};\r\n            if (imageBitmap) {\r\n                try {\r\n                    const w = width || imageBitmap.width || 640;\r\n                    const h = height || imageBitmap.height || 480;\r\n\r\n                    await initArtoolkit(w, h);\r\n\r\n                    if (!offscreenCanvas || canvasW !== w || canvasH !== h) {\r\n                        canvasW = w; canvasH = h;\r\n                        offscreenCanvas = new OffscreenCanvas(canvasW, canvasH);\r\n                        offscreenCtx = offscreenCanvas.getContext('2d', { willReadFrequently: true });\r\n                    }\r\n\r\n                    offscreenCtx.clearRect(0, 0, canvasW, canvasH);\r\n                    offscreenCtx.drawImage(imageBitmap, 0, 0, canvasW, canvasH);\r\n                    try { imageBitmap.close?.(); } catch {}\r\n\r\n                    if (arControllerInitialized && arController) {\r\n                        try {\r\n                            arController.process(offscreenCanvas);\r\n                        } catch (e) {\r\n                            try {\r\n                                const imgData = offscreenCtx.getImageData(0, 0, canvasW, canvasH);\r\n                                arController.process(imgData);\r\n                            } catch (inner) {\r\n                                console.warn('[Worker] ARToolKit process fallback failed:', inner);\r\n                            }\r\n                        }\r\n                    }\r\n                } catch (err) {\r\n                    console.error('[Worker] processFrame error:', err);\r\n                }\r\n                return;\r\n            }\r\n\r\n            // Non-ImageBitmap path: noop\r\n            await new Promise((r) => setTimeout(r, 5));\r\n            return;\r\n        }\r\n    } catch (err) {\r\n        sendMessage({ type: 'error', payload: { message: err?.message || String(err) } });\r\n    }\r\n});\r\n\r\n// Announce ready right after load, in case 'init' is delayed\r\ntry {\r\n    if (!hasAnnouncedReady) {\r\n        sendMessage({ type: 'ready' });\r\n        hasAnnouncedReady = true;\r\n    }\r\n} catch {}"],"names":["arController","arControllerInitialized","getMarkerForwarderAttached","offscreenCanvas","offscreenCtx","canvasW","canvasH","loadedMarkers","loadingMarkers","trackedPatternIds","PATTERN_MARKER_TYPE","MIN_CONFIDENCE","initInProgress","initFailCount","initFailedUntil","INIT_OPTS","hasAnnouncedReady","onMessage","fn","ev","sendMessage","msg","serializeGetMarkerEvent","data","marker","matrix","vertex","c","shouldForwardGetMarker","event","type","id","conf","m","attachGetMarkerForwarder","payload","initArtoolkit","width","height","now","waitMs","jsartoolkit","ARController","ARToolkit","camUrl","err","delay","loadPatternOnce","patternUrl","p","size","requestId","markerId","imageBitmap","w","h","imgData","inner","r"],"mappings":"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"}