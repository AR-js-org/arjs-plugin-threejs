{"version":3,"file":"arjs-plugin-threejs.js","sources":["../src/threejs-renderer-plugin.js"],"sourcesContent":["import * as THREE from 'three';\n\n/**\n * ThreeJSRendererPlugin - Minimal Three.js renderer plugin for AR.js-core\n * \n * Lifecycle:\n * - init: create renderer, scene, camera\n * - enable: attach renderer to DOM, subscribe to events\n * - disable: remove event listeners\n * - dispose: cleanup Three.js resources\n */\nexport class ThreeJSRendererPlugin {\n  constructor(options = {}) {\n    this.name = 'threejs-renderer';\n    this.engine = null;\n    this.renderer = null;\n    this.scene = null;\n    this.camera = null;\n    this.anchors = new Map();\n    this.containerElement = null;\n    \n    // Store bound event handlers for proper removal\n    this.boundHandleUpdate = null;\n    this.boundHandleMarker = null;\n    this.boundHandleCamera = null;\n    this.boundHandleResize = null;\n    \n    // Store options\n    this.options = {\n      antialias: options.antialias !== undefined ? options.antialias : true,\n      alpha: options.alpha !== undefined ? options.alpha : true,\n      ...options\n    };\n  }\n\n  /**\n   * Initialize the plugin with AR.js engine\n   */\n  init(engine) {\n    this.engine = engine;\n    \n    // Create Three.js renderer\n    this.renderer = new THREE.WebGLRenderer({\n      antialias: this.options.antialias,\n      alpha: this.options.alpha\n    });\n    this.renderer.setPixelRatio(window.devicePixelRatio);\n    this.renderer.setClearColor(0x000000, 0);\n    \n    // Create scene\n    this.scene = new THREE.Scene();\n    \n    // Create camera (AR camera will be configured on ar:camera event)\n    this.camera = new THREE.PerspectiveCamera(\n      60,\n      window.innerWidth / window.innerHeight,\n      0.1,\n      1000\n    );\n    this.camera.position.set(0, 0, 0);\n    \n    console.log('[ThreeJSRendererPlugin] Initialized');\n  }\n\n  /**\n   * Enable the plugin (attach to DOM and subscribe to events)\n   */\n  enable() {\n    if (!this.engine) {\n      throw new Error('Plugin must be initialized before enabling');\n    }\n\n    // Attach renderer to container element or body\n    const container = this.options.container || document.body;\n    this.containerElement = container;\n    container.appendChild(this.renderer.domElement);\n    \n    // Set initial size\n    this.handleResize();\n    \n    // Bind event handlers once and store references\n    this.boundHandleUpdate = this.handleUpdate.bind(this);\n    this.boundHandleMarker = this.handleMarker.bind(this);\n    this.boundHandleCamera = this.handleCamera.bind(this);\n    this.boundHandleResize = this.handleResize.bind(this);\n    \n    // Subscribe to engine events\n    this.engine.on('engine:update', this.boundHandleUpdate);\n    this.engine.on('ar:marker', this.boundHandleMarker);\n    this.engine.on('ar:camera', this.boundHandleCamera);\n    \n    // Handle window resize\n    window.addEventListener('resize', this.boundHandleResize);\n    \n    console.log('[ThreeJSRendererPlugin] Enabled');\n  }\n\n  /**\n   * Disable the plugin (remove event listeners)\n   */\n  disable() {\n    if (!this.engine) return;\n    \n    // Unsubscribe from engine events using stored bound references\n    if (this.boundHandleUpdate) {\n      this.engine.off('engine:update', this.boundHandleUpdate);\n    }\n    if (this.boundHandleMarker) {\n      this.engine.off('ar:marker', this.boundHandleMarker);\n    }\n    if (this.boundHandleCamera) {\n      this.engine.off('ar:camera', this.boundHandleCamera);\n    }\n    \n    // Remove resize listener using stored bound reference\n    if (this.boundHandleResize) {\n      window.removeEventListener('resize', this.boundHandleResize);\n    }\n    \n    // Clear bound references\n    this.boundHandleUpdate = null;\n    this.boundHandleMarker = null;\n    this.boundHandleCamera = null;\n    this.boundHandleResize = null;\n    \n    // Remove renderer from DOM\n    if (this.renderer && this.renderer.domElement && this.renderer.domElement.parentNode) {\n      this.renderer.domElement.parentNode.removeChild(this.renderer.domElement);\n    }\n    \n    console.log('[ThreeJSRendererPlugin] Disabled');\n  }\n\n  /**\n   * Dispose and cleanup all resources\n   */\n  dispose() {\n    this.disable();\n    \n    // Clear anchors\n    this.anchors.forEach((anchor) => {\n      if (anchor.parent) {\n        anchor.parent.remove(anchor);\n      }\n    });\n    this.anchors.clear();\n    \n    // Dispose Three.js resources\n    if (this.renderer) {\n      this.renderer.dispose();\n      this.renderer = null;\n    }\n    \n    if (this.scene) {\n      this.scene = null;\n    }\n    \n    if (this.camera) {\n      this.camera = null;\n    }\n    \n    this.engine = null;\n    \n    console.log('[ThreeJSRendererPlugin] Disposed');\n  }\n\n  /**\n   * Handle engine update event - render the scene\n   */\n  handleUpdate() {\n    if (this.renderer && this.scene && this.camera) {\n      this.renderer.render(this.scene, this.camera);\n    }\n  }\n\n  /**\n   * Handle marker event - create/update marker anchors\n   */\n  handleMarker(event) {\n    const { id, matrix, visible } = event;\n    \n    let anchor = this.anchors.get(id);\n    \n    if (!anchor) {\n      // Create new anchor (Group) for this marker\n      anchor = new THREE.Group();\n      anchor.name = `marker-${id}`;\n      this.scene.add(anchor);\n      this.anchors.set(id, anchor);\n    }\n    \n    // Update visibility\n    anchor.visible = visible;\n    \n    // Update transform matrix if provided\n    if (matrix && Array.isArray(matrix)) {\n      anchor.matrix.fromArray(matrix);\n      anchor.matrix.decompose(anchor.position, anchor.quaternion, anchor.scale);\n    }\n  }\n\n  /**\n   * Handle camera event - update camera projection\n   */\n  handleCamera(event) {\n    if (event.projectionMatrix && Array.isArray(event.projectionMatrix)) {\n      this.setProjectionFromArray(event.projectionMatrix);\n    }\n  }\n\n  /**\n   * Handle window resize\n   */\n  handleResize() {\n    if (!this.renderer || !this.camera) return;\n    \n    const width = window.innerWidth;\n    const height = window.innerHeight;\n    \n    this.renderer.setSize(width, height);\n    this.camera.aspect = width / height;\n    this.camera.updateProjectionMatrix();\n  }\n\n  /**\n   * Set camera projection matrix from array (column-major 4x4)\n   */\n  setProjectionFromArray(array) {\n    if (!this.camera || !Array.isArray(array) || array.length !== 16) {\n      console.warn('[ThreeJSRendererPlugin] Invalid projection matrix');\n      return;\n    }\n    \n    this.camera.projectionMatrix.fromArray(array);\n    this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert();\n  }\n\n  /**\n   * Get Three.js scene for adding custom objects\n   */\n  getScene() {\n    return this.scene;\n  }\n\n  /**\n   * Get Three.js camera\n   */\n  getCamera() {\n    return this.camera;\n  }\n\n  /**\n   * Get Three.js renderer\n   */\n  getRenderer() {\n    return this.renderer;\n  }\n\n  /**\n   * Get anchor by marker ID\n   */\n  getAnchor(markerId) {\n    return this.anchors.get(markerId);\n  }\n}\n"],"names":["ThreeJSRendererPlugin","options","engine","THREE","container","anchor","event","id","matrix","visible","width","height","array","markerId"],"mappings":"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"}