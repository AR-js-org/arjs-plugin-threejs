{"version":3,"file":"arjs-plugin-threejs.js","sources":["../src/threejs-renderer-plugin.js"],"sourcesContent":["import * as THREE from 'three';\r\n\r\n/**\r\n * ThreeJSRendererPlugin - Minimal Three.js renderer plugin for AR.js-core\r\n * \r\n * Lifecycle:\r\n * - init: create renderer, scene, camera\r\n * - enable: attach renderer to DOM, subscribe to events\r\n * - disable: remove event listeners\r\n * - dispose: cleanup Three.js resources\r\n */\r\nexport class ThreeJSRendererPlugin {\r\n  constructor(options = {}) {\r\n    this.name = 'threejs-renderer';\r\n    this.engine = null;\r\n    this.renderer = null;\r\n    this.scene = null;\r\n    this.camera = null;\r\n    this.anchors = new Map();\r\n    this.containerElement = null;\r\n    \r\n    // Store bound event handlers for proper removal\r\n    this.boundHandleUpdate = null;\r\n    this.boundHandleMarker = null;\r\n    this.boundHandleCamera = null;\r\n    this.boundHandleResize = null;\r\n    \r\n    // Store options\r\n    this.options = {\r\n      antialias: options.antialias !== undefined ? options.antialias : true,\r\n      alpha: options.alpha !== undefined ? options.alpha : true,\r\n      ...options\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Initialize the plugin with AR.js engine\r\n   */\r\n  init(core) {\r\n    this.core = core;\r\n    \r\n    // Create Three.js renderer\r\n    this.renderer = new THREE.WebGLRenderer({\r\n      antialias: this.options.antialias,\r\n      alpha: this.options.alpha\r\n    });\r\n    this.renderer.setPixelRatio(window.devicePixelRatio);\r\n    this.renderer.setClearColor(0x000000, 0);\r\n    \r\n    // Create scene\r\n    this.scene = new THREE.Scene();\r\n    \r\n    // Create camera (AR camera will be configured on ar:camera event)\r\n    this.camera = new THREE.PerspectiveCamera(\r\n      60,\r\n      window.innerWidth / window.innerHeight,\r\n      0.1,\r\n      1000\r\n    );\r\n    this.camera.position.set(0, 0, 0);\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Initialized');\r\n  }\r\n\r\n  /**\r\n   * Enable the plugin (attach to DOM and subscribe to events)\r\n   */\r\n  enable() {\r\n    if (!this.core) {\r\n      throw new Error('Plugin must be initialized before enabling');\r\n    }\r\n\r\n    // Attach renderer to container element or body\r\n    const container = this.options.container || document.body;\r\n    this.containerElement = container;\r\n    container.appendChild(this.renderer.domElement);\r\n    \r\n    // Set initial size\r\n    this.handleResize();\r\n    \r\n    // Bind event handlers once and store references\r\n    this.boundHandleUpdate = this.handleUpdate.bind(this);\r\n    this.boundHandleMarker = this.handleMarker.bind(this);\r\n    this.boundHandleCamera = this.handleCamera.bind(this);\r\n    this.boundHandleResize = this.handleResize.bind(this);\r\n    \r\n    // Subscribe to engine events\r\n    this.core.eventBus.on('engine:update', this.boundHandleUpdate);\r\n    this.core.eventBus.on('ar:marker', this.boundHandleMarker);\r\n    this.core.eventBus.on('ar:camera', this.boundHandleCamera);\r\n    \r\n    // Handle window resize\r\n    window.addEventListener('resize', this.boundHandleResize);\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Enabled');\r\n  }\r\n\r\n  /**\r\n   * Disable the plugin (remove event listeners)\r\n   */\r\n  disable() {\r\n    if (!this.core) return;\r\n    \r\n    // Unsubscribe from engine events using stored bound references\r\n    if (this.boundHandleUpdate) {\r\n      this.core.off('engine:update', this.boundHandleUpdate);\r\n    }\r\n    if (this.boundHandleMarker) {\r\n      this.core.off('ar:marker', this.boundHandleMarker);\r\n    }\r\n    if (this.boundHandleCamera) {\r\n      this.core.off('ar:camera', this.boundHandleCamera);\r\n    }\r\n    \r\n    // Remove resize listener using stored bound reference\r\n    if (this.boundHandleResize) {\r\n      window.removeEventListener('resize', this.boundHandleResize);\r\n    }\r\n    \r\n    // Clear bound references\r\n    this.boundHandleUpdate = null;\r\n    this.boundHandleMarker = null;\r\n    this.boundHandleCamera = null;\r\n    this.boundHandleResize = null;\r\n    \r\n    // Remove renderer from DOM\r\n    if (this.renderer && this.renderer.domElement && this.renderer.domElement.parentNode) {\r\n      this.renderer.domElement.parentNode.removeChild(this.renderer.domElement);\r\n    }\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Disabled');\r\n  }\r\n\r\n  /**\r\n   * Dispose and cleanup all resources\r\n   */\r\n  dispose() {\r\n    this.disable();\r\n    \r\n    // Clear anchors\r\n    this.anchors.forEach((anchor) => {\r\n      if (anchor.parent) {\r\n        anchor.parent.remove(anchor);\r\n      }\r\n    });\r\n    this.anchors.clear();\r\n    \r\n    // Dispose Three.js resources\r\n    if (this.renderer) {\r\n      this.renderer.dispose();\r\n      this.renderer = null;\r\n    }\r\n    \r\n    if (this.scene) {\r\n      this.scene = null;\r\n    }\r\n    \r\n    if (this.camera) {\r\n      this.camera = null;\r\n    }\r\n    \r\n    this.core = null;\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Disposed');\r\n  }\r\n\r\n  /**\r\n   * Handle engine update event - render the scene\r\n   */\r\n  handleUpdate() {\r\n    if (this.renderer && this.scene && this.camera) {\r\n      this.renderer.render(this.scene, this.camera);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle marker event - create/update marker anchors\r\n   */\r\n  handleMarker(event) {\r\n    const { id, matrix, visible } = event;\r\n    \r\n    let anchor = this.anchors.get(id);\r\n    \r\n    if (!anchor) {\r\n      // Create new anchor (Group) for this marker\r\n      anchor = new THREE.Group();\r\n      anchor.name = `marker-${id}`;\r\n      this.scene.add(anchor);\r\n      this.anchors.set(id, anchor);\r\n    }\r\n    \r\n    // Update visibility\r\n    anchor.visible = visible;\r\n    \r\n    // Update transform matrix if provided\r\n    if (matrix && Array.isArray(matrix)) {\r\n      anchor.matrix.fromArray(matrix);\r\n      anchor.matrix.decompose(anchor.position, anchor.quaternion, anchor.scale);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle camera event - update camera projection\r\n   */\r\n  handleCamera(event) {\r\n    if (event.projectionMatrix && Array.isArray(event.projectionMatrix)) {\r\n      this.setProjectionFromArray(event.projectionMatrix);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle window resize\r\n   */\r\n  handleResize() {\r\n    if (!this.renderer || !this.camera) return;\r\n    \r\n    const width = window.innerWidth;\r\n    const height = window.innerHeight;\r\n    \r\n    this.renderer.setSize(width, height);\r\n    this.camera.aspect = width / height;\r\n    this.camera.updateProjectionMatrix();\r\n  }\r\n\r\n  /**\r\n   * Set camera projection matrix from array (column-major 4x4)\r\n   */\r\n  setProjectionFromArray(array) {\r\n    if (!this.camera || !Array.isArray(array) || array.length !== 16) {\r\n      console.warn('[ThreeJSRendererPlugin] Invalid projection matrix');\r\n      return;\r\n    }\r\n    \r\n    this.camera.projectionMatrix.fromArray(array);\r\n    this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert();\r\n  }\r\n\r\n  /**\r\n   * Get Three.js scene for adding custom objects\r\n   */\r\n  getScene() {\r\n    return this.scene;\r\n  }\r\n\r\n  /**\r\n   * Get Three.js camera\r\n   */\r\n  getCamera() {\r\n    return this.camera;\r\n  }\r\n\r\n  /**\r\n   * Get Three.js renderer\r\n   */\r\n  getRenderer() {\r\n    return this.renderer;\r\n  }\r\n\r\n  /**\r\n   * Get anchor by marker ID\r\n   */\r\n  getAnchor(markerId) {\r\n    return this.anchors.get(markerId);\r\n  }\r\n}\r\n"],"names":["ThreeJSRendererPlugin","options","core","THREE","container","anchor","event","id","matrix","visible","width","height","array","markerId"],"mappings":"mYAWO,MAAMA,CAAsB,CACjC,YAAYC,EAAU,GAAI,CACxB,KAAK,KAAO,mBACZ,KAAK,OAAS,KACd,KAAK,SAAW,KAChB,KAAK,MAAQ,KACb,KAAK,OAAS,KACd,KAAK,QAAU,IAAI,IACnB,KAAK,iBAAmB,KAGxB,KAAK,kBAAoB,KACzB,KAAK,kBAAoB,KACzB,KAAK,kBAAoB,KACzB,KAAK,kBAAoB,KAGzB,KAAK,QAAU,CACb,UAAWA,EAAQ,YAAc,OAAYA,EAAQ,UAAY,GACjE,MAAOA,EAAQ,QAAU,OAAYA,EAAQ,MAAQ,GACrD,GAAGA,CACT,CACE,CAKA,KAAKC,EAAM,CACT,KAAK,KAAOA,EAGZ,KAAK,SAAW,IAAIC,EAAM,cAAc,CACtC,UAAW,KAAK,QAAQ,UACxB,MAAO,KAAK,QAAQ,KAC1B,CAAK,EACD,KAAK,SAAS,cAAc,OAAO,gBAAgB,EACnD,KAAK,SAAS,cAAc,EAAU,CAAC,EAGvC,KAAK,MAAQ,IAAIA,EAAM,MAGvB,KAAK,OAAS,IAAIA,EAAM,kBACtB,GACA,OAAO,WAAa,OAAO,YAC3B,GACA,GACN,EACI,KAAK,OAAO,SAAS,IAAI,EAAG,EAAG,CAAC,EAEhC,QAAQ,IAAI,qCAAqC,CACnD,CAKA,QAAS,CACP,GAAI,CAAC,KAAK,KACR,MAAM,IAAI,MAAM,4CAA4C,EAI9D,MAAMC,EAAY,KAAK,QAAQ,WAAa,SAAS,KACrD,KAAK,iBAAmBA,EACxBA,EAAU,YAAY,KAAK,SAAS,UAAU,EAG9C,KAAK,aAAY,EAGjB,KAAK,kBAAoB,KAAK,aAAa,KAAK,IAAI,EACpD,KAAK,kBAAoB,KAAK,aAAa,KAAK,IAAI,EACpD,KAAK,kBAAoB,KAAK,aAAa,KAAK,IAAI,EACpD,KAAK,kBAAoB,KAAK,aAAa,KAAK,IAAI,EAGpD,KAAK,KAAK,SAAS,GAAG,gBAAiB,KAAK,iBAAiB,EAC7D,KAAK,KAAK,SAAS,GAAG,YAAa,KAAK,iBAAiB,EACzD,KAAK,KAAK,SAAS,GAAG,YAAa,KAAK,iBAAiB,EAGzD,OAAO,iBAAiB,SAAU,KAAK,iBAAiB,EAExD,QAAQ,IAAI,iCAAiC,CAC/C,CAKA,SAAU,CACH,KAAK,OAGN,KAAK,mBACP,KAAK,KAAK,IAAI,gBAAiB,KAAK,iBAAiB,EAEnD,KAAK,mBACP,KAAK,KAAK,IAAI,YAAa,KAAK,iBAAiB,EAE/C,KAAK,mBACP,KAAK,KAAK,IAAI,YAAa,KAAK,iBAAiB,EAI/C,KAAK,mBACP,OAAO,oBAAoB,SAAU,KAAK,iBAAiB,EAI7D,KAAK,kBAAoB,KACzB,KAAK,kBAAoB,KACzB,KAAK,kBAAoB,KACzB,KAAK,kBAAoB,KAGrB,KAAK,UAAY,KAAK,SAAS,YAAc,KAAK,SAAS,WAAW,YACxE,KAAK,SAAS,WAAW,WAAW,YAAY,KAAK,SAAS,UAAU,EAG1E,QAAQ,IAAI,kCAAkC,EAChD,CAKA,SAAU,CACR,KAAK,QAAO,EAGZ,KAAK,QAAQ,QAASC,GAAW,CAC3BA,EAAO,QACTA,EAAO,OAAO,OAAOA,CAAM,CAE/B,CAAC,EACD,KAAK,QAAQ,QAGT,KAAK,WACP,KAAK,SAAS,UACd,KAAK,SAAW,MAGd,KAAK,QACP,KAAK,MAAQ,MAGX,KAAK,SACP,KAAK,OAAS,MAGhB,KAAK,KAAO,KAEZ,QAAQ,IAAI,kCAAkC,CAChD,CAKA,cAAe,CACT,KAAK,UAAY,KAAK,OAAS,KAAK,QACtC,KAAK,SAAS,OAAO,KAAK,MAAO,KAAK,MAAM,CAEhD,CAKA,aAAaC,EAAO,CAClB,KAAM,CAAE,GAAAC,EAAI,OAAAC,EAAQ,QAAAC,CAAO,EAAKH,EAEhC,IAAID,EAAS,KAAK,QAAQ,IAAIE,CAAE,EAE3BF,IAEHA,EAAS,IAAIF,EAAM,MACnBE,EAAO,KAAO,UAAUE,CAAE,GAC1B,KAAK,MAAM,IAAIF,CAAM,EACrB,KAAK,QAAQ,IAAIE,EAAIF,CAAM,GAI7BA,EAAO,QAAUI,EAGbD,GAAU,MAAM,QAAQA,CAAM,IAChCH,EAAO,OAAO,UAAUG,CAAM,EAC9BH,EAAO,OAAO,UAAUA,EAAO,SAAUA,EAAO,WAAYA,EAAO,KAAK,EAE5E,CAKA,aAAaC,EAAO,CACdA,EAAM,kBAAoB,MAAM,QAAQA,EAAM,gBAAgB,GAChE,KAAK,uBAAuBA,EAAM,gBAAgB,CAEtD,CAKA,cAAe,CACb,GAAI,CAAC,KAAK,UAAY,CAAC,KAAK,OAAQ,OAEpC,MAAMI,EAAQ,OAAO,WACfC,EAAS,OAAO,YAEtB,KAAK,SAAS,QAAQD,EAAOC,CAAM,EACnC,KAAK,OAAO,OAASD,EAAQC,EAC7B,KAAK,OAAO,wBACd,CAKA,uBAAuBC,EAAO,CAC5B,GAAI,CAAC,KAAK,QAAU,CAAC,MAAM,QAAQA,CAAK,GAAKA,EAAM,SAAW,GAAI,CAChE,QAAQ,KAAK,mDAAmD,EAChE,MACF,CAEA,KAAK,OAAO,iBAAiB,UAAUA,CAAK,EAC5C,KAAK,OAAO,wBAAwB,KAAK,KAAK,OAAO,gBAAgB,EAAE,QACzE,CAKA,UAAW,CACT,OAAO,KAAK,KACd,CAKA,WAAY,CACV,OAAO,KAAK,MACd,CAKA,aAAc,CACZ,OAAO,KAAK,QACd,CAKA,UAAUC,EAAU,CAClB,OAAO,KAAK,QAAQ,IAAIA,CAAQ,CAClC,CACF"}