{"version":3,"file":"arjs-plugin-threejs.mjs","sources":["../src/threejs-renderer-plugin.js"],"sourcesContent":["import * as THREE from 'three';\n\n/**\n * ThreeJSRendererPlugin - Minimal Three.js renderer plugin for AR.js-core\n * \n * Lifecycle:\n * - init: create renderer, scene, camera\n * - enable: attach renderer to DOM, subscribe to events\n * - disable: remove event listeners\n * - dispose: cleanup Three.js resources\n */\nexport class ThreeJSRendererPlugin {\n  constructor(options = {}) {\n    this.name = 'threejs-renderer';\n    this.engine = null;\n    this.renderer = null;\n    this.scene = null;\n    this.camera = null;\n    this.anchors = new Map();\n    this.containerElement = null;\n    \n    // Store bound event handlers for proper removal\n    this.boundHandleUpdate = null;\n    this.boundHandleMarker = null;\n    this.boundHandleCamera = null;\n    this.boundHandleResize = null;\n    \n    // Store options\n    this.options = {\n      antialias: options.antialias !== undefined ? options.antialias : true,\n      alpha: options.alpha !== undefined ? options.alpha : true,\n      ...options\n    };\n  }\n\n  /**\n   * Initialize the plugin with AR.js engine\n   */\n  init(engine) {\n    this.engine = engine;\n    \n    // Create Three.js renderer\n    this.renderer = new THREE.WebGLRenderer({\n      antialias: this.options.antialias,\n      alpha: this.options.alpha\n    });\n    this.renderer.setPixelRatio(window.devicePixelRatio);\n    this.renderer.setClearColor(0x000000, 0);\n    \n    // Create scene\n    this.scene = new THREE.Scene();\n    \n    // Create camera (AR camera will be configured on ar:camera event)\n    this.camera = new THREE.PerspectiveCamera(\n      60,\n      window.innerWidth / window.innerHeight,\n      0.1,\n      1000\n    );\n    this.camera.position.set(0, 0, 0);\n    \n    console.log('[ThreeJSRendererPlugin] Initialized');\n  }\n\n  /**\n   * Enable the plugin (attach to DOM and subscribe to events)\n   */\n  enable() {\n    if (!this.engine) {\n      throw new Error('Plugin must be initialized before enabling');\n    }\n\n    // Attach renderer to container element or body\n    const container = this.options.container || document.body;\n    this.containerElement = container;\n    container.appendChild(this.renderer.domElement);\n    \n    // Set initial size\n    this.handleResize();\n    \n    // Bind event handlers once and store references\n    this.boundHandleUpdate = this.handleUpdate.bind(this);\n    this.boundHandleMarker = this.handleMarker.bind(this);\n    this.boundHandleCamera = this.handleCamera.bind(this);\n    this.boundHandleResize = this.handleResize.bind(this);\n    \n    // Subscribe to engine events\n    this.engine.on('engine:update', this.boundHandleUpdate);\n    this.engine.on('ar:marker', this.boundHandleMarker);\n    this.engine.on('ar:camera', this.boundHandleCamera);\n    \n    // Handle window resize\n    window.addEventListener('resize', this.boundHandleResize);\n    \n    console.log('[ThreeJSRendererPlugin] Enabled');\n  }\n\n  /**\n   * Disable the plugin (remove event listeners)\n   */\n  disable() {\n    if (!this.engine) return;\n    \n    // Unsubscribe from engine events using stored bound references\n    if (this.boundHandleUpdate) {\n      this.engine.off('engine:update', this.boundHandleUpdate);\n    }\n    if (this.boundHandleMarker) {\n      this.engine.off('ar:marker', this.boundHandleMarker);\n    }\n    if (this.boundHandleCamera) {\n      this.engine.off('ar:camera', this.boundHandleCamera);\n    }\n    \n    // Remove resize listener using stored bound reference\n    if (this.boundHandleResize) {\n      window.removeEventListener('resize', this.boundHandleResize);\n    }\n    \n    // Clear bound references\n    this.boundHandleUpdate = null;\n    this.boundHandleMarker = null;\n    this.boundHandleCamera = null;\n    this.boundHandleResize = null;\n    \n    // Remove renderer from DOM\n    if (this.renderer && this.renderer.domElement && this.renderer.domElement.parentNode) {\n      this.renderer.domElement.parentNode.removeChild(this.renderer.domElement);\n    }\n    \n    console.log('[ThreeJSRendererPlugin] Disabled');\n  }\n\n  /**\n   * Dispose and cleanup all resources\n   */\n  dispose() {\n    this.disable();\n    \n    // Clear anchors\n    this.anchors.forEach((anchor) => {\n      if (anchor.parent) {\n        anchor.parent.remove(anchor);\n      }\n    });\n    this.anchors.clear();\n    \n    // Dispose Three.js resources\n    if (this.renderer) {\n      this.renderer.dispose();\n      this.renderer = null;\n    }\n    \n    if (this.scene) {\n      this.scene = null;\n    }\n    \n    if (this.camera) {\n      this.camera = null;\n    }\n    \n    this.engine = null;\n    \n    console.log('[ThreeJSRendererPlugin] Disposed');\n  }\n\n  /**\n   * Handle engine update event - render the scene\n   */\n  handleUpdate() {\n    if (this.renderer && this.scene && this.camera) {\n      this.renderer.render(this.scene, this.camera);\n    }\n  }\n\n  /**\n   * Handle marker event - create/update marker anchors\n   */\n  handleMarker(event) {\n    const { id, matrix, visible } = event;\n    \n    let anchor = this.anchors.get(id);\n    \n    if (!anchor) {\n      // Create new anchor (Group) for this marker\n      anchor = new THREE.Group();\n      anchor.name = `marker-${id}`;\n      this.scene.add(anchor);\n      this.anchors.set(id, anchor);\n    }\n    \n    // Update visibility\n    anchor.visible = visible;\n    \n    // Update transform matrix if provided\n    if (matrix && Array.isArray(matrix)) {\n      anchor.matrix.fromArray(matrix);\n      anchor.matrix.decompose(anchor.position, anchor.quaternion, anchor.scale);\n    }\n  }\n\n  /**\n   * Handle camera event - update camera projection\n   */\n  handleCamera(event) {\n    if (event.projectionMatrix && Array.isArray(event.projectionMatrix)) {\n      this.setProjectionFromArray(event.projectionMatrix);\n    }\n  }\n\n  /**\n   * Handle window resize\n   */\n  handleResize() {\n    if (!this.renderer || !this.camera) return;\n    \n    const width = window.innerWidth;\n    const height = window.innerHeight;\n    \n    this.renderer.setSize(width, height);\n    this.camera.aspect = width / height;\n    this.camera.updateProjectionMatrix();\n  }\n\n  /**\n   * Set camera projection matrix from array (column-major 4x4)\n   */\n  setProjectionFromArray(array) {\n    if (!this.camera || !Array.isArray(array) || array.length !== 16) {\n      console.warn('[ThreeJSRendererPlugin] Invalid projection matrix');\n      return;\n    }\n    \n    this.camera.projectionMatrix.fromArray(array);\n    this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert();\n  }\n\n  /**\n   * Get Three.js scene for adding custom objects\n   */\n  getScene() {\n    return this.scene;\n  }\n\n  /**\n   * Get Three.js camera\n   */\n  getCamera() {\n    return this.camera;\n  }\n\n  /**\n   * Get Three.js renderer\n   */\n  getRenderer() {\n    return this.renderer;\n  }\n\n  /**\n   * Get anchor by marker ID\n   */\n  getAnchor(markerId) {\n    return this.anchors.get(markerId);\n  }\n}\n"],"names":["ThreeJSRendererPlugin","options","engine","THREE","container","anchor","event","id","matrix","visible","width","height","array","markerId"],"mappings":"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"}