{"version":3,"file":"arjs-plugin-threejs.mjs","sources":["../src/threejs-renderer-plugin.js"],"sourcesContent":["import * as THREE from 'three';\r\n\r\n// Version injected at build time by Vite define.\r\n// If the define is missing (e.g. in a non-Vite test harness), fallback to 'unknown'.\r\nconst THREEJS_RENDERER_PLUGIN_VERSION =\r\n    typeof __THREEJS_RENDERER_PLUGIN_VERSION__ !== 'undefined'\r\n        ? __THREEJS_RENDERER_PLUGIN_VERSION__\r\n        : 'unknown';\r\n\r\nexport { THREEJS_RENDERER_PLUGIN_VERSION };\r\n/**\r\n * Plugin to render THREE.js scenes driven by AR markers.\r\n * Provides management of renderer, scene, camera and marker anchors.\r\n * Supported options: antialias, alpha, preferRAF, container, invertModelView, applyAxisFix\r\n */\r\n\r\nexport class ThreeJSRendererPlugin {\r\n    constructor(options = {}) {\r\n        this.name = 'threejs-renderer';\r\n        this.version = THREEJS_RENDERER_PLUGIN_VERSION;\r\n\r\n        this.engine = null;\r\n        this.emitter = null; // engine.eventBus preferred\r\n        this.renderer = null;\r\n        this.scene = null;\r\n        this.camera = null;\r\n        this.anchors = new Map();\r\n\r\n        this.options = {\r\n            antialias: options.antialias ?? true,\r\n            alpha: options.alpha ?? true,\r\n            preferRAF: options.preferRAF ?? true,            // render even if engine:update absent\r\n            container: options.container || null,            // DOM node to mount canvas\r\n            minConfidence: options.minConfidence ?? 0,       // optional filter for e.marker.confidence\r\n\r\n            // Legacy AR.js transform chain (defaults match classic AR.js)\r\n            useLegacyAxisChain: options.useLegacyAxisChain ?? true,\r\n            changeMatrixMode: options.changeMatrixMode || 'modelViewMatrix',\r\n\r\n            // Experimental (ignored if useLegacyAxisChain = true)\r\n            invertModelView: options.invertModelView ?? false,\r\n            applyAxisFix: options.applyAxisFix ?? false,\r\n\r\n            // NEW: Debug helpers (default off)\r\n            debugSceneAxes: options.debugSceneAxes ?? false,\r\n            sceneAxesSize: options.sceneAxesSize ?? 2,\r\n            debugAnchorAxes: options.debugAnchorAxes ?? false,\r\n            anchorAxesSize: options.anchorAxesSize ?? 0.5,\r\n            // NEW: dependency injection for tests\r\n            rendererFactory: options.rendererFactory || null,\r\n            ...options,\r\n        };\r\n\r\n        this._rafId = 0;\r\n\r\n        // For experimental path only\r\n        this._axisFix = new THREE.Matrix4()\r\n            .makeRotationY(Math.PI)\r\n            .multiply(new THREE.Matrix4().makeRotationZ(Math.PI));\r\n\r\n        console.log(\r\n            `[ThreeJSRendererPlugin] v${this.version} constructed`,\r\n            {\r\n                legacyAxisChain: this.options.useLegacyAxisChain,\r\n                changeMatrixMode: this.options.changeMatrixMode,\r\n                preferRAF: this.options.preferRAF,\r\n                debugSceneAxes: this.options.debugSceneAxes,\r\n                debugAnchorAxes: this.options.debugAnchorAxes,\r\n            }\r\n        );\r\n    }\r\n\r\n    init(engine) {\r\n        this.engine = engine;\r\n        this.emitter = engine?.eventBus || engine;\r\n\r\n        // Allow injection of a factory for tests\r\n        if (typeof this.options.rendererFactory === 'function') {\r\n            this.renderer = this.options.rendererFactory({\r\n                antialias: this.options.antialias,\r\n                alpha: this.options.alpha,\r\n            });\r\n        } else {\r\n            this.renderer = new THREE.WebGLRenderer({\r\n                antialias: this.options.antialias,\r\n                alpha: this.options.alpha,\r\n                preserveDrawingBuffer: false,\r\n            });\r\n            this.renderer.setPixelRatio(window.devicePixelRatio);\r\n            this.renderer.setClearColor(0x000000, 0);\r\n        }\r\n\r\n        this.scene = new THREE.Scene();\r\n        this.camera = new THREE.PerspectiveCamera(60, 1, 0.01, 2000);\r\n\r\n        // Lighting\r\n        this.scene.add(new THREE.AmbientLight(0xffffff, 0.6));\r\n        const dir = new THREE.DirectionalLight(0xffffff, 0.6);\r\n        dir.position.set(1, 1, 1);\r\n        this.scene.add(dir);\r\n\r\n        console.log('[ThreeJSRendererPlugin] Initialized', {\r\n            hasEventBus: !!engine?.eventBus,\r\n            version: this.version,\r\n        });\r\n    }\r\n\r\n    enable() {\r\n        const container = this.options.container || document.body;\r\n        container.appendChild(this.renderer.domElement);\r\n        this._resizeToContainer(container);\r\n\r\n        Object.assign(this.renderer.domElement.style, {\r\n            position: 'absolute',\r\n            inset: '0',\r\n            width: '100%',\r\n            height: '100%',\r\n            zIndex: '2',\r\n            display: 'block',\r\n            pointerEvents: 'none',\r\n        });\r\n\r\n        this._onUpdate = () => this.handleUpdate();\r\n        this._onMarker = (e) => this.handleUnifiedMarker(e);\r\n        this._onGetMarker = (e) => this.handleRawGetMarker(e);\r\n        this._onCamera = (e) => this.handleCamera(e);\r\n        this._onLegacyFound = (d) => this.handleUnifiedMarker(this._adaptLegacy(d, true));\r\n        this._onLegacyUpdated = (d) => this.handleUnifiedMarker(this._adaptLegacy(d, true));\r\n        this._onLegacyLost = (d) => this.handleUnifiedMarker(this._adaptLegacy(d, false));\r\n        this._onResize = () => this.handleResize();\r\n\r\n        this._sub('engine:update', this._onUpdate);\r\n        this._sub('ar:marker', this._onMarker);\r\n        this._sub('ar:getMarker', this._onGetMarker);\r\n        this._sub('ar:camera', this._onCamera);\r\n        this._sub('ar:markerFound', this._onLegacyFound);\r\n        this._sub('ar:markerUpdated', this._onLegacyUpdated);\r\n        this._sub('ar:markerLost', this._onLegacyLost);\r\n\r\n        window.addEventListener('resize', this._onResize);\r\n\r\n        if (this.options.preferRAF) {\r\n            const loop = () => {\r\n                this._rafId = requestAnimationFrame(loop);\r\n                this.handleUpdate();\r\n            };\r\n            this._rafId = requestAnimationFrame(loop);\r\n        }\r\n\r\n        // Debug: scene axes (optional)\r\n        if (this.options.debugSceneAxes) {\r\n            this.scene.add(new THREE.AxesHelper(this.options.sceneAxesSize));\r\n        }\r\n\r\n        console.log('[ThreeJSRendererPlugin] Enabled v' + this.version);\r\n    }\r\n\r\n    disable() {\r\n        if (this.emitter?.off) {\r\n            this._off('engine:update', this._onUpdate);\r\n            this._off('ar:marker', this._onMarker);\r\n            this._off('ar:getMarker', this._onGetMarker);\r\n            this._off('ar:camera', this._onCamera);\r\n            this._off('ar:markerFound', this._onLegacyFound);\r\n            this._off('ar:markerUpdated', this._onLegacyUpdated);\r\n            this._off('ar:markerLost', this._onLegacyLost);\r\n        }\r\n        window.removeEventListener('resize', this._onResize);\r\n        if (this._rafId) cancelAnimationFrame(this._rafId);\r\n        this._rafId = 0;\r\n        if (this.renderer?.domElement?.parentNode) {\r\n            this.renderer.domElement.parentNode.removeChild(this.renderer.domElement);\r\n        }\r\n        console.log('[ThreeJSRendererPlugin] Disabled v' + this.version);\r\n    }\r\n\r\n    dispose() {\r\n        this.disable();\r\n        this.anchors.forEach(a => a.parent?.remove(a));\r\n        this.anchors.clear();\r\n        this.renderer?.dispose?.();\r\n        this.renderer = null;\r\n        this.scene = null;\r\n        this.camera = null;\r\n        this.engine = null;\r\n        this.emitter = null;\r\n        console.log('[ThreeJSRendererPlugin] Disposed v' + this.version);\r\n    }\r\n\r\n    _sub(ev, fn) { try { this.emitter?.on?.(ev, fn); } catch {} }\r\n    _off(ev, fn) { try { this.emitter?.off?.(ev, fn); } catch {} }\r\n\r\n    _adaptLegacy(d, visible) {\r\n        return {\r\n            id: String(d?.markerId ?? d?.id ?? '0'),\r\n            matrix: d?.matrix || d?.transformationMatrix || d?.modelViewMatrix || d?.poseMatrix || null,\r\n            visible,\r\n            _legacy: true,\r\n        };\r\n    }\r\n\r\n    handleRawGetMarker(e) {\r\n        if (!e) return;\r\n        const confidence = e?.marker?.confidence;\r\n        if (confidence !== undefined && confidence < this.options.minConfidence) return;\r\n        const id = String(\r\n            e?.marker?.markerId ??\r\n            e?.marker?.id ??\r\n            e?.marker?.pattHandle ??\r\n            e?.marker?.uid ??\r\n            e?.marker?.index ??\r\n            '0'\r\n        );\r\n        const matrix = e?.matrix;\r\n        this.handleUnifiedMarker({ id, matrix, visible: true, _source: 'ar:getMarker' });\r\n    }\r\n\r\n    handleUnifiedMarker(evt) {\r\n        const { id, matrix, visible } = evt || {};\r\n        if (id == null) return;\r\n\r\n        let anchor = this.anchors.get(id);\r\n        if (!anchor) {\r\n            anchor = new THREE.Group();\r\n            anchor.name = `marker-${id}`;\r\n            anchor.matrixAutoUpdate = false;\r\n            // Debug: anchor axes (optional)\r\n            if (this.options.debugAnchorAxes) {\r\n                anchor.add(new THREE.AxesHelper(this.options.anchorAxesSize));\r\n            }\r\n            this.scene.add(anchor);\r\n            this.anchors.set(id, anchor);\r\n            console.log('[ThreeJSRendererPlugin] anchor created', id);\r\n        }\r\n\r\n        if (typeof visible === 'boolean') anchor.visible = visible;\r\n\r\n        if (Array.isArray(matrix) && matrix.length === 16) {\r\n            const modelView = new THREE.Matrix4().fromArray(matrix);\r\n\r\n            let final;\r\n            if (this.options.useLegacyAxisChain) {\r\n                // Legacy chain: R_y(π) * R_z(π) * modelView * R_x(π/2)\r\n                const projectionAxis = new THREE.Matrix4()\r\n                    .makeRotationY(Math.PI)\r\n                    .multiply(new THREE.Matrix4().makeRotationZ(Math.PI));\r\n                const markerAxis = new THREE.Matrix4().makeRotationX(Math.PI / 2);\r\n                final = new THREE.Matrix4()\r\n                    .copy(projectionAxis)\r\n                    .multiply(modelView)\r\n                    .multiply(markerAxis);\r\n\r\n                if (this.options.changeMatrixMode === 'cameraTransformMatrix') {\r\n                    final.invert();\r\n                }\r\n            } else {\r\n                // Experimental path\r\n                final = modelView.clone();\r\n                if (this.options.invertModelView) final.invert();\r\n                if (this.options.applyAxisFix) final.multiply(this._axisFix);\r\n            }\r\n\r\n            anchor.matrix.copy(final);\r\n            anchor.matrix.decompose(anchor.position, anchor.quaternion, anchor.scale);\r\n        }\r\n    }\r\n\r\n    handleCamera(e) {\r\n        const arr = e?.projectionMatrix || e?.matrix;\r\n        if (Array.isArray(arr) && arr.length === 16) {\r\n            this.camera.projectionMatrix.fromArray(arr);\r\n            this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert();\r\n            console.log('[ThreeJSRendererPlugin] Projection applied v' + this.version);\r\n        }\r\n    }\r\n\r\n    handleUpdate() {\r\n        if (this.renderer && this.scene && this.camera) {\r\n            this.renderer.render(this.scene, this.camera);\r\n        }\r\n    }\r\n\r\n    handleResize() {\r\n        const container = this.options.container || document.body;\r\n        this._resizeToContainer(container);\r\n    }\r\n\r\n    _resizeToContainer(container) {\r\n        const w = container.clientWidth || window.innerWidth;\r\n        const h = container.clientHeight || Math.round(w * 3 / 4);\r\n        this.renderer.setSize?.(w, h);\r\n        this.camera.aspect = w / h;\r\n        this.camera.updateProjectionMatrix();\r\n    }\r\n\r\n    getAnchor(id) { return this.anchors.get(String(id)); }\r\n    getScene() { return this.scene; }\r\n    getCamera() { return this.camera; }\r\n    getRenderer() { return this.renderer; }\r\n}"],"names":["THREEJS_RENDERER_PLUGIN_VERSION","ThreeJSRendererPlugin","options","THREE","engine","dir","container","e","d","loop","a","ev","fn","visible","confidence","id","matrix","evt","anchor","modelView","final","projectionAxis","markerAxis","arr","w","h"],"mappings":"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"}