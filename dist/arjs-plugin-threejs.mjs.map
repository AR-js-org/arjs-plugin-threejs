{"version":3,"file":"arjs-plugin-threejs.mjs","sources":["../src/threejs-renderer-plugin.js"],"sourcesContent":["import * as THREE from 'three';\r\n\r\n/**\r\n * ThreeJSRendererPlugin - Minimal Three.js renderer plugin for AR.js-core\r\n * \r\n * Lifecycle:\r\n * - init: create renderer, scene, camera\r\n * - enable: attach renderer to DOM, subscribe to events\r\n * - disable: remove event listeners\r\n * - dispose: cleanup Three.js resources\r\n */\r\nexport class ThreeJSRendererPlugin {\r\n  constructor(options = {}) {\r\n    this.name = 'threejs-renderer';\r\n    this.engine = null;\r\n    this.renderer = null;\r\n    this.scene = null;\r\n    this.camera = null;\r\n    this.anchors = new Map();\r\n    this.containerElement = null;\r\n    \r\n    // Store bound event handlers for proper removal\r\n    this.boundHandleUpdate = null;\r\n    this.boundHandleMarker = null;\r\n    this.boundHandleCamera = null;\r\n    this.boundHandleResize = null;\r\n    \r\n    // Store options\r\n    this.options = {\r\n      antialias: options.antialias !== undefined ? options.antialias : true,\r\n      alpha: options.alpha !== undefined ? options.alpha : true,\r\n      ...options\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Initialize the plugin with AR.js engine\r\n   */\r\n  init(core) {\r\n    this.core = core;\r\n    \r\n    // Create Three.js renderer\r\n    this.renderer = new THREE.WebGLRenderer({\r\n      antialias: this.options.antialias,\r\n      alpha: this.options.alpha\r\n    });\r\n    this.renderer.setPixelRatio(window.devicePixelRatio);\r\n    this.renderer.setClearColor(0x000000, 0);\r\n    \r\n    // Create scene\r\n    this.scene = new THREE.Scene();\r\n    \r\n    // Create camera (AR camera will be configured on ar:camera event)\r\n    this.camera = new THREE.PerspectiveCamera(\r\n      60,\r\n      window.innerWidth / window.innerHeight,\r\n      0.1,\r\n      1000\r\n    );\r\n    this.camera.position.set(0, 0, 0);\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Initialized');\r\n  }\r\n\r\n  /**\r\n   * Enable the plugin (attach to DOM and subscribe to events)\r\n   */\r\n  enable() {\r\n    if (!this.core) {\r\n      throw new Error('Plugin must be initialized before enabling');\r\n    }\r\n\r\n    // Attach renderer to container element or body\r\n    const container = this.options.container || document.body;\r\n    this.containerElement = container;\r\n    container.appendChild(this.renderer.domElement);\r\n    \r\n    // Set initial size\r\n    this.handleResize();\r\n    \r\n    // Bind event handlers once and store references\r\n    this.boundHandleUpdate = this.handleUpdate.bind(this);\r\n    this.boundHandleMarker = this.handleMarker.bind(this);\r\n    this.boundHandleCamera = this.handleCamera.bind(this);\r\n    this.boundHandleResize = this.handleResize.bind(this);\r\n    \r\n    // Subscribe to engine events\r\n    this.core.eventBus.on('engine:update', this.boundHandleUpdate);\r\n    this.core.eventBus.on('ar:marker', this.boundHandleMarker);\r\n    this.core.eventBus.on('ar:camera', this.boundHandleCamera);\r\n    \r\n    // Handle window resize\r\n    window.addEventListener('resize', this.boundHandleResize);\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Enabled');\r\n  }\r\n\r\n  /**\r\n   * Disable the plugin (remove event listeners)\r\n   */\r\n  disable() {\r\n    if (!this.core) return;\r\n    \r\n    // Unsubscribe from engine events using stored bound references\r\n    if (this.boundHandleUpdate) {\r\n      this.core.off('engine:update', this.boundHandleUpdate);\r\n    }\r\n    if (this.boundHandleMarker) {\r\n      this.core.off('ar:marker', this.boundHandleMarker);\r\n    }\r\n    if (this.boundHandleCamera) {\r\n      this.core.off('ar:camera', this.boundHandleCamera);\r\n    }\r\n    \r\n    // Remove resize listener using stored bound reference\r\n    if (this.boundHandleResize) {\r\n      window.removeEventListener('resize', this.boundHandleResize);\r\n    }\r\n    \r\n    // Clear bound references\r\n    this.boundHandleUpdate = null;\r\n    this.boundHandleMarker = null;\r\n    this.boundHandleCamera = null;\r\n    this.boundHandleResize = null;\r\n    \r\n    // Remove renderer from DOM\r\n    if (this.renderer && this.renderer.domElement && this.renderer.domElement.parentNode) {\r\n      this.renderer.domElement.parentNode.removeChild(this.renderer.domElement);\r\n    }\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Disabled');\r\n  }\r\n\r\n  /**\r\n   * Dispose and cleanup all resources\r\n   */\r\n  dispose() {\r\n    this.disable();\r\n    \r\n    // Clear anchors\r\n    this.anchors.forEach((anchor) => {\r\n      if (anchor.parent) {\r\n        anchor.parent.remove(anchor);\r\n      }\r\n    });\r\n    this.anchors.clear();\r\n    \r\n    // Dispose Three.js resources\r\n    if (this.renderer) {\r\n      this.renderer.dispose();\r\n      this.renderer = null;\r\n    }\r\n    \r\n    if (this.scene) {\r\n      this.scene = null;\r\n    }\r\n    \r\n    if (this.camera) {\r\n      this.camera = null;\r\n    }\r\n    \r\n    this.core = null;\r\n    \r\n    console.log('[ThreeJSRendererPlugin] Disposed');\r\n  }\r\n\r\n  /**\r\n   * Handle engine update event - render the scene\r\n   */\r\n  handleUpdate() {\r\n    if (this.renderer && this.scene && this.camera) {\r\n      this.renderer.render(this.scene, this.camera);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle marker event - create/update marker anchors\r\n   */\r\n  handleMarker(event) {\r\n    const { id, matrix, visible } = event;\r\n    \r\n    let anchor = this.anchors.get(id);\r\n    \r\n    if (!anchor) {\r\n      // Create new anchor (Group) for this marker\r\n      anchor = new THREE.Group();\r\n      anchor.name = `marker-${id}`;\r\n      this.scene.add(anchor);\r\n      this.anchors.set(id, anchor);\r\n    }\r\n    \r\n    // Update visibility\r\n    anchor.visible = visible;\r\n    \r\n    // Update transform matrix if provided\r\n    if (matrix && Array.isArray(matrix)) {\r\n      anchor.matrix.fromArray(matrix);\r\n      anchor.matrix.decompose(anchor.position, anchor.quaternion, anchor.scale);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle camera event - update camera projection\r\n   */\r\n  handleCamera(event) {\r\n    if (event.projectionMatrix && Array.isArray(event.projectionMatrix)) {\r\n      this.setProjectionFromArray(event.projectionMatrix);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle window resize\r\n   */\r\n  handleResize() {\r\n    if (!this.renderer || !this.camera) return;\r\n    \r\n    const width = window.innerWidth;\r\n    const height = window.innerHeight;\r\n    \r\n    this.renderer.setSize(width, height);\r\n    this.camera.aspect = width / height;\r\n    this.camera.updateProjectionMatrix();\r\n  }\r\n\r\n  /**\r\n   * Set camera projection matrix from array (column-major 4x4)\r\n   */\r\n  setProjectionFromArray(array) {\r\n    if (!this.camera || !Array.isArray(array) || array.length !== 16) {\r\n      console.warn('[ThreeJSRendererPlugin] Invalid projection matrix');\r\n      return;\r\n    }\r\n    \r\n    this.camera.projectionMatrix.fromArray(array);\r\n    this.camera.projectionMatrixInverse.copy(this.camera.projectionMatrix).invert();\r\n  }\r\n\r\n  /**\r\n   * Get Three.js scene for adding custom objects\r\n   */\r\n  getScene() {\r\n    return this.scene;\r\n  }\r\n\r\n  /**\r\n   * Get Three.js camera\r\n   */\r\n  getCamera() {\r\n    return this.camera;\r\n  }\r\n\r\n  /**\r\n   * Get Three.js renderer\r\n   */\r\n  getRenderer() {\r\n    return this.renderer;\r\n  }\r\n\r\n  /**\r\n   * Get anchor by marker ID\r\n   */\r\n  getAnchor(markerId) {\r\n    return this.anchors.get(markerId);\r\n  }\r\n}\r\n"],"names":["ThreeJSRendererPlugin","options","core","THREE","container","anchor","event","id","matrix","visible","width","height","array","markerId"],"mappings":"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"}